<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="popMapper">

    <select id="selectPopList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.EMERGENCY_YN, SF_GET_DATE_F(B.INNER_DUE_DT, 'YY', '') AS INNER_DUE_DT,
            A.ORDER_COMP_CD, SF_GET_COMP_NM(A.ORDER_COMP_CD) AS ORDER_COMP_NM,
            A.CONTROL_NUM, B.PART_NUM, B.DRAWING_NUM, B.SIZE_TXT,
            B.MATERIAL_FINISH_GRIND, B.MATERIAL_FINISH_HEAT, B.PART_UNIT_QTY, D.ORDER_QTY,
            D.POP_POSITION, D.POP_PREV_POSITION, SF_GET_DATE_F(POP_DT, 'YYYY','M') AS POP_DT
        FROM TBL_CONTROL A
            INNER JOIN TBL_CONTROL_PART B ON A.CONTROL_SEQ = B.CONTROL_SEQ
            INNER JOIN TBL_CONTROL_BARCODE C ON B.CONTROL_SEQ = C.CONTROL_SEQ AND B.CONTROL_DETAIL_SEQ = C.CONTROL_DETAIL_SEQ
	        INNER JOIN TBL_MATERIAL_ORDER D ON C.CONTROL_SEQ = D.CONTROL_SEQ AND C.CONTROL_DETAIL_SEQ = D.CONTROL_DETAIL_SEQ
            INNER JOIN TBL_POP E ON D.CONTROL_SEQ = E.CONTROL_SEQ AND D.CONTROL_DETAIL_SEQ = E.CONTROL_DETAIL_SEQ
    </select>

    <select id="selectEstimateDetailListExcel" parameterType="java.util.HashMap">
        SELECT COUNT(*) AS CNT
        FROM TBL_POP A
            INNER JOIN TBL_CONTROL_PART B ON A.CONTROL_SEQ = B.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = B.CONTROL_DETAIL_SEQ
            INNER JOIN TBL_CONTROL_BARCODE B ON A.CONTROL_SEQ = B.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = B.CONTROL_DETAIL_SEQ
                AND A.BARCODE_NUM = #{popBarcode}
    </select>

    <update id="updateControlPartStatus" parameterType="java.util.HashMap">
        UPDATE TBL_CONTROL_PART A
            INNER JOIN TBL_CONTROL_BARCODE B ON A.CONTROL_SEQ = B.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = B.CONTROL_DETAIL_SEQ
                AND A.BARCODE_NUM = #{popBarcode}
        SET A.PART_STATUS = '',
            STATUS_DT = NOW
        WHERE 1=1
    </update>

    <insert id="insertPopBarcode" parameterType="java.util.HashMap">
        INSERT INTO TBL_POP
            (POP_SEQ, POP_POSITION, POP_PREV_POSITION, POP_DT, CONTROL_SEQ, CONTROL_DETAIL_SEQ, INSERT_ID)
        SELECT
            NEXTVAL(SEQ_POP), '', B.POP_POSITION, NOW(), A.CONTROL_SEQ, A.CONTROL_DETAIL_SEQ, NULL
        FROM TBL_CONTROL_PART A
            INNER JOIN TBL_CONTROL_BARCODE B ON A.CONTROL_SEQ = B.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = B.CONTROL_DETAIL_SEQ
                AND A.BARCODE_NUM = #{popBarcode}
            LEFT OUTER JOIN TBL_POP C ON B.CONTROL_SEQ = C.CONTROL_SEQ AND B.CONTROL_DETAIL_SEQ = C.CONTROL_DETAIL_SEQ
        WHERE 1=1
    </insert>

</mapper>