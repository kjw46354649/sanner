<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="popMapper">

    <select id="selectPopList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            ROW_NUMBER () OVER (ORDER BY C.POP_DT) AS ROWNUM,
            A.CONTROL_SEQ, A.CONTROL_DETAIL_SEQ,
            CASE WHEN B.EMERGENCY_YN = 'Y' THEN '긴급' END AS EMERGENCY_YN, -- 긴급 -->
            jmes.SF_GET_DATE_F(A.INNER_DUE_DT, '', '') AS INNER_DUE_DT, -- 내부가공납기 -->
            B.CONTROL_NUM, -- 관리번호 -->
            SF_GET_COMP_NM(B.ORDER_COMP_CD) AS ORDER_COMP_NM, -- 발주업체 이름 -->
            IFNULL(A.PART_NUM, SPACE(0)) AS PART_NUM, -- Part -->
            A.DRAWING_NUM, -- 도면 -->
            A.IMG_GFILE_SEQ,
            IFNULL(A.SIZE_TXT, SPACE(0)) AS SIZE_TXT, -- 규격 -->
            SF_GET_CODE_NM(1030, A.SURFACE_TREAT, 'KR') AS SURFACE_TREAT, -- 표면 처리 -->
            jmes.SF_GET_CONTROL_PART_QTY(A.CONTROL_SEQ, A.CONTROL_DETAIL_SEQ) AS ORDER_QTY, -- 수량 -->
            SF_GET_CODE_NM(1009, C.POP_POSITION, 'KR') AS POP_POSITION, -- 현재위치 -->
            SF_GET_CODE_NM(1009, C.POP_PREV_POSITION, 'KR') AS POP_PREV_POSITION, -- 현재위치 -->
            jmes.SF_GET_DATE_F(C.POP_DT, 'YY', 'M') AS POP_DT -- 외치 일시 -->
        FROM jmes.TBL_CONTROL_PART A
             INNER JOIN jmes.TBL_CONTROL B ON A.CONTROL_SEQ = B.CONTROL_SEQ AND B.CONTROL_STATUS = 'ORD001' <!-- 주문확정 -->
             INNER JOIN jmes.TBL_POP C ON A.CONTROL_SEQ = C.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = C.CONTROL_DETAIL_SEQ
                AND C.POP_POSITION = #{popLocation}
                AND C.POP_SEQ = (SELECT MAX(K.POP_SEQ) FROM jmes.TBL_POP K WHERE K.CONTROL_SEQ = C.CONTROL_SEQ
                        AND K.CONTROL_DETAIL_SEQ = C.CONTROL_DETAIL_SEQ GROUP BY K.CONTROL_SEQ, K.CONTROL_DETAIL_SEQ
                )
        WHERE 1 = 1
        ORDER BY C.POP_DT
    </select>

    <select id="selectPopPartStatus" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
		       A.PART_STATUS, CASE WHEN C.POP_SEQ IS NULL THEN 'N' ELSE 'Y' END RECEIVE_YN
        FROM TBL_CONTROL_PART A
            INNER JOIN TBL_CONTROL_BARCODE B ON A.CONTROL_SEQ = B.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = B.CONTROL_DETAIL_SEQ
				AND B.BARCODE_NUM = #{popBarcode}
			LEFT OUTER JOIN TBL_POP C ON B.CONTROL_SEQ = C.CONTROL_SEQ AND B.CONTROL_DETAIL_SEQ = C.CONTROL_DETAIL_SEQ
		WHERE 1=1
    </select>

    <select id="selectInsertPopPartStatus" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.CONTROL_SEQ, A.CONTROL_DETAIL_SEQ,
            CONCAT(H.CONTROL_NUM, CASE WHEN A.PART_NUM IS NOT NULL THEN CONCAT(' #', A.PART_NUM) ELSE SPACE(0) END) AS CONTROL_NUM_NM,
            IFNULL(C.POP_POSITION, SPACE(0)) AS POP_PREV_POSITION, <!-- 이전 POP SEQ -->
            IFNULL(SF_GET_CODE_NM(1009, IFNULL(C.POP_POSITION, SPACE(0)), 'KR'), SPACE(0)) AS POP_POSITION_NM, <!-- 현재 등록된 위치 -->
            CONCAT(SF_GET_CODE_NM(1009, #{popLocation}, 'KR'), ' (', jmes.SF_GET_DATE_F(NOW(), '', 'M'), ')') AS CHECK_POSITION_NM, <!-- BARCODE 스캔 등록된 위치 -->
            IFNULL(CASE WHEN D.SEQ IS NOT NULL AND G.SEQ IS NULL THEN 'PRO005' ELSE '' END, SPACE(0)) CREATE_PRO_005, <!-- 소재 입고 상태 추가 -->
            IFNULL(CASE WHEN A.WORK_TYPE = 'WTP020' AND C.POP_SEQ IS NULL THEN 'PRO018' ELSE '' END, SPACE(0)) CREATE_PRO_018,	<!-- 모도면 조립 전환 상태 추가 -->
            IFNULL(CASE WHEN F.SEQ IS NOT NULL AND I.SEQ IS NULL THEN 'PRO019' ELSE '' END, SPACE(0)) CREATE_PRO_019	<!-- 외주 가공 후 외주 입고 처리 -->
        FROM TBL_CONTROL_PART A
            INNER JOIN TBL_CONTROL H ON A.CONTROL_SEQ = H.CONTROL_SEQ
            INNER JOIN TBL_CONTROL_BARCODE B ON A.CONTROL_SEQ = B.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = B.CONTROL_DETAIL_SEQ AND B.DEL_YN = 'N'
                    AND B.BARCODE_NUM = #{popBarcode}
            LEFT OUTER JOIN TBL_POP C ON B.CONTROL_SEQ = C.CONTROL_SEQ AND B.CONTROL_DETAIL_SEQ = C.CONTROL_DETAIL_SEQ
                AND C.POP_SEQ = (SELECT MAX(E.POP_SEQ) FROM TBL_POP E WHERE C.CONTROL_SEQ = E.CONTROL_SEQ AND C.CONTROL_DETAIL_SEQ = E.CONTROL_DETAIL_SEQ) <!-- 현재 POP -->
            LEFT OUTER JOIN TBL_CONTROL_PART_PROGRESS D ON A.CONTROL_SEQ = D.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = D.CONTROL_DETAIL_SEQ AND D.PART_STATUS = 'PRO004' <!-- 소재 주문 -->
            LEFT OUTER JOIN TBL_CONTROL_PART_PROGRESS G ON A.CONTROL_SEQ = G.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = G.CONTROL_DETAIL_SEQ AND G.PART_STATUS = 'PRO005' <!-- 소재 입고 -->
            LEFT OUTER JOIN TBL_CONTROL_PART_PROGRESS E ON A.CONTROL_SEQ = E.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = E.CONTROL_DETAIL_SEQ AND E.PART_STATUS = 'PRO001' <!-- 모도면 조립전환 -->
            LEFT OUTER JOIN TBL_CONTROL_PART_PROGRESS F ON A.CONTROL_SEQ = F.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = F.CONTROL_DETAIL_SEQ AND F.PART_STATUS = 'PRO001' <!-- 외주 가공 요청 -->
            LEFT OUTER JOIN TBL_CONTROL_PART_PROGRESS I ON A.CONTROL_SEQ = I.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = I.CONTROL_DETAIL_SEQ AND I.PART_STATUS = 'PRO019' <!-- 외주 가공 입고 처리 -->
        WHERE 1=1
    </select>

    <update id="insertControlPartProgressStatus" parameterType="java.util.HashMap">
        INSERT INTO TBL_CONTROL_PART_PROGRESS
            (CONTROL_SEQ, CONTROL_DETAIL_SEQ, SEQ, PART_STATUS, STATUS_DT, INSERT_ID)
        SELECT
            CONTROL_SEQ, CONTROL_DETAIL_SEQ, NEXTVAL(SEQ_CONTROL_PART_PROGRESS), #{PART_STATUS}, NOW(), #{LOGIN_USER_ID}
        FROM TBL_CONTROL_PART
        WHERE 1 = 1
            AND CONTROL_SEQ = #{CONTROL_SEQ}
            AND CONTROL_DETAIL_SEQ = #{CONTROL_DETAIL_SEQ}
    </update>

    <update id="updateControlPartProgressMappingStatus" parameterType="java.util.HashMap">
        UPDATE TBL_CONTROL_PART A
            INNER JOIN TBL_CONTROL_PART_PROGRESS B ON A.CONTROL_SEQ = B.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = B.CONTROL_DETAIL_SEQ
                AND B.SEQ = (SELECT MAX(SEQ) FROM TBL_CONTROL_PART_PROGRESS E WHERE A.CONTROL_SEQ = E.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = E.CONTROL_DETAIL_SEQ)
        SET A.PART_STATUS = #{PART_STATUS},
            A.STATUS_DT = NOW(),
            A.UPDATE_DT = NOW(),
            A.UPDATE_ID = #{LOGIN_USER_ID}
        WHERE 1=1
            AND A.CONTROL_SEQ = #{CONTROL_SEQ}
            AND A.CONTROL_DETAIL_SEQ = #{CONTROL_DETAIL_SEQ}
    </update>

    <update id="updateControlPartOutsideInDate" parameterType="java.util.HashMap">
        UPDATE TBL_CONTROL_PART A
        SET
            A.OUTSIDE_STATUS = 'OST003',
            A.OUTSIDE_STATUS_DT = NOW(),
            A.OUTSIDE_IN_DT = NOW(),
            A.UPDATE_DT = NOW(),
            A.UPDATE_ID = #{LOGIN_USER_ID}
        WHERE 1=1
            AND A.CONTROL_SEQ = #{CONTROL_SEQ}
            AND A.CONTROL_DETAIL_SEQ = #{CONTROL_DETAIL_SEQ}
    </update>

    <update id="updatePopControlPartStatus" parameterType="java.util.HashMap">
        UPDATE TBL_CONTROL_PART A
            INNER JOIN TBL_CONTROL_BARCODE B ON A.CONTROL_SEQ = B.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = B.CONTROL_DETAIL_SEQ
                AND B.BARCODE_NUM = #{popBarcode}
        SET A.PART_STATUS = #{PART_STATUS},
            A.STATUS_DT = NOW(),
            A.UPDATE_DT = NOW(),
            A.UPDATE_ID = #{LOGIN_USER_ID}
        WHERE 1=1
    </update>

    <update id="updatePopMaterialOrderStatus" parameterType="java.util.HashMap">
        UPDATE TBL_MATERIAL_ORDER A
        SET A.ORDER_STATUS = 'MST004',
            A.UPDATE_DT = NOW(),
            A.UPDATE_ID = #{LOGIN_USER_ID}
        WHERE 1=1
            AND A.CONTROL_SEQ = #{CONTROL_SEQ}
            AND A.CONTROL_DETAIL_SEQ = #{CONTROL_DETAIL_SEQ}
    </update>

    <insert id="insertPopBarcode" parameterType="java.util.HashMap">
        INSERT INTO TBL_POP
            (POP_SEQ, POP_POSITION, POP_PREV_POSITION, POP_DT, CONTROL_SEQ, CONTROL_DETAIL_SEQ, INSERT_ID)
        SELECT
            NEXTVAL(SEQ_POP), #{POP_POSITION}, #{POP_PREV_POSITION}, NOW(), A.CONTROL_SEQ, A.CONTROL_DETAIL_SEQ, #{LOGIN_USER_ID}
        FROM TBL_CONTROL_PART A
        WHERE 1=1
            AND CONTROL_SEQ = #{CONTROL_SEQ}
            AND CONTROL_DETAIL_SEQ = #{CONTROL_DETAIL_SEQ}
    </insert>

    <select id="selectBarcodeInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            CONTROL_SEQ,
            CONTROL_DETAIL_SEQ,
            CONTROL_VER
        FROM TBL_CONTROL_BARCODE
        WHERE 1 = 1
            AND BARCODE_NUM = #{popBarcode}
            AND DEL_YN = 'N'
    </select>

</mapper>