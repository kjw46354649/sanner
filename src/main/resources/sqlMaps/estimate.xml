<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="estimate">
    <select id="selectEstimateNextSequence" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT NEXTVAL(SEQ_ESTIMATE) AS EST_SEQ FROM DUAL
    </select>

    <select id="selectEstimateMasterList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.EST_SEQ, A.EST_NUM, A.EST_VER, A.EST_TITLE,
            A.EST_STATUS, SF_GET_CODE_NM(1048, A.EST_STATUS, 'EN') AS EST_STATUS_NM,
            A.ORDER_COMP_CD, C.COMP_NM AS ORDER_COMP_NM,
            A.ORDER_STAFF_SEQ, A.COMP_CD, D.COMP_NM AS COMP_NM,
            COUNT(B.SEQ) AS DTL_CNT, SUM(B.FINAL_EST_UNIT_PRICE) AS DTL_AMOUNT,
            A.INSERT_DT, A.EST_USER_ID, A.SEND_DT
        FROM TBL_ESTIMATE A
            LEFT OUTER JOIN TBL_ESTIMATE_DETAIL B ON A.EST_SEQ = B.EST_SEQ
            LEFT OUTER JOIN TBL_COMPANY C ON A.ORDER_COMP_CD = C.COMP_CD
            LEFT OUTER JOIN TBL_COMPANY D ON A.COMP_CD = D.COMP_CD
        GROUP BY A.EST_SEQ
        ORDER BY A.EST_SEQ, A.EST_NUM
    </select>

    <select id="selectEstimateDetailList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
			EST_SEQ, MODULE_NM, ITEM_NM, DRAWING_NUM, PART_NUM, SIZE_W, SIZE_H, SIZE_T, SIZE_D, SIZE_L, ITEM_QTY,
            WORK_TYPE, MATERIAL_TYPE, MATERIAL_DETAIL, SURFACE_TREAT, MATERIAL_SUPPLY_YN, HEAT_TREAT_YN,
            MATERIAL_UNIT_COST, TOUCH_UNIT_COST, SURFACE_UNIT_COST, PROCESS_UNIT_COST, ETC_UNIT_COST, FINAL_EST_UNIT_PRICE,
            NOTE, DWG_GFILE_SEQ, DXF_GFILE_SEQ, PDF_GFILE_SEQ, IMG_GFILE_SEQ
        FROM TBL_ESTIMATE_DETAIL
        WHERE 1=1
			AND EST_SEQ = #{EST_SEQ}
    </select>

    <select id="selectEstimateMasterListPop" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.EST_SEQ, A.EST_NUM, A.EST_VER, A.EST_TITLE,
            A.EST_STATUS, SF_GET_CODE_NM(1048, A.EST_STATUS, 'EN') AS EST_STATUS_NM,
            A.ORDER_COMP_CD, C.COMP_NM AS ORDER_COMP_NM,
            A.ORDER_STAFF_SEQ, E.STAFF_NM AS ORDER_STAFF_NM, A.COMP_CD, D.COMP_NM AS COMP_NM,
            COUNT(B.SEQ) AS DTL_CNT, SUM(B.FINAL_EST_UNIT_PRICE) AS DTL_AMOUNT,
            DATE_FORMAT(A.INSERT_DT, '%Y-%m-%d %T') INSERT_DT, A.EST_USER_ID, A.SEND_DT
        FROM TBL_ESTIMATE A
            LEFT OUTER JOIN TBL_ESTIMATE_DETAIL B ON A.EST_SEQ = B.EST_SEQ
            LEFT OUTER JOIN TBL_COMPANY C ON A.ORDER_COMP_CD = C.COMP_CD
            LEFT OUTER JOIN TBL_COMPANY D ON A.COMP_CD = D.COMP_CD
            LEFT OUTER JOIN TBL_COMPANY_STAFF E ON A.ORDER_STAFF_SEQ = E.STAFF_SEQ AND E.DEL_YN = 'N'
        WHERE A.EST_SEQ = #{EST_SEQ}
        GROUP BY A.EST_SEQ
        ORDER BY A.EST_SEQ, A.EST_NUM
    </select>

    <insert id="insertEstimateMaster" parameterType="java.util.HashMap">
        INSERT INTO TBL_ESTIMATE
            (EST_SEQ, EST_VER, EST_NUM, ORDER_COMP_CD, ORDER_STAFF_SEQ, COMP_CD, EST_USER_ID,
            EST_TITLE, EST_STATUS, DEL_YN, INSERT_DT, INSERT_ID)
        SELECT
            #{EST_SEQ} AS EST_SEQ, EST_VER, EST_NUM,
            #{ORDER_COMP_CD} AS ORDER_COMP_CD, #{ORDER_STAFF_SEQ} AS ORDER_STAFF_SEQ, #{COMP_CD} AS COMP_CD, #{EST_USER_ID} AS EST_USER_ID,
            #{EST_TITLE} AS EST_TITLE, 'EST010' AS EST_STATUS, 'N' AS DEL_YN, NOW() AS INSERT_DT, NULL AS INSERT_ID
        FROM (
            SELECT
                0 AS EST_VER,
                CONCAT('EST-', DATE_FORMAT(NOW(), '%Y%m%d'), LPAD(CAST(COUNT(*)+1 AS CHAR), 3, '0')) EST_NUM
            FROM TBL_ESTIMATE
            WHERE DATE_FORMAT(INSERT_DT, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
        ) Z
        ON DUPLICATE KEY UPDATE
            ORDER_COMP_CD = #{ORDER_COMP_CD},
            ORDER_STAFF_SEQ = #{ORDER_STAFF_SEQ},
            COMP_CD = #{COMP_CD},
            EST_USER_ID = #{EST_USER_ID},
            EST_TITLE = #{EST_TITLE},
            UPDATE_DT = NOW(),
            UPDATE_ID = NULL
    </insert>

    <insert id="insertEstimateDetail" parameterType="java.util.HashMap">
        INSERT INTO jmes.TBL_ESTIMATE_DETAIL
            (EST_SEQ, SEQ, MODULE_NM, ITEM_NM, DRAWING_NUM, PART_NUM, SIZE_W, SIZE_H, SIZE_T, SIZE_D, SIZE_L,
            ITEM_QTY, WORK_TYPE, MATERIAL_TYPE, MATERIAL_KIND, MATERIAL_DETAIL, SURFACE_TREAT, MATERIAL_SUPPLY_YN, HEAT_TREAT_YN,
            DETAIL_LATHE, DETAIL_SURFACE, DETAIL_CLAMPING, DETAIL_POCKET, DETAIL_DRILL, DETAIL_DIFFICULTY,
            MATERIAL_UNIT_COST, TOUCH_UNIT_COST, SURFACE_UNIT_COST, PROCESS_UNIT_COST, ETC_UNIT_COST, FINAL_EST_UNIT_PRICE,
            NOTE, DWG_GFILE_SEQ, DXF_GFILE_SEQ, PDF_GFILE_SEQ, IMG_GFILE_SEQ, INSERT_DT, INSERT_ID)
        VALUES
        (
            #{EST_SEQ}, NEXTVAL(SEQ_ESTIMATE_DETAIL), #{MODULE_NM}, #{ITEM_NM}, #{DRAWING_NUM}, #{PART_NUM}, #{SIZE_W}, #{SIZE_H}, #{SIZE_T}, #{SIZE_D}, #{SIZE_L},
            #{ITEM_QTY}, #{WORK_TYPE}, #{MATERIAL_TYPE}, #{MATERIAL_KIND}, #{MATERIAL_DETAIL}, #{SURFACE_TREAT}, #{MATERIAL_SUPPLY_YN},#{HEAT_TREAT_YN},
            #{DETAIL_LATHE}, #{DETAIL_SURFACE}, #{DETAIL_CLAMPING}, #{DETAIL_POCKET}, #{DETAIL_DRILL},#{DETAIL_DIFFICULTY},
            #{MATERIAL_UNIT_COST}, #{TOUCH_UNIT_COST}, #{SURFACE_UNIT_COST}, #{PROCESS_UNIT_COST}, #{ETC_UNIT_COST},#{FINAL_EST_UNIT_PRICE},
            #{NOTE}, #{DWG_GFILE_SEQ}, #{DXF_GFILE_SEQ}, #{PDF_GFILE_SEQ}, #{IMG_GFILE_SEQ}, NOW(), NULL
        )
    </insert>

    <insert id="insertEstimateReceiver" parameterType="java.util.HashMap">
        INSERT INTO TBL_ESTIMATE_RECEIVER(EST_SEQ, SEQ, RECEIVER_NM, RECEIVER_EMAIL, RECEIVER_TEL)
        VALUES(#{EST_SEQ}, NEXTVAL(SEQ_ESTIMATE_RECEIVER), #{STAFF_NM}, #{STAFF_EMAIL}, #{STAFF_TEL})
    </insert>

    <update id="updateEstimateMaster"  parameterType="java.util.HashMap">
        UPDATE TBL_ESTIMATE
        SET
            EST_NUM = #{EST_NUM},
            ORDER_COMP_CD = #{ORDER_COMP_CD},
            ORDER_STAFF_SEQ = #{ORDER_STAFF_SEQ},
            COMP_CD = #{COMP_CD},
            EST_USER_ID = #{EST_USER_ID},
            EST_TITLE = #{EST_TITLE},
            EST_STATUS = #{EST_STATUS},
            DEL_YN = #{DEL_YN},
            UPDATE_DT = NOW(),
            UPDATE_ID = NULL
        WHERE EST_SEQ = #{EST_SEQ}
            AND EST_VER = #{EST_VER}
    </update>

    <update id="updateEstimateDetail"  parameterType="java.util.HashMap">
        UPDATE jmes.TBL_ESTIMATE_DETAIL
        SET
            MODULE_NM = #{MODULE_NM},
            ITEM_NM = #{ITEM_NM},
            DRAWING_NUM #{DRAWING_NUM},
            PART_NUM = #{PART_NUM},
            SIZE_W = #{SIZE_W},
            SIZE_H = #{SIZE_H},
            SIZE_T = #{SIZE_T},
            SIZE_D = #{SIZE_D},
            SIZE_L = #{SIZE_L},
            ITEM_QTY = #{ITEM_QTY},
            WORK_TYPE = #{WORK_TYPE},
            MATERIAL_TYPE = #{MATERIAL_TYPE},
            MATERIAL_KIND = #{MATERIAL_KIND},
            MATERIAL_DETAIL = #{MATERIAL_DETAIL},
            SURFACE_TREAT = #{SURFACE_TREAT},
            MATERIAL_SUPPLY_YN = #{MATERIAL_SUPPLY_YN},
            HEAT_TREAT_YN = #{HEAT_TREAT_YN},
            DETAIL_LATHE = #{DETAIL_LATHE},
            DETAIL_SURFACE = #{DETAIL_SURFACE},
            DETAIL_CLAMPING = #{DETAIL_CLAMPING},
            DETAIL_POCKET = #{DETAIL_POCKET},
            DETAIL_DRILL = #{DETAIL_DRILL},
            DETAIL_DIFFICULTY = #{DETAIL_DIFFICULTY},
            MATERIAL_UNIT_COST = #{MATERIAL_UNIT_COST},
            TOUCH_UNIT_COST = #{TOUCH_UNIT_COST},
            SURFACE_UNIT_COST = #{SURFACE_UNIT_COST},
            PROCESS_UNIT_COST = #{PROCESS_UNIT_COST},
            ETC_UNIT_COST = #{ETC_UNIT_COST} ,
            FINAL_EST_UNIT_PRICE = #{FINAL_EST_UNIT_PRICE},
            NOTE = #{NOTE} ,
            DWG_GFILE_SEQ = #{DWG_GFILE_SEQ},
            DXF_GFILE_SEQ = #{DXF_GFILE_SEQ},
            PDF_GFILE_SEQ = #{PDF_GFILE_SEQ},
            IMG_GFILE_SEQ = #{IMG_GFILE_SEQ},
            UPDATE_ID = NULL,
            UPDATE_DT = NOW(),
        WHERE EST_SEQ = #{EST_SEQ}
            AND SEQ = #{SEQ}
    </update>

    <delete id="deleteEstimateMaster"  parameterType="java.util.HashMap">
        DELETE FROM TBL_ESTIMATE
        WHERE EST_SEQ = #{EST_SEQ}
            AND EST_VER = #{EST_VER}
    </delete>

    <delete id="deleteEstimateDetail"  parameterType="java.util.HashMap">
        DELETE FROM TBL_ESTIMATE_DETAIL
        WHERE EST_SEQ = #{EST_SEQ}
    </delete>

    <insert id="insertEstimateMasterVersion"  parameterType="java.util.HashMap">
        INSERT INTO TBL_ESTIMATE
            (EST_SEQ, EST_VER, EST_NUM, ORDER_COMP_CD, ORDER_STAFF_SEQ, COMP_CD, EST_USER_ID,
            EST_TITLE, EST_STATUS, DEL_YN, INSERT_DT, INSERT_ID)
        SELECT
            NEXTVAL(SEQ_ESTIMATE), (EST_VER+1), EST_NUM, ORDER_COMP_CD, ORDER_STAFF_SEQ, COMP_CD, EST_USER_ID,
            EST_TITLE, 'EST010', DEL_YN, NOW(), INSERT_ID
        FROM TBL_ESTIMATE
        WHERE EST_SEQ = #{EST_SEQ}
    </insert>

    <insert id="insertEstimateDetailVersion"  parameterType="java.util.HashMap">
        INSERT INTO TBL_ESTIMATE_DETAIL
            (EST_SEQ, SEQ, MODULE_NM, ITEM_NM, DRAWING_NUM, PART_NUM, SIZE_W, SIZE_H, SIZE_T, SIZE_D, SIZE_L,
            ITEM_QTY, WORK_TYPE, MATERIAL_TYPE, MATERIAL_KIND, MATERIAL_DETAIL, SURFACE_TREAT, MATERIAL_SUPPLY_YN, HEAT_TREAT_YN,
            DETAIL_LATHE, DETAIL_SURFACE, DETAIL_CLAMPING, DETAIL_POCKET, DETAIL_DRILL, DETAIL_DIFFICULTY,
            MATERIAL_UNIT_COST, TOUCH_UNIT_COST, SURFACE_UNIT_COST, PROCESS_UNIT_COST, ETC_UNIT_COST, FINAL_EST_UNIT_PRICE,
            NOTE, DWG_GFILE_SEQ, DXF_GFILE_SEQ, PDF_GFILE_SEQ, IMG_GFILE_SEQ, INSERT_DT, INSERT_ID)
        SELECT
            LASTVAL(SEQ_ESTIMATE), NEXTVAL(SEQ_ESTIMATE_DETAIL), MODULE_NM, ITEM_NM, DRAWING_NUM, PART_NUM, SIZE_W, SIZE_H, SIZE_T, SIZE_D, SIZE_L,
            ITEM_QTY, WORK_TYPE, MATERIAL_TYPE, MATERIAL_KIND, MATERIAL_DETAIL, SURFACE_TREAT, MATERIAL_SUPPLY_YN, HEAT_TREAT_YN,
            DETAIL_LATHE, DETAIL_SURFACE, DETAIL_CLAMPING, DETAIL_POCKET, DETAIL_DRILL, DETAIL_DIFFICULTY,
            MATERIAL_UNIT_COST, TOUCH_UNIT_COST, SURFACE_UNIT_COST, PROCESS_UNIT_COST, ETC_UNIT_COST, FINAL_EST_UNIT_PRICE,
            NOTE, DWG_GFILE_SEQ, DXF_GFILE_SEQ, PDF_GFILE_SEQ, IMG_GFILE_SEQ, NOW(), INSERT_ID
        FROM TBL_ESTIMATE_DETAIL
        WHERE EST_SEQ = #{EST_SEQ}
    </insert>

    <select id="selectLastValEstimateMasterInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.EST_SEQ, A.EST_NUM, A.EST_VER, A.EST_TITLE,
            A.EST_STATUS, SF_GET_CODE_NM(1048, A.EST_STATUS, 'EN') AS EST_STATUS_NM,
            A.ORDER_COMP_CD, SF_GET_CODE_NM(1042, A.ORDER_COMP_CD, 'EN') AS ORDER_COMP_NM,
            A.ORDER_STAFF_SEQ, A.COMP_CD, SF_GET_CODE_NM(1007, A.COMP_CD, 'EN') AS COMP_NM,
            COUNT(B.SEQ) AS DTL_CNT, SUM(B.FINAL_EST_UNIT_PRICE) AS DTL_AMOUNT,
            DATE_FORMAT(A.INSERT_DT, '%Y-%m-%d %T') INSERT_DT, A.EST_USER_ID, A.SEND_DT
        FROM TBL_ESTIMATE A
			INNER JOIN TBL_ESTIMATE_DETAIL B ON A.EST_SEQ = B.EST_SEQ
        ORDER BY EST_SEQ
        LIMIT 1
    </select>

    <select id="selectLastValEstimateDetailList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
			EST_SEQ, SEQ, MODULE_NM, ITEM_NM, DRAWING_NUM, PART_NUM, SIZE_W, SIZE_H, SIZE_T, SIZE_D, SIZE_L, ITEM_QTY,
            WORK_TYPE, MATERIAL_TYPE, MATERIAL_DETAIL, SURFACE_TREAT, MATERIAL_SUPPLY_YN, HEAT_TREAT_YN,
            MATERIAL_UNIT_COST, TOUCH_UNIT_COST, SURFACE_UNIT_COST, PROCESS_UNIT_COST, ETC_UNIT_COST, FINAL_EST_UNIT_PRICE,
            NOTE, DWG_GFILE_SEQ, DXF_GFILE_SEQ, PDF_GFILE_SEQ, IMG_GFILE_SEQ
        FROM TBL_ESTIMATE_DETAIL
        WHERE 1=1
			AND EST_SEQ = #{EST_SEQ}
    </select>

    <select id="selectCompanyStaffEmailList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            B.STAFF_SEQ, A.COMP_CD, B.STAFF_NM, B.STAFF_TEL, B.STAFF_EMAIL
        FROM TBL_COMPANY A
            INNER JOIN TBL_COMPANY_STAFF B ON A. COMP_CD = B.COMP_CD
                AND B.DEL_YN = 'N'
        WHERE 1 = 1
            AND A.DEL_YN = 'N'
            AND A.COMP_CD = #{COMP_CD}
    </select>
</mapper>