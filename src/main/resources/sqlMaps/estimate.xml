<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="estimate">
    <select id="selectEstimateNextSequence" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT NEXTVAL(SEQ_ESTIMATE) AS EST_SEQ FROM DUAL
    </select>

    <select id="selectEstimateStaffEmailList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            B.STAFF_SEQ, A.COMP_CD, B.STAFF_NM AS RECEIVER_NM, B.STAFF_EMAIL AS RECEIVER_EMAIL, B.STAFF_TEL AS RECEIVER_TEL
        FROM TBL_COMPANY A
            INNER JOIN TBL_COMPANY_STAFF B ON A. COMP_CD = B.COMP_CD
                AND B.DEL_YN = 'N'
        WHERE 1 = 1
            AND A.DEL_YN = 'N'
            AND A.COMP_CD = #{COMP_CD}
    </select>

    <select id="selectEstimateMasterList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.EST_SEQ, A.EST_VER, A.EST_NUM, A.EST_TITLE, A.EST_STATUS, SF_GET_CODE_NM(1045, A.EST_STATUS, 'EN') AS EST_STATUS_NM,
            A.ORDER_COMP_CD, SF_GET_COMP_NM(A.ORDER_COMP_CD) AS ORDER_COMP_NM,
            A.COMP_CD, SF_GET_COMP_NM(A.COMP_CD) AS COMP_NM,
            A.ORDER_STAFF_SEQ,SF_GET_STAFF_NM(A.ORDER_STAFF_SEQ) AS ORDER_STAFF_NM,
            A.ETC_GFILE_SEQ, A.DEL_YN, A.INSERT_ID, A.UPDATE_DT, A.UPDATE_ID,
            COUNT(B.SEQ) AS DTL_CNT, A.EST_USER_ID, SF_GET_USER_NM(A.EST_USER_ID) AS EST_USER,
            SUM(CASE WHEN B.UNIT_FINAL_EST_AMT IS NOT NULL THEN IFNULL(B.UNIT_FINAL_EST_AMT, 0) * IFNULL(B.ITEM_QTY, 0)
            ELSE ((IFNULL(B.UNIT_MATERIAL_AMT, 0) + IFNULL(B.UNIT_TM_AMT, 0) + IFNULL(B.UNIT_GRIND_AMT, 0) + IFNULL(B.UNIT_HEAT_AMT, 0) +
            IFNULL(B.UNIT_SURFACE_AMT, 0) + IFNULL(B.UNIT_PROCESS_AMT, 0) + IFNULL(B.UNIT_ETC_AMT, 0)) * IFNULL(B.ITEM_QTY, 0))
            END) AS DTL_AMOUNT,
            SF_GET_DATE_F(A.INSERT_DT,'YY','') AS INSERT_DT,
            CASE WHEN (SELECT COUNT(*) FROM TBL_CONTROL WHERE EST_SEQ = A.EST_SEQ AND DEL_YN ='N') > 0 THEN 'Y' ELSE 'N' END CONTROL_YN,
            A.EMAIL_TITLE,
            CASE WHEN A.EMAIL_CONTENT IS NOT NULL THEN A.EMAIL_CONTENT
            ELSE (SELECT TEMPLATE_CONTENT FROM TBL_MAIL_TEMPLATE WHERE TEMPLATE_SEQ = 0)
            END EMAIL_CONTENT,
            SF_GET_DATE_F(A.SEND_DT,'YY','') AS SEND_DT,
            CASE WHEN D.SEND_DT IS NOT NULL THEN SF_GET_DATE_F(D.SEND_DT,'YY','') END AS MAIL_SEND_DT,
            CASE WHEN A.MAIL_BOX_SEQ IS NOT NULL THEN 'Y' ELSE 'N' END MAIL_SEND_YN,
            A.ETC_GFILE_SEQ
        FROM TBL_ESTIMATE A
            LEFT OUTER JOIN TBL_ESTIMATE_DETAIL B ON A.EST_SEQ = B.EST_SEQ
            LEFT OUTER JOIN TBL_MAIL_BOX D ON A.MAIL_BOX_SEQ = D.MAIL_BOX_SEQ
        WHERE 1=1
            <if test="COMP_CD !='' and COMP_CD !=null">
                AND A.COMP_CD = #{COMP_CD}
            </if>
            <if test="ORDER_COMP_CD !='' and ORDER_COMP_CD !=null">
                AND A.ORDER_COMP_CD = #{ORDER_COMP_CD}
            </if>
            <if test="EST_TITLE !='' and EST_TITLE !=null">
                AND A.EST_TITLE = #{EST_TITLE}
            </if>
            <if test="DRAWING_NUM !='' and DRAWING_NUM !=null">
                AND A.DRAWING_NUM = #{DRAWING_NUM}
            </if>
            <if test="EST_NUM !='' and EST_NUM !=null">
                AND A.EST_NUM = #{EST_NUM}
            </if>
            <if test="ITEM_NM !='' and ITEM_NM !=ITEM_NM">
                AND B.ITEM_NM = #{ITEM_NM}
            </if>
        GROUP BY A.EST_SEQ
        ORDER BY A.EST_NUM, A.EST_SEQ, A.EST_VER
    </select>

    <select id="selectEstimateRegisterMaster" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.EST_SEQ, A.EST_VER, A.EST_NUM, A.EST_TITLE, A.EST_STATUS, SF_GET_CODE_NM(1045, A.EST_STATUS, 'EN') AS EST_STATUS_NM,
            A.ORDER_COMP_CD, SF_GET_COMP_NM(A.ORDER_COMP_CD) AS ORDER_COMP_NM,
            A.COMP_CD, SF_GET_COMP_NM(A.COMP_CD) AS COMP_NM,
            A.ORDER_STAFF_SEQ,SF_GET_STAFF_NM(A.ORDER_STAFF_SEQ) AS ORDER_STAFF_NM,
            A.ETC_GFILE_SEQ, A.DEL_YN, A.INSERT_ID, A.UPDATE_DT, A.UPDATE_ID,
            COUNT(B.SEQ) AS DTL_CNT, A.EST_USER_ID, SF_GET_USER_NM(A.EST_USER_ID) AS EST_USER,
            SUM(CASE WHEN B.UNIT_FINAL_EST_AMT IS NOT NULL THEN IFNULL(B.UNIT_FINAL_EST_AMT, 0) * IFNULL(B.ITEM_QTY, 0)
            ELSE ((IFNULL(B.UNIT_MATERIAL_AMT, 0) + IFNULL(B.UNIT_TM_AMT, 0) + IFNULL(B.UNIT_GRIND_AMT, 0) + IFNULL(B.UNIT_HEAT_AMT, 0) +
            IFNULL(B.UNIT_SURFACE_AMT, 0) + IFNULL(B.UNIT_PROCESS_AMT, 0) + IFNULL(B.UNIT_ETC_AMT, 0)) * IFNULL(B.ITEM_QTY, 0))
            END) AS DTL_AMOUNT,
            SF_GET_DATE_F(A.INSERT_DT,'YY','') AS INSERT_DT,
            CASE WHEN (SELECT COUNT(*) FROM TBL_CONTROL WHERE EST_SEQ = A.EST_SEQ AND DEL_YN ='N') > 0 THEN 'Y' ELSE 'N' END CONTROL_YN,
            A.EMAIL_TITLE,
            CASE WHEN A.EMAIL_CONTENT IS NOT NULL THEN A.EMAIL_CONTENT
            ELSE (SELECT TEMPLATE_CONTENT FROM TBL_MAIL_TEMPLATE WHERE TEMPLATE_SEQ = 0)
            END EMAIL_CONTENT,
            SF_GET_DATE_F(A.SEND_DT,'YY','') AS SEND_DT,
            CASE WHEN D.SEND_DT IS NOT NULL THEN SF_GET_DATE_F(D.SEND_DT,'YY','') END AS MAIL_SEND_DT,
            CASE WHEN A.MAIL_BOX_SEQ IS NOT NULL THEN 'Y' ELSE 'N' END MAIL_SEND_YN,
            A.ETC_GFILE_SEQ
        FROM TBL_ESTIMATE A
            LEFT OUTER JOIN TBL_ESTIMATE_DETAIL B ON A.EST_SEQ = B.EST_SEQ
            LEFT OUTER JOIN TBL_MAIL_BOX D ON A.MAIL_BOX_SEQ = D.MAIL_BOX_SEQ
        WHERE 1=1
                AND A.EST_SEQ = #{EST_SEQ}
        GROUP BY A.EST_SEQ
        ORDER BY A.EST_NUM, A.EST_SEQ, A.EST_VER
    </select>

    <select id="selectEstimateDetailList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            ROW_NUMBER() OVER (ORDER BY SEQ) AS ROWNUM,
            EST_SEQ, SEQ, PROJECT_NM, MODULE_NM, ITEM_NM, DRAWING_NUM, PART_NUM,
            CASE WHEN PARENT_SEQ IS NULL THEN SEQ ELSE PARENT_SEQ END PARENT_SEQ,
            MATERIAL_SUPPLY_YN, ITEM_QTY, SIZE_TXT, SIZE_TYPE,
            SIZE_W, SIZE_H, SIZE_T, SIZE_D, SIZE_L,
            SIZE_W_M, SIZE_H_M, SIZE_T_M, SIZE_D_M, SIZE_L_M,
            WORK_TYPE AS WORK_TYPE, SF_GET_CODE_NM(1033, WORK_TYPE, 'EN') AS WORK_TYPE_NM,
            MATERIAL_TYPE AS MATERIAL_TYPE, SF_GET_CODE_NM(1035, MATERIAL_TYPE, 'EN') AS MATERIAL_TYPE_NM,
            MATERIAL_DETAIL AS MATERIAL_DETAIL, SF_GET_CODE_NM(1027, MATERIAL_DETAIL, 'EN') AS MATERIAL_DETAIL_NM,
            MATERIAL_KIND AS MATERIAL_KIND, SF_GET_CODE_NM(1029, MATERIAL_KIND, 'EN') AS MATERIAL_KIND_NM,
            SURFACE_TREAT AS SURFACE_TREAT, SF_GET_CODE_NM(1039, SURFACE_TREAT, 'EN') AS SURFACE_TREAT_NM,
            MATERIAL_NOTE AS MATERIAL_NOTE,
            DETAIL_LATHE AS DETAIL_LATHE, DETAIL_SURFACE AS DETAIL_SURFACE, DETAIL_CLAMPING AS DETAIL_CLAMPING,
            DETAIL_POCKET AS DETAIL_POCKET, DETAIL_DRILL AS DETAIL_DRILL, DETAIL_DIFFICULTY AS DETAIL_DIFFICULTY,
            MATERIAL_FINISH_TM AS MATERIAL_FINISH_TM, MATERIAL_FINISH_GRIND AS MATERIAL_FINISH_GRIND, MATERIAL_FINISH_HEAT AS MATERIAL_FINISH_HEAT,
            UNIT_MATERIAL_AMT AS UNIT_MATERIAL_AMT, UNIT_TM_AMT AS UNIT_TM_AMT,
            UNIT_GRIND_AMT AS UNIT_GRIND_AMT, UNIT_HEAT_AMT AS UNIT_HEAT_AMT,
            UNIT_SURFACE_AMT AS UNIT_SURFACE_AMT, UNIT_PROCESS_AMT AS UNIT_PROCESS_AMT,
            UNIT_ETC_AMT AS UNIT_ETC_AMT,
            UNIT_MATERIAL_AUTO_YN, UNIT_TM_AUTO_YN, UNIT_GRIND_AUTO_YN, UNIT_HEAT_AUTO_YN,
            UNIT_SURFACE_AUTO_YN, UNIT_PROCESS_AUTO_YN,
            UNIT_AMT_NOTE AS UNIT_AMT_NOTE, UNIT_FINAL_EST_AMT,
            NOTE AS NOTE, DWG_GFILE_SEQ, DXF_GFILE_SEQ, PDF_GFILE_SEQ, IMG_GFILE_SEQ,
            IFNULL(UNIT_MATERIAL_AMT, 0) + IFNULL(UNIT_TM_AMT, 0) + IFNULL(UNIT_GRIND_AMT, 0) + IFNULL(UNIT_HEAT_AMT, 0) +
            IFNULL(UNIT_SURFACE_AMT, 0) + IFNULL(UNIT_PROCESS_AMT, 0) + IFNULL(UNIT_ETC_AMT, 0) AS CALCUL_EST_UNIT_COST,
            CASE WHEN UNIT_FINAL_EST_AMT IS NOT NULL THEN IFNULL(UNIT_FINAL_EST_AMT, 0) * IFNULL(ITEM_QTY, 0)
                ELSE (IFNULL(UNIT_MATERIAL_AMT, 0) + IFNULL(UNIT_TM_AMT, 0) + IFNULL(UNIT_GRIND_AMT, 0) + IFNULL(UNIT_HEAT_AMT, 0) +
                        IFNULL(UNIT_SURFACE_AMT, 0) + IFNULL(UNIT_PROCESS_AMT, 0) + IFNULL(UNIT_ETC_AMT, 0)) * IFNULL(ITEM_QTY, 0)
            END AS DTL_AMOUNT
        FROM TBL_ESTIMATE_DETAIL
        WHERE 1=1
            AND EST_SEQ = #{EST_SEQ}
        ORDER BY CASE WHEN PARENT_SEQ IS NULL THEN SEQ ELSE PARENT_SEQ END, SEQ
    </select>

    <select id="selectEstimateReceiverList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
			A.EST_SEQ, B.SEQ, B.RECEIVER_NM, B.RECEIVER_EMAIL, B.RECEIVER_TEL
        FROM TBL_ESTIMATE A
            INNER JOIN TBL_ESTIMATE_RECEIVER B ON A.EST_SEQ = B.EST_SEQ
        WHERE A.EST_SEQ = #{EST_SEQ}
    </select>

    <select id="selectEstimateMasterListPop" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.EST_SEQ, A.EST_NUM, A.EST_VER, A.EST_TITLE,
            A.EST_STATUS, SF_GET_CODE_NM(1048, A.EST_STATUS, 'EN') AS EST_STATUS_NM,
            A.ORDER_COMP_CD, C.COMP_NM AS ORDER_COMP_NM,
            A.ORDER_STAFF_SEQ, E.STAFF_NM AS ORDER_STAFF_NM, A.COMP_CD, D.COMP_NM AS COMP_NM,
            COUNT(B.SEQ) AS DTL_CNT, SUM(B.UNIT_FINAL_EST_AMT) AS DTL_AMOUNT,
            DATE_FORMAT(A.INSERT_DT, '%Y-%m-%d %T') INSERT_DT, A.EST_USER_ID, A.SEND_DT,
            A.ETC_GFILE_SEQ
        FROM TBL_ESTIMATE A
            LEFT OUTER JOIN TBL_ESTIMATE_DETAIL B ON A.EST_SEQ = B.EST_SEQ
            LEFT OUTER JOIN TBL_COMPANY C ON A.ORDER_COMP_CD = C.COMP_CD
            LEFT OUTER JOIN TBL_COMPANY D ON A.COMP_CD = D.COMP_CD
            LEFT OUTER JOIN TBL_COMPANY_STAFF E ON A.ORDER_STAFF_SEQ = E.STAFF_SEQ AND E.DEL_YN = 'N'
        WHERE A.EST_SEQ = #{EST_SEQ}
        GROUP BY A.EST_SEQ
        ORDER BY A.EST_SEQ, A.EST_NUM
    </select>

    <select id="manageEstimateCadFiles_select" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            UUID() AS ROWNUM,
            A.EST_SEQ,
            A.EST_NUM,
            A.EST_VER, <!-- 차수 -->
            B.SEQ,
            B.MODULE_NM,
            B.ITEM_NM, <!-- 품명 -->
            B.PART_NUM, <!-- Part -->
            B.DRAWING_NUM,
            #{NEW_DRAWING_NUM} AS NEW_DRAWING_NUM,
            #{FILE_NM} AS FILE_NM,
            #{DXF_GFILE_SEQ} AS DXF_GFILE_SEQ,
            #{PDF_GFILE_SEQ} AS PDF_GFILE_SEQ,
            #{IMG_GFILE_SEQ} AS IMG_GFILE_SEQ,
            #{TIME_PATH} AS TIME_PATH,
            #{FILE_PATH} AS FILE_PATH,
            CASE WHEN IMG_GFILE_SEQ IS NOT NULL THEN '이미 등록됨, Save 후 교체됨'  <!-- 이미 등록된 Save시 교체 진행  메시지 처리 -->
                WHEN IFNULL(#{DXF_GFILE_SEQ}, 0) <![CDATA[ <= ]]> 0 THEN  '파일 업로드 오류' <!-- 파일 업로드 오류 및 CONVERT 사이즈 오류 -->
            ELSE ''
            END AS UPLOAD_MESSAGE
        FROM TBL_ESTIMATE A
            INNER JOIN TBL_ESTIMATE_DETAIL B ON A.EST_SEQ = B.EST_SEQ
        WHERE 1 = 1
            AND A.DEL_YN = 'N'
            AND IFNULL(A.EST_STATUS, 'EST010') IN ('EST010')
            AND #{ORGINAL_FILE_NM} LIKE CONCAT(B.DRAWING_NUM, '%')
    </select>

    <update id="manageEstimateCadFiles" parameterType="java.util.HashMap">
        UPDATE TBL_ESTIMATE_DETAIL
        SET
            DXF_GFILE_SEQ = #{DXF_GFILE_SEQ},
            PDF_GFILE_SEQ = #{PDF_GFILE_SEQ},
            IMG_GFILE_SEQ = #{IMG_GFILE_SEQ},
            UPDATE_DT = NOW(),
            UPDATE_ID = #{LOGIN_USER_ID}
        WHERE EST_SEQ = #{EST_SEQ}
            AND SEQ = #{SEQ}
    </update>

<!--    <update id="manageEstimateCadFiles" parameterType="java.util.HashMap">-->
<!--        UPDATE TBL_ESTIMATE_DETAIL-->
<!--        SET-->
<!--            /* DRAWING_NUM = #{NEW_DRAWING_NUM}, */-->
<!--            DXF_GFILE_SEQ = #{DXF_GFILE_SEQ},-->
<!--            PDF_GFILE_SEQ = NULL,-->
<!--            IMG_GFILE_SEQ = NULL,-->
<!--            UPDATE_DT = NOW(),-->
<!--            UPDATE_ID = #{LOGIN_USER_ID}-->
<!--        WHERE EST_SEQ = #{EST_SEQ}-->
<!--            AND SEQ = #{SEQ}-->
<!--    </update>-->

<!--    <update id="manageEstimateCadFiles_mapping" parameterType="java.util.HashMap">-->
<!--        UPDATE TBL_ESTIMATE_DETAIL-->
<!--        SET-->
<!--            PDF_GFILE_SEQ = #{PDF_GFILE_SEQ},-->
<!--            IMG_GFILE_SEQ = #{IMG_GFILE_SEQ},-->
<!--            UPDATE_DT = NOW(),-->
<!--            UPDATE_ID = #{LOGIN_USER_ID}-->
<!--        WHERE-->
<!--            DXF_GFILE_SEQ = #{DXF_GFILE_SEQ}-->
<!--    </update>-->

    <insert id="insertEstimateMaster" parameterType="java.util.HashMap">
        INSERT INTO TBL_ESTIMATE
            (EST_SEQ, EST_VER, EST_NUM, ORDER_COMP_CD, ORDER_STAFF_SEQ, COMP_CD, EST_USER_ID,
            EST_TITLE, EST_STATUS, EMAIL_TITLE, EMAIL_CONTENT, ETC_GFILE_SEQ, DEL_YN, INSERT_DT, INSERT_ID)
        SELECT
            #{EST_SEQ} AS EST_SEQ, EST_VER, EST_NUM,
            #{ORDER_COMP_CD} AS ORDER_COMP_CD, #{ORDER_STAFF_SEQ} AS ORDER_STAFF_SEQ, #{COMP_CD} AS COMP_CD, #{EST_USER_ID} AS EST_USER_ID,
            #{EST_TITLE} AS EST_TITLE, 'EST010' AS EST_STATUS,
            CONCAT('[견적서송부 ', IFNULL(EST_NUM, SPACE(0)), IFNULL(EST_TITLE, SPACE(0))) AS EMAIL_TITLE,
            #{EMAIL_CONTENT} AS EMAIL_CONTENT, #{GFILE_SEQ}, 'N' AS DEL_YN, NOW() AS INSERT_DT, NULL AS INSERT_ID
        FROM (
            SELECT
                0 AS EST_VER, EST_TITLE,
                CONCAT('EST-', DATE_FORMAT(NOW(), '%Y%m%d'), LPAD(CAST(COUNT(*)+1 AS CHAR), 3, '0')) EST_NUM
            FROM TBL_ESTIMATE
            WHERE DATE_FORMAT(INSERT_DT, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
        ) Z
        ON DUPLICATE KEY UPDATE
            ORDER_COMP_CD = #{ORDER_COMP_CD},
            ORDER_STAFF_SEQ = #{ORDER_STAFF_SEQ},
            COMP_CD = #{COMP_CD},
            EST_USER_ID = #{EST_USER_ID},
            EST_TITLE = #{EST_TITLE},
            EMAIL_TITLE = (SELECT CONCAT('[견적서송부 ', IFNULL(EST_NUM, SPACE(0)), IFNULL(EST_TITLE, SPACE(0))) FROM TBL_ESTIMATE WHERE EST_SEQ = #{EST_SEQ}),
            EMAIL_CONTENT = #{EMAIL_CONTENT},
            ETC_GFILE_SEQ = #{GFILE_SEQ},
            UPDATE_DT = NOW(),
            UPDATE_ID = NULL
    </insert>

    <insert id="insertEstimateDetail" parameterType="java.util.HashMap">
        INSERT INTO TBL_ESTIMATE_DETAIL
        (
            EST_SEQ, SEQ,
            PROJECT_NM, MODULE_NM, ITEM_NM, DRAWING_NUM, PART_NUM, PARENT_SEQ,
            MATERIAL_SUPPLY_YN, ITEM_QTY, SIZE_TXT, SIZE_TYPE,
            SIZE_W, SIZE_H, SIZE_T, SIZE_D, SIZE_L,
            SIZE_W_M, SIZE_H_M, SIZE_T_M, SIZE_D_M, SIZE_L_M,
            WORK_TYPE, MATERIAL_TYPE, MATERIAL_DETAIL, MATERIAL_KIND, SURFACE_TREAT, MATERIAL_NOTE,
            DETAIL_LATHE, DETAIL_SURFACE, DETAIL_CLAMPING, DETAIL_POCKET, DETAIL_DRILL, DETAIL_DIFFICULTY,
            MATERIAL_FINISH_TM, MATERIAL_FINISH_GRIND, MATERIAL_FINISH_HEAT,
            UNIT_MATERIAL_AMT, UNIT_TM_AMT, UNIT_GRIND_AMT, UNIT_HEAT_AMT, UNIT_SURFACE_AMT, UNIT_PROCESS_AMT, UNIT_ETC_AMT,
            UNIT_MATERIAL_AUTO_YN, UNIT_TM_AUTO_YN, UNIT_GRIND_AUTO_YN, UNIT_HEAT_AUTO_YN,
            UNIT_SURFACE_AUTO_YN, UNIT_PROCESS_AUTO_YN,
            UNIT_AMT_NOTE, UNIT_FINAL_EST_AMT,
            NOTE, DWG_GFILE_SEQ, DXF_GFILE_SEQ, PDF_GFILE_SEQ, IMG_GFILE_SEQ,
            INSERT_ID
        )
        VALUES
        (
            #{EST_SEQ}, CASE WHEN #{SEQ} IS NOT NULL THEN #{SEQ} ELSE NEXTVAL(SEQ_ESTIMATE_DETAIL) END ,
            #{PROJECT_NM}, #{MODULE_NM}, #{ITEM_NM}, #{DRAWING_NUM}, #{PART_NUM}, #{PARENT_SEQ},
            #{MATERIAL_SUPPLY_YN}, #{ITEM_QTY}, #{SIZE_TXT},
            SF_GET_SIZE_TXT('SIZE_TYPE', #{SIZE_TXT}), SF_GET_SIZE_TXT('SIZE_W', #{SIZE_TXT}),
            SF_GET_SIZE_TXT('SIZE_H', #{SIZE_TXT}), SF_GET_SIZE_TXT('SIZE_T', #{SIZE_TXT}),
            SF_GET_SIZE_TXT('SIZE_D', #{SIZE_TXT}), SF_GET_SIZE_TXT('SIZE_L', #{SIZE_TXT}),
            #{SIZE_W_M}, #{SIZE_H_M}, #{SIZE_T_M}, #{SIZE_D_M}, #{SIZE_L_M},
            #{WORK_TYPE}, #{MATERIAL_TYPE}, #{MATERIAL_DETAIL}, #{MATERIAL_KIND}, #{SURFACE_TREAT}, #{MATERIAL_NOTE},
            #{DETAIL_LATHE}, #{DETAIL_SURFACE}, #{DETAIL_CLAMPING}, #{DETAIL_POCKET}, #{DETAIL_DRILL}, #{DETAIL_DIFFICULTY},
            #{MATERIAL_FINISH_TM}, #{MATERIAL_FINISH_GRIND}, #{MATERIAL_FINISH_HEAT},
            #{UNIT_MATERIAL_AMT}, #{UNIT_TM_AMT}, #{UNIT_GRIND_AMT}, #{UNIT_HEAT_AMT}, #{UNIT_SURFACE_AMT}, #{UNIT_PROCESS_AMT}, #{UNIT_ETC_AMT},
            'N','N','N','N','N','N',
            #{UNIT_AMT_NOTE}, #{UNIT_FINAL_EST_AMT},
            #{NOTE}, #{DWG_GFILE_SEQ}, #{DXF_GFILE_SEQ}, #{PDF_GFILE_SEQ}, #{IMG_GFILE_SEQ},
            NULL
        )
        ON DUPLICATE KEY UPDATE
            PROJECT_NM = #{PROJECT_NM},
            MODULE_NM = #{MODULE_NM},                       ITEM_NM = #{ITEM_NM},
            DRAWING_NUM = #{DRAWING_NUM},                   PART_NUM = #{PART_NUM},
            MATERIAL_SUPPLY_YN = #{MATERIAL_SUPPLY_YN},     SIZE_TXT = #{SIZE_TXT},
            SIZE_TYPE = SF_GET_SIZE_TXT('SIZE_TYPE', #{SIZE_TXT}),
            SIZE_W = SF_GET_SIZE_TXT('SIZE_W', #{SIZE_TXT}),
            SIZE_H = SF_GET_SIZE_TXT('SIZE_H', #{SIZE_TXT}),
            SIZE_T = SF_GET_SIZE_TXT('SIZE_T', #{SIZE_TXT}),
            SIZE_D = SF_GET_SIZE_TXT('SIZE_D', #{SIZE_TXT}),
            SIZE_L = SF_GET_SIZE_TXT('SIZE_L', #{SIZE_TXT}),
            SIZE_W_M = #{SIZE_W_M},                             SIZE_H_M = #{SIZE_H_M},
            SIZE_T_M = #{SIZE_T_M},                             SIZE_D_M = #{SIZE_D_M},
            SIZE_L_M = #{SIZE_L_M},                             ITEM_QTY = #{ITEM_QTY},
            WORK_TYPE = #{WORK_TYPE},                           MATERIAL_TYPE = #{MATERIAL_TYPE},
            MATERIAL_DETAIL = #{MATERIAL_DETAIL},               MATERIAL_KIND = #{MATERIAL_KIND},
            SURFACE_TREAT = #{SURFACE_TREAT},                   MATERIAL_NOTE = #{MATERIAL_NOTE},
            DETAIL_LATHE = #{DETAIL_LATHE},                     DETAIL_SURFACE = #{DETAIL_SURFACE},
            DETAIL_CLAMPING = #{DETAIL_CLAMPING},               DETAIL_POCKET = #{DETAIL_POCKET},
            DETAIL_DRILL = #{DETAIL_DRILL},                     DETAIL_DIFFICULTY = #{DETAIL_DIFFICULTY},
            MATERIAL_FINISH_TM = #{MATERIAL_FINISH_TM},         MATERIAL_FINISH_GRIND = #{MATERIAL_FINISH_GRIND},
            MATERIAL_FINISH_HEAT = #{MATERIAL_FINISH_HEAT},     UNIT_MATERIAL_AMT = #{UNIT_MATERIAL_AMT},
            UNIT_TM_AMT = #{UNIT_TM_AMT},                       UNIT_GRIND_AMT = #{UNIT_GRIND_AMT},
            UNIT_HEAT_AMT = #{UNIT_HEAT_AMT},                   UNIT_SURFACE_AMT = #{UNIT_SURFACE_AMT},
            UNIT_PROCESS_AMT = #{UNIT_PROCESS_AMT},             UNIT_ETC_AMT = #{UNIT_ETC_AMT},
            UNIT_MATERIAL_AUTO_YN = #{UNIT_MATERIAL_AUTO_YN},   UNIT_TM_AUTO_YN = #{UNIT_TM_AUTO_YN},
            UNIT_GRIND_AUTO_YN = #{UNIT_GRIND_AUTO_YN},         UNIT_HEAT_AUTO_YN = #{UNIT_HEAT_AUTO_YN},
            UNIT_SURFACE_AUTO_YN = #{UNIT_SURFACE_AUTO_YN},     UNIT_PROCESS_AUTO_YN = #{UNIT_PROCESS_AUTO_YN},
            UNIT_AMT_NOTE = #{UNIT_AMT_NOTE},                   UNIT_FINAL_EST_AMT = #{UNIT_FINAL_EST_AMT},
            NOTE = #{NOTE},
            DWG_GFILE_SEQ = #{DWG_GFILE_SEQ},                   DXF_GFILE_SEQ = #{DXF_GFILE_SEQ},
            PDF_GFILE_SEQ = #{PDF_GFILE_SEQ},                   IMG_GFILE_SEQ = #{IMG_GFILE_SEQ},
            UPDATE_DT = NOW(),                                  UPDATE_ID = #{UPDATE_ID}
    </insert>

    <insert id="insertEstimateReceiver" parameterType="java.util.HashMap">
        INSERT INTO TBL_ESTIMATE_RECEIVER(EST_SEQ, SEQ, RECEIVER_NM, RECEIVER_EMAIL, RECEIVER_TEL)
        VALUES
        (
            #{EST_SEQ}, CASE WHEN #{SEQ} IS NOT NULL THEN #{SEQ} ELSE NEXTVAL(SEQ_ESTIMATE_RECEIVER) END,
            #{RECEIVER_NM}, #{RECEIVER_EMAIL}, #{RECEIVER_TEL}
        )
        ON DUPLICATE KEY UPDATE
            RECEIVER_NM = #{RECEIVER_NM},
            RECEIVER_EMAIL = #{RECEIVER_EMAIL},
            RECEIVER_TEL= #{RECEIVER_TEL},
            UPDATE_DT = NOW(),
            UPDATE_ID = #{UPDATE_ID}
    </insert>

    <update id="updateEstimateMaster"  parameterType="java.util.HashMap">
        UPDATE TBL_ESTIMATE
        SET
            EST_NUM = #{EST_NUM},
            ORDER_COMP_CD = #{ORDER_COMP_CD},
            ORDER_STAFF_SEQ = #{ORDER_STAFF_SEQ},
            COMP_CD = #{COMP_CD},
            EST_USER_ID = #{EST_USER_ID},
            EST_TITLE = #{EST_TITLE},
            EST_STATUS = #{EST_STATUS},
            DEL_YN = #{DEL_YN},
            UPDATE_DT = NOW(),
            UPDATE_ID = NULL
        WHERE EST_SEQ = #{EST_SEQ}
            AND EST_VER = #{EST_VER}
    </update>

    <update id="updateEstimateDetail"  parameterType="java.util.HashMap">
        UPDATE TBL_ESTIMATE_DETAIL
        SET PROJECT_NM = #{PROJECT_NM},
            MODULE_NM = #{MODULE_NM},                       ITEM_NM = #{ITEM_NM},
            DRAWING_NUM = #{DRAWING_NUM},                   PART_NUM = #{PART_NUM},
            MATERIAL_SUPPLY_YN = #{MATERIAL_SUPPLY_YN},     SIZE_TXT = #{SIZE_TXT},
            SIZE_TYPE = SF_GET_SIZE_TXT('SIZE_TYPE', #{SIZE_TXT}),
            SIZE_W = SF_GET_SIZE_TXT('SIZE_W', #{SIZE_TXT}),
            SIZE_H = SF_GET_SIZE_TXT('SIZE_H', #{SIZE_TXT}),
            SIZE_T = SF_GET_SIZE_TXT('SIZE_T', #{SIZE_TXT}),
            SIZE_D = SF_GET_SIZE_TXT('SIZE_D', #{SIZE_TXT}),
            SIZE_L = SF_GET_SIZE_TXT('SIZE_L', #{SIZE_TXT}),
            SIZE_W_M = #{SIZE_W_M},                             SIZE_H_M = #{SIZE_H_M},
            SIZE_T_M = #{SIZE_T_M},                             SIZE_D_M = #{SIZE_D_M},
            SIZE_L_M = #{SIZE_L_M},                             ITEM_QTY = #{ITEM_QTY},
            WORK_TYPE = #{WORK_TYPE},                           MATERIAL_TYPE = #{MATERIAL_TYPE},
            MATERIAL_DETAIL = #{MATERIAL_DETAIL},               MATERIAL_KIND = #{MATERIAL_KIND},
            SURFACE_TREAT = #{SURFACE_TREAT},                   MATERIAL_NOTE = #{MATERIAL_NOTE},
            DETAIL_LATHE = #{DETAIL_LATHE},                     DETAIL_SURFACE = #{DETAIL_SURFACE},
            DETAIL_CLAMPING = #{DETAIL_CLAMPING},               DETAIL_POCKET = #{DETAIL_POCKET},
            DETAIL_DRILL = #{DETAIL_DRILL},                     DETAIL_DIFFICULTY = #{DETAIL_DIFFICULTY},
            MATERIAL_FINISH_TM = #{MATERIAL_FINISH_TM},         MATERIAL_FINISH_GRIND = #{MATERIAL_FINISH_GRIND},
            MATERIAL_FINISH_HEAT = #{MATERIAL_FINISH_HEAT},     UNIT_MATERIAL_AMT = #{UNIT_MATERIAL_AMT},
            UNIT_TM_AMT = #{UNIT_TM_AMT},                       UNIT_GRIND_AMT = #{UNIT_GRIND_AMT},
            UNIT_HEAT_AMT = #{UNIT_HEAT_AMT},                   UNIT_SURFACE_AMT = #{UNIT_SURFACE_AMT},
            UNIT_PROCESS_AMT = #{UNIT_PROCESS_AMT},             UNIT_ETC_AMT = #{UNIT_ETC_AMT},
            UNIT_MATERIAL_AUTO_YN = #{UNIT_MATERIAL_AUTO_YN},   UNIT_TM_AUTO_YN = #{UNIT_TM_AUTO_YN},
            UNIT_GRIND_AUTO_YN = #{UNIT_GRIND_AUTO_YN},         UNIT_HEAT_AUTO_YN = #{UNIT_HEAT_AUTO_YN},
            UNIT_SURFACE_AUTO_YN = #{UNIT_SURFACE_AUTO_YN},     UNIT_PROCESS_AUTO_YN = #{UNIT_PROCESS_AUTO_YN},
            UNIT_AMT_NOTE = #{UNIT_AMT_NOTE},                   UNIT_FINAL_EST_AMT = #{UNIT_FINAL_EST_AMT},
            NOTE = #{NOTE},
            DWG_GFILE_SEQ = #{DWG_GFILE_SEQ},                   DXF_GFILE_SEQ = #{DXF_GFILE_SEQ},
            PDF_GFILE_SEQ = #{PDF_GFILE_SEQ},                   IMG_GFILE_SEQ = #{IMG_GFILE_SEQ},
            UPDATE_DT = #{UPDATE_DT},                           UPDATE_ID = #{UPDATE_ID}
        WHERE EST_SEQ = #{EST_SEQ}
            AND SEQ = #{SEQ}
    </update>

    <update id="updateEstimateMasterGfileSeq"  parameterType="java.util.HashMap">
        UPDATE TBL_ESTIMATE
        SET
            ETC_GFILE_SEQ = NULL,
            UPDATE_DT = NOW(),
            UPDATE_ID = NULL
        WHERE EST_SEQ = #{EST_SEQ}
    </update>

    <delete id="deleteEstimateMaster"  parameterType="java.util.HashMap">
        DELETE FROM TBL_ESTIMATE
        WHERE EST_SEQ = #{EST_SEQ}
            AND EST_VER = #{EST_VER}
    </delete>

    <delete id="deleteEstimateDetail"  parameterType="java.util.HashMap">
        DELETE FROM TBL_ESTIMATE_DETAIL
        WHERE EST_SEQ = #{EST_SEQ}
    </delete>

    <delete id="deleteEstimateReceiver"  parameterType="java.util.HashMap">
        DELETE FROM TBL_ESTIMATE_RECEIVER
        WHERE EST_SEQ = #{EST_SEQ}
    </delete>

    <delete id="deleteEstimateEachReceiver"  parameterType="java.util.HashMap">
        DELETE FROM TBL_ESTIMATE_RECEIVER
        WHERE SEQ = #{SEQ}
    </delete>

    <insert id="insertEstimateMasterVersion"  parameterType="java.util.HashMap">
        INSERT INTO TBL_ESTIMATE
            (EST_SEQ, EST_VER, EST_NUM, ORDER_COMP_CD, ORDER_STAFF_SEQ, COMP_CD, EST_USER_ID,
            EST_TITLE, EST_STATUS, EMAIL_TITLE, EMAIL_CONTENT, ETC_GFILE_SEQ, DEL_YN, INSERT_DT, INSERT_ID)
        SELECT
            #{N_EST_SEQ}, (SELECT MAX(EST_VER)+1 FROM TBL_ESTIMATE WHERE A.EST_NUM = EST_NUM) EST_VER,
            EST_NUM, ORDER_COMP_CD, ORDER_STAFF_SEQ, COMP_CD, EST_USER_ID,
            EST_TITLE, 'EST010', EMAIL_TITLE, EMAIL_CONTENT, ETC_GFILE_SEQ, DEL_YN, NOW(), INSERT_ID
        FROM TBL_ESTIMATE A
        WHERE EST_SEQ = #{EST_SEQ}
    </insert>

    <insert id="insertEstimateDetailVersion"  parameterType="java.util.HashMap">
        INSERT INTO TBL_ESTIMATE_DETAIL
        (
            EST_SEQ, SEQ, PROJECT_NM, MODULE_NM, ITEM_NM, DRAWING_NUM, PART_NUM, PARENT_SEQ, MATERIAL_SUPPLY_YN,
            ITEM_QTY, SIZE_TXT, SIZE_TYPE, SIZE_W, SIZE_H, SIZE_T, SIZE_D, SIZE_L,
            SIZE_W_M, SIZE_H_M, SIZE_T_M, SIZE_D_M, SIZE_L_M,
            WORK_TYPE, MATERIAL_TYPE, MATERIAL_DETAIL, MATERIAL_KIND, SURFACE_TREAT, MATERIAL_NOTE,
            DETAIL_LATHE, DETAIL_SURFACE, DETAIL_CLAMPING, DETAIL_POCKET, DETAIL_DRILL, DETAIL_DIFFICULTY,
            MATERIAL_FINISH_TM, MATERIAL_FINISH_GRIND, MATERIAL_FINISH_HEAT,
            UNIT_MATERIAL_AMT, UNIT_TM_AMT, UNIT_GRIND_AMT, UNIT_HEAT_AMT, UNIT_SURFACE_AMT, UNIT_PROCESS_AMT, UNIT_ETC_AMT,
            UNIT_MATERIAL_AUTO_YN, UNIT_TM_AUTO_YN, UNIT_GRIND_AUTO_YN, UNIT_HEAT_AUTO_YN,
            UNIT_SURFACE_AUTO_YN, UNIT_PROCESS_AUTO_YN,
            UNIT_AMT_NOTE, UNIT_FINAL_EST_AMT,
            NOTE, DWG_GFILE_SEQ, DXF_GFILE_SEQ, PDF_GFILE_SEQ, IMG_GFILE_SEQ,
            INSERT_DT, INSERT_ID
        )
        SELECT
            #{N_EST_SEQ} AS EST_SEQ, SEQ, PROJECT_NM, MODULE_NM, ITEM_NM, DRAWING_NUM, PART_NUM, PARENT_SEQ, MATERIAL_SUPPLY_YN,
            ITEM_QTY, SIZE_TXT, SIZE_TYPE, SIZE_W, SIZE_H, SIZE_T, SIZE_D, SIZE_L,
            SIZE_W_M, SIZE_H_M, SIZE_T_M, SIZE_D_M, SIZE_L_M,
            WORK_TYPE, MATERIAL_TYPE, MATERIAL_DETAIL, MATERIAL_KIND, SURFACE_TREAT, MATERIAL_NOTE,
            DETAIL_LATHE, DETAIL_SURFACE, DETAIL_CLAMPING, DETAIL_POCKET, DETAIL_DRILL, DETAIL_DIFFICULTY,
            MATERIAL_FINISH_TM, MATERIAL_FINISH_GRIND, MATERIAL_FINISH_HEAT,
            UNIT_MATERIAL_AMT, UNIT_TM_AMT, UNIT_GRIND_AMT, UNIT_HEAT_AMT, UNIT_SURFACE_AMT, UNIT_PROCESS_AMT, UNIT_ETC_AMT,
            UNIT_MATERIAL_AUTO_YN, UNIT_TM_AUTO_YN, UNIT_GRIND_AUTO_YN, UNIT_HEAT_AUTO_YN,
            UNIT_SURFACE_AUTO_YN, UNIT_PROCESS_AUTO_YN,
            UNIT_AMT_NOTE, UNIT_FINAL_EST_AMT,
            NOTE, DWG_GFILE_SEQ, DXF_GFILE_SEQ, PDF_GFILE_SEQ, IMG_GFILE_SEQ,
            INSERT_DT, INSERT_ID
        FROM TBL_ESTIMATE_DETAIL
         WHERE 1=1
			AND EST_SEQ = #{EST_SEQ}
    </insert>

    <insert id="insertEstimateReceiverVersion" parameterType="java.util.HashMap">
        INSERT INTO TBL_ESTIMATE_RECEIVER
        (EST_SEQ, SEQ, RECEIVER_NM, RECEIVER_EMAIL, RECEIVER_TEL, INSERT_DT, INSERT_ID)
        SELECT
            #{N_EST_SEQ}, NEXTVAL(SEQ_ESTIMATE_RECEIVER), RECEIVER_NM, RECEIVER_EMAIL, RECEIVER_TEL, NOW(), NULL
        FROM TBL_ESTIMATE_RECEIVER
        WHERE EST_SEQ = #{EST_SEQ}
    </insert>

    <select id="selectEstimateOrderControlData" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            EST_SEQ, SEQ, PROJECT_NM, MODULE_NM, ITEM_NM, DRAWING_NUM, PART_NUM,
            CASE WHEN PARENT_SEQ IS NULL THEN SEQ ELSE PARENT_SEQ END PARENT_SEQ,
            ITEM_QTY
        FROM TBL_ESTIMATE_DETAIL
        WHERE 1=1
            AND EST_SEQ = #{EST_SEQ}
		GROUP BY CASE WHEN PARENT_SEQ IS NULL THEN SEQ ELSE PARENT_SEQ END
        ORDER BY PROJECT_NM, MODULE_NM, ITEM_NM, PART_NUM
    </select>

    <insert id="insertEstimateOrderControlMaster" parameterType="java.util.HashMap">
        INSERT INTO TBL_CONTROL
            (CONTROL_SEQ, CONTROL_VER, COMP_CD, ORDER_COMP_CD, ORDER_STAFF_SEQ, PROJECT_NM, MODULE_NM, EST_SEQ, DEL_YN, INSERT_ID)
        SELECT
            NEXTVAL(SEQ_CONTROL), A.EST_VER, A.COMP_CD, A.ORDER_COMP_CD, A.ORDER_STAFF_SEQ, B.PROJECT_NM, B.MODULE_NM, A.EST_SEQ, 'N', NULL
        FROM TBL_ESTIMATE A
            INNER JOIN TBL_ESTIMATE_DETAIL B ON A.EST_SEQ = B.EST_SEQ
                AND CASE WHEN B.PARENT_SEQ IS NULL THEN B.SEQ ELSE B.PARENT_SEQ END = #{SEQ}
        WHERE A.EST_SEQ = #{EST_SEQ}
        GROUP BY CASE WHEN B.PARENT_SEQ IS NULL THEN B.SEQ ELSE B.PARENT_SEQ END
    </insert>

    <insert id="insertEstimateOrderControlDetail"  parameterType="java.util.HashMap">
        INSERT INTO TBL_CONTROL_PART
            (CONTROL_SEQ, CONTROL_DETAIL_SEQ, PART_NUM, DRAWING_NUM,
            ITEM_NM, WORK_TYPE, MATERIAL_SUPPLY_YN,
            SIZE_TXT, SIZE_TYPE, SIZE_W, SIZE_H, SIZE_T, SIZE_D, SIZE_L,
            SIZE_W_M, SIZE_H_M, SIZE_T_M, SIZE_D_M, SIZE_L_M,
            MATERIAL_TYPE, MATERIAL_DETAIL, MATERIAL_KIND, SURFACE_TREAT, MATERIAL_NOTE,
            DETAIL_LATHE, DETAIL_SURFACE, DETAIL_CLAMPING, DETAIL_POCKET, DETAIL_DRILL,DETAIL_DIFFICULTY,
            MATERIAL_FINISH_TM, MATERIAL_FINISH_GRIND, MATERIAL_FINISH_HEAT,
            UNIT_MATERIAL_AMT, UNIT_TM_AMT, UNIT_GRIND_AMT, UNIT_HEAT_AMT, UNIT_SURFACE_AMT, UNIT_PROCESS_AMT, UNIT_ETC_AMT,
            UNIT_MATERIAL_AUTO_YN, UNIT_TM_AUTO_YN, UNIT_GRIND_AUTO_YN, UNIT_HEAT_AUTO_YN, UNIT_SURFACE_AUTO_YN, UNIT_PROCESS_AUTO_YN,
            UNIT_AMT_NOTE, UNIT_FINAL_EST_AMT,
            DWG_GFILE_SEQ, DXF_GFILE_SEQ, PDF_GFILE_SEQ, IMG_GFILE_SEQ,
            INSERT_ID)
        SELECT
            LASTVAL(SEQ_CONTROL), NEXTVAL(SEQ_CONTROL_PART), PART_NUM, DRAWING_NUM,
            ITEM_NM, WORK_TYPE, MATERIAL_SUPPLY_YN,
            SIZE_TXT, SIZE_TYPE, SIZE_W, SIZE_H, SIZE_T, SIZE_D, SIZE_L,
            SIZE_W_M, SIZE_H_M, SIZE_T_M, SIZE_D_M, SIZE_L_M,
            MATERIAL_TYPE, MATERIAL_DETAIL, MATERIAL_KIND, SURFACE_TREAT, MATERIAL_NOTE,
            DETAIL_LATHE, DETAIL_SURFACE, DETAIL_CLAMPING, DETAIL_POCKET, DETAIL_DRILL,DETAIL_DIFFICULTY,
            MATERIAL_FINISH_TM, MATERIAL_FINISH_GRIND, MATERIAL_FINISH_HEAT,
            UNIT_MATERIAL_AMT, UNIT_TM_AMT, UNIT_GRIND_AMT, UNIT_HEAT_AMT, UNIT_SURFACE_AMT, UNIT_PROCESS_AMT, UNIT_ETC_AMT,
            UNIT_MATERIAL_AUTO_YN, UNIT_TM_AUTO_YN, UNIT_GRIND_AUTO_YN, UNIT_HEAT_AUTO_YN, UNIT_SURFACE_AUTO_YN, UNIT_PROCESS_AUTO_YN,
            UNIT_AMT_NOTE, UNIT_FINAL_EST_AMT,
            DWG_GFILE_SEQ, DXF_GFILE_SEQ, PDF_GFILE_SEQ, IMG_GFILE_SEQ,
            NULL
        FROM TBL_ESTIMATE_DETAIL
        WHERE 1=1
            AND EST_SEQ = #{EST_SEQ}
            AND CASE WHEN PARENT_SEQ IS NULL THEN SEQ ELSE PARENT_SEQ END = #{SEQ}
    </insert>

    <insert id="insertEstimateOrderControlOrder"  parameterType="java.util.HashMap">
        INSERT IGNORE INTO TBL_CONTROL_PART_ORDER
            (CONTROL_SEQ, CONTROL_DETAIL_SEQ, ORDER_SEQ, ORDER_QTY, INSERT_ID)
        SELECT
            A.CONTROL_SEQ, B.CONTROL_DETAIL_SEQ, NEXTVAL(SEQ_CONTROL_PART_ORDER),
            CASE WHEN IFNULL(B.WORK_TYPE, SPACE(0)) != 'WTP050' THEN #{ITEM_QTY} END ,NULL
        FROM TBL_CONTROL A
            INNER JOIN TBL_CONTROL_PART B ON A.CONTROL_SEQ = B.CONTROL_SEQ
				AND B.CONTROL_DETAIL_SEQ NOT IN (
													SELECT C.CONTROL_DETAIL_SEQ
													FROM TBL_CONTROL B
														INNER JOIN TBL_CONTROL_PART C ON B.CONTROL_SEQ = C.CONTROL_SEQ
														INNER JOIN TBL_CONTROL_PART_ORDER D ON C.CONTROL_SEQ = D.CONTROL_SEQ AND C.CONTROL_DETAIL_SEQ = D.CONTROL_DETAIL_SEQ
													WHERE B.EST_SEQ = #{EST_SEQ}
												)
        WHERE 1=1
            AND A.EST_SEQ = #{EST_SEQ}
    </insert>

    <select id="selectEstimateMailNextSequence" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT NEXTVAL(SEQ_MAIL) AS MAIL_BOX_SEQ FROM DUAL
    </select>

    <update id="updateEstimateMasterFinish" parameterType="java.util.HashMap">
        UPDATE TBL_ESTIMATE
        SET
            EST_STATUS = 'EST020',
            SEND_DT = NOW(),
            UPDATE_DT = NOW(),
            UPDATE_ID = NULL
        WHERE EST_SEQ = #{EST_SEQ}
    </update>

    <update id="updateEstimateMasterFinishWithMail" parameterType="java.util.HashMap">
        UPDATE TBL_ESTIMATE
        SET
            EST_STATUS = 'EST020',
            SEND_DT = NOW(),
            MAIL_BOX_SEQ = #{MAIL_BOX_SEQ},
            UPDATE_DT = NOW(),
            UPDATE_ID = NULL
        WHERE EST_SEQ = #{EST_SEQ}
    </update>

    <update id="updateEstimateMasterSend" parameterType="java.util.HashMap">
        UPDATE TBL_ESTIMATE
        SET
            SEND_DT = NOW(),
            MAIL_BOX_SEQ = #{MAIL_BOX_SEQ},
            UPDATE_DT = NOW(),
            UPDATE_ID = NULL
        WHERE EST_SEQ = #{EST_SEQ}
    </update>
    <select id="selectEstimateInfoFromControl" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.COMP_CD, <!-- 사업자(공급사) -->
            A.ORDER_STAFF_SEQ, <!-- 구매 담당자 -->
            A.ORDER_COMP_CD, <!-- 발주사 -->
            DATE_FORMAT(A.STATUS_DT, '%Y-%m-%d %T') INSERT_DT, <!-- 수정일시 -->
            COUNT(A.CONTROL_SEQ) AS DTL_CNT,
            SUM(B.UNIT_FINAL_EST_AMT) AS DTL_AMOUNT, <!-- 견적금액 -->
            (SELECT TEMPLATE_CONTENT FROM TBL_MAIL_TEMPLATE WHERE TEMPLATE_SEQ = 0) AS EMAIL_CONTENT
        FROM TBL_CONTROL A
            INNER JOIN TBL_CONTROL_PART B ON A.CONTROL_SEQ = B.CONTROL_SEQ
        WHERE
            A.CONTROL_SEQ IN (${CONTROL_SEQ})
        GROUP BY  A.COMP_CD, A.ORDER_COMP_CD, A.ORDER_STAFF_SEQ
    </select>

    <select id="selectEstimateListFromControl" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            ROW_NUMBER() OVER() AS ROWNUM,
            A.PROJECT_NM,
            A.MODULE_NM,
            B.ITEM_NM,
            B.DRAWING_NUM,
            B.PART_NUM,
            B.SIZE_TXT,
            B.WORK_TYPE,
            SF_GET_CODE_NM(1033, B.WORK_TYPE, 'EN') AS WORK_TYPE_NM,
            B.MATERIAL_TYPE,
            SF_GET_CODE_NM(1035, B.MATERIAL_TYPE, 'EN') AS MATERIAL_TYPE_NM,
            B.MATERIAL_DETAIL,
            SF_GET_CODE_NM(1027, B.MATERIAL_DETAIL, 'EN') AS MATERIAL_DETAIL_NM,
            B.MATERIAL_KIND,
            SF_GET_CODE_NM(1029, B.MATERIAL_KIND, 'EN') AS MATERIAL_KIND_NM,
            B.SURFACE_TREAT,
            SF_GET_CODE_NM(1039, B.SURFACE_TREAT, 'EN') AS SURFACE_TREAT_NM,
            B.MATERIAL_NOTE,
            B.DETAIL_LATHE,
            B.DETAIL_SURFACE,
            B.DETAIL_CLAMPING,
            B.DETAIL_POCKET,
            B.DETAIL_DRILL,
            B.DETAIL_DIFFICULTY,
            B.MATERIAL_FINISH_TM,
            B.MATERIAL_FINISH_GRIND,
            B.MATERIAL_FINISH_HEAT,
            B.UNIT_MATERIAL_AMT,
            B.UNIT_TM_AMT,
            B.UNIT_GRIND_AMT,
            B.UNIT_HEAT_AMT,
            B.UNIT_SURFACE_AMT,
            B.UNIT_PROCESS_AMT,
            B.UNIT_ETC_AMT,
            B.UNIT_MATERIAL_AUTO_YN,
            B.UNIT_TM_AUTO_YN,
            B.UNIT_GRIND_AUTO_YN,
            B.UNIT_HEAT_AUTO_YN,
            B.UNIT_SURFACE_AUTO_YN,
            B.UNIT_PROCESS_AUTO_YN,
            B.UNIT_AMT_NOTE,
            B.UNIT_FINAL_EST_AMT,
            A.NOTE, -- NOTE
            B.DWG_GFILE_SEQ,
            B.DXF_GFILE_SEQ,
            B.PDF_GFILE_SEQ,
            B.IMG_GFILE_SEQ,
            IFNULL(B.UNIT_MATERIAL_AMT, 0) + IFNULL(B.UNIT_TM_AMT, 0) + IFNULL(B.UNIT_GRIND_AMT, 0) + IFNULL(B.UNIT_HEAT_AMT, 0) + IFNULL(B.UNIT_SURFACE_AMT, 0) + IFNULL(B.UNIT_PROCESS_AMT, 0) + IFNULL(B.UNIT_ETC_AMT, 0) AS CALCUL_EST_UNIT_COST,
            CASE
                WHEN B.UNIT_FINAL_EST_AMT IS NOT NULL THEN IFNULL(B.UNIT_FINAL_EST_AMT, 0) * IFNULL(C.ORDER_QTY, 0)
                ELSE (IFNULL(B.UNIT_MATERIAL_AMT, 0) + IFNULL(B.UNIT_TM_AMT, 0) + IFNULL(B.UNIT_GRIND_AMT, 0) + IFNULL(B.UNIT_HEAT_AMT, 0) + IFNULL(B.UNIT_SURFACE_AMT, 0) + IFNULL(B.UNIT_PROCESS_AMT, 0) + IFNULL(B.UNIT_ETC_AMT, 0)) * IFNULL(C.ORDER_QTY, 0)
            END AS DTL_AMOUNT
        FROM TBL_CONTROL A
            INNER JOIN TBL_CONTROL_PART B ON A.CONTROL_SEQ = B.CONTROL_SEQ
            INNER JOIN TBL_CONTROL_PART_ORDER C ON B.CONTROL_SEQ = C.CONTROL_SEQ
                                                   AND B.CONTROL_DETAIL_SEQ = C.CONTROL_DETAIL_SEQ
        WHERE A.CONTROL_SEQ IN (${CONTROL_SEQ})
    </select>

    <select id="selectEstimateReceiverListFromControl" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.STAFF_SEQ,
            A.STAFF_NM AS RECEIVER_NM,
            A.STAFF_EMAIL AS RECEIVER_EMAIL,
            A.STAFF_TEL AS RECEIVER_TEL
        FROM  TBL_COMPANY_STAFF A
            INNER JOIN TBL_CONTROL B ON A.STAFF_SEQ = B.ORDER_STAFF_SEQ
        WHERE A.CONTROL_SEQ IN (${CONTROL_SEQ})
    </select>

</mapper>