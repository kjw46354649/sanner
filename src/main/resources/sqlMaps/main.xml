<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="main">

    <select id="selectMainTodayMCTList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            ROW_NUMBER() OVER() AS ROW_NUM,
            A.CONTROL_SEQ, B.CONTROL_DETAIL_SEQ,
            CASE WHEN A.EMERGENCY_YN = 'Y' THEN 'ê¸´' ELSE '' END EMERGENCY_YN_NM,
            '' as FAIL_STATUS,
            SF_GET_DATE_F(B.INNER_DUE_DT, '', '') as INNER_DUE_DT,
            F.EQUIP_SEQ AS LAST_MCT_PLAN,
            A.ORDER_COMP_CD, SF_GET_COMP_NM(A.ORDER_COMP_CD) AS ORDER_COMP_NM,
            A.CONTROL_NUM, B.PART_NUM, B.MATERIAL_TYPE,
            IFNULL(SF_GET_CODE_NM(1035, B.MATERIAL_TYPE, #{LOGIN_LOCALE}), SPACE(0)) AS MATERIAL_TYPE_NM,
            CASE WHEN B.PART_NUM IS NOT NULL THEN B.PART_UNIT_QTY * SF_GET_CONTROL_ORDER_QTY(A.CONTROL_SEQ, '') ELSE C.ORDER_QTY END AS ORDER_QTY,
            SF_GET_DATE_F(B.INNER_WORK_FINISH_DT, '', '') as LAST_PRODUCT_COMPLETE_DT,
            -- CASE WHEN D.POP_POSITION = 'POP100' THEN DATE_FORMAT(STR_TO_DATE(D.POP_DT, '%Y%m%d'), '%Y-%m-%d') ELSE NULL END AS LAST_PRODUCT_COMPLETE_DT,
            D.POP_POSITION_NM AS LAST_POP_POSITION,
            SF_GET_CODE_NM('1013', B.PART_STATUS, #{LOGIN_LOCALE}) AS PART_STATUS,
            A.DELIVERY_COMP_NM
        FROM TBL_CONTROL A
            INNER JOIN TBL_CONTROL_PART B ON A.CONTROL_SEQ = B.CONTROL_SEQ
                <choose>
                    <when  test="NOTEXISTS_INNER_WORK_FINISH_DT_CHK !='' and NOTEXISTS_INNER_WORK_FINISH_DT_CHK != null">
                        AND (
                            (B.INNER_DUE_DT = STR_TO_DATE(#{INNER_DUE_DT}, '%Y/%m/%d') AND B.INNER_WORK_FINISH_DT IS NULL)
                            OR
                            (B.INNER_DUE_DT <![CDATA[ <= ]]> STR_TO_DATE(#{INNER_DUE_DT}, '%Y/%m/%d') AND IFNULL(A.EMERGENCY_YN, 'N') = 'Y'
                                AND B.INNER_WORK_FINISH_DT IS NULL)
                        )
                    </when>
                    <otherwise>
                        AND (
                            (B.INNER_DUE_DT = STR_TO_DATE(#{INNER_DUE_DT}, '%Y/%m/%d'))
                            OR
                            (B.INNER_DUE_DT <![CDATA[ <= ]]> STR_TO_DATE(#{INNER_DUE_DT}, '%Y/%m/%d') AND IFNULL(A.EMERGENCY_YN, 'N') = 'Y'
                                AND B.INNER_WORK_FINISH_DT IS NULL)
                        )
                    </otherwise>
                </choose>
                <if test="MATERIAL_TYPE != null and MATERIAL_TYPE != ''">
                    AND B.MATERIAL_TYPE = #{MATERIAL_TYPE}
                </if>
            INNER JOIN TBL_CONTROL_PART_ORDER C ON B.CONTROL_SEQ = C.CONTROL_SEQ AND B.CONTROL_DETAIL_SEQ = C.CONTROL_DETAIL_SEQ
            LEFT OUTER JOIN TBL_POP_VIEW D ON B.CONTROL_SEQ = D.CONTROL_SEQ AND B.CONTROL_DETAIL_SEQ = D.CONTROL_DETAIL_SEQ
                AND D.POP_VSEQ = (SELECT MAX(E.POP_VSEQ) FROM TBL_POP_VIEW E WHERE E.CONTROL_SEQ = D.CONTROL_SEQ AND E.CONTROL_DETAIL_SEQ = D.CONTROL_DETAIL_SEQ)
            LEFT OUTER JOIN TBL_MCT_PLAN F ON B.CONTROL_SEQ = F.CONTROL_SEQ AND B.CONTROL_DETAIL_SEQ = F.CONTROL_DETAIL_SEQ AND F.DEL_YN = 'N'
                AND F.MCT_PLAN_SEQ = (SELECT MAX(G.MCT_PLAN_SEQ) FROM TBL_MCT_PLAN G WHERE G.CONTROL_SEQ = F.CONTROL_SEQ AND G.CONTROL_DETAIL_SEQ = F.CONTROL_DETAIL_SEQ )
        WHERE 1 = 1
            AND A.DEL_YN = 'N'
            <if test="ORDER_COMP_CD != null and ORDER_COMP_CD != ''">
                AND A.ORDER_COMP_CD = #{ORDER_COMP_CD}
            </if>
            <!-- AND NOT EXISTS (SELECT * FROM TBL_OUT H WHERE H.CONTROL_SEQ = B.CONTROL_SEQ AND H.CONTROL_DETAIL_SEQ = B.CONTROL_DETAIL_SEQ AND OUT_DT IS NOT NULL) -->
        ORDER BY A.EMERGENCY_YN DESC, B.INNER_DUE_DT, B.CONTROL_SEQ, B.CONTROL_DETAIL_SEQ
    </select>

</mapper>