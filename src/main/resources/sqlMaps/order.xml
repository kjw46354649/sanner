<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="orderMapper">
    <select id="emptyGrid" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT 1 FROM DUAL WHERE FALSE
    </select>

    <select id="selectControlManageList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            ROW_NUMBER () OVER () AS ROWNUM,
            C.CONTROL_SEQ,
            C.CONTROL_STATUS,
            CP.CONTROL_DETAIL_SEQ,
            CPO.ORDER_SEQ,
            CPRO.SEQ AS CONTROL_PROGRESS_SEQ,
            CPRO.ORDER_STATUS,
            CPPRO.SEQ AS PART_PROGRESS_SEQ,
            CPPRO.PART_STATUS,
            (SELECT CODE_NM
            FROM TBL_CODE_LANG
            WHERE HIGH_CD = '1024'
            AND CODE_CD = C.CONTROL_STATUS
            AND LANG_CD = 'KR') AS ORDER_STATUS_NM,
            DATE_FORMAT(C.STATUS_DT, '%m-%d %H:%i') AS ORDER_STATUS_DT,
            C.COMP_CD,
            (SELECT CODE_NM
            FROM TBL_CODE_LANG
            WHERE CODE_CD = C.COMP_CD
            AND LANG_CD = 'KR') AS COMP_NM,
            C.ORDER_COMP_CD, -- 발주업체
            (SELECT COMP_NM
             FROM TBL_COMPANY
             WHERE COMP_CD = C.ORDER_COMP_CD) AS ORDER_COMP_NM, -- 발주업체이름(JOIN)
            C.ORDER_STAFF_SEQ,
            (SELECT STAFF_NM
             FROM TBL_COMPANY_STAFF
             WHERE STAFF_SEQ = C.ORDER_STAFF_SEQ) AS ORDER_STAFF_NM,
            C.DESIGNER_NM, -- 설계자
            C.NOTE, -- 비고
            --        '',-- 거래명세서 no ㅇㄷ?
            C.MODULE_NM,--  모듈명
            C.MAIN_INSPECTION_YN, -- 주요 검사품
            SF_GET_CODE_NM(1045, C.MAIN_INSPECTION_YN, 'EN') AS MAIN_INSPECTION_YN_NM,
            C.EMERGENCY_YN, -- 긴급
            SF_GET_CODE_NM(1045, C.EMERGENCY_YN, 'EN') AS EMERGENCY_YN_NM,
            C.CONTROL_NUM,
            CP.PART_NUM,
            CP.DRAWING_VER,
            CP.DRAWING_NUM,
            CP.ITEM_NM,
            CP.WORK_TYPE,
            (SELECT CODE_NM
            FROM TBL_CODE_LANG
            WHERE HIGH_CD = '1013'
            AND CODE_CD = CP.WORK_TYPE
            AND LANG_CD = 'KR') AS WORK_NM,
            CP.OUTSIDE_YN,
            CP.WORK_FACTORY,
            CP.MATERIAL_SUPPLY_YN,
            CP.INNER_DUE_DT, -- '', 가공 납기
            CP.SIZE_TXT, -- 규격
            CP.MATERIAL_DETAIL,
            CP.MATERIAL_KIND,
            CP.MATERIAL_TYPE,
            CP.SURFACE_TREAT,
            CP.MATERIAL_FINISH_HEAT,
            CP.PART_UNIT_QTY,
            CPO.ORDER_NUM,
            CPO.ORDER_QTY,
            CP.ORIGINAL_SIDE_QTY,
            CP.OTHER_SIDE_QTY,
            CPO.ORDER_DUE_DT, -- 발주납기
            CP.INNER_DUE_DT, -- 납기(가공납기)
            CPO.DELIVERY_DT,
            CP.DETAIL_LATHE,
            CP.DETAIL_SURFACE,
            CP.DETAIL_CLAMPING,
            CP.DETAIL_POCKET,
            CP.DETAIL_DRILL,
            CP.DETAIL_DIFFICULTY,
            CP.PREV_DRAWING_NUM,
            DATE_FORMAT(C.STATUS_DT, '%m-%d %H:%i') AS STATUS_DT
        FROM TBL_CONTROL C
        LEFT OUTER JOIN TBL_CONTROL_PROGRESS CPRO ON C.CONTROL_SEQ = CPRO.CONTROL_SEQ
        INNER JOIN TBL_CONTROL_PART CP ON C.CONTROL_SEQ = CP.CONTROL_SEQ
        LEFT OUTER JOIN TBL_CONTROL_PART_PROGRESS CPPRO ON C.CONTROL_SEQ = CPPRO.CONTROL_SEQ
                                                           AND CP.CONTROL_DETAIL_SEQ = CPPRO.CONTROL_DETAIL_SEQ
        INNER JOIN TBL_CONTROL_PART_ORDER CPO ON CP.CONTROL_SEQ = CPO.CONTROL_SEQ
                                                 AND CP.CONTROL_DETAIL_SEQ = CPO.CONTROL_DETAIL_SEQ
        WHERE 1 = 1
        <if test="CONTROL_NUMBER != null and CONTROL_NUMBER != ''">
             AND C.CONTROL_NUM = #{CONTROL_NUMBER}
        </if>
        <if test="CORPORATION != null and CORPORATION != ''">
             AND C.COMP_CD = #{CORPORATION}
        </if>
        <if test="DRAWING_NUMBER != null and DRAWING_NUMBER != ''">
             AND CP.DRAWING_NUM = #{DRAWING_NUMBER}
        </if>
        <if test="PRODUCT_NAME != null and PRODUCT_NAME != ''">
             AND CP.ITEM_NM = #{PRODUCT_NAME}
        </if>
        <if test="WORK_TYPE != null and WORK_TYPE != ''">
             AND CP.WORK_TYPE = #{WORK_TYPE}
        </if>
        <if test="ORDER_NUMBER != null and ORDER_NUMBER != ''">
             AND CPO.ORDER_NUM = #{ORDER_NUMBER}
        </if>
        <if test="ORDER_STATUS != null and ORDER_STATUS != ''">
             AND CPRO.ORDER_STATUS = #{ORDER_STATUS}
        </if>
        <if test="OUTSIDE_YN != null and OUTSIDE_YN != ''">
            AND CP.OUTSIDE_YN NOT IN ('Y')
        </if>
        ORDER BY C.CONTROL_SEQ, CP.PART_NUM
    </select>

    <insert id="insertControlMaster" parameterType="java.util.HashMap" >
        INSERT IGNORE INTO TBL_CONTROL (
            CONTROL_SEQ,
            CONTROL_NUM,
            CONTROL_VER,
            COMP_CD,
            ORDER_COMP_CD,
            ORDER_STAFF_SEQ,
            DESIGNER_NM,
            NOTE,
            MODULE_NM,
            MAIN_INSPECTION_YN,
            EMERGENCY_YN,
            CONTROL_STATUS,
            STATUS_DT,
            INSERT_DT
            <!-- ,INSERT_ID -->
        ) VALUES
        <foreach collection="list" item="item" separator=",">
        (
            (SELECT IFNULL(max(A.CONTROL_SEQ), NEXT VALUE FOR SEQ_CONTROL)
            FROM TBL_CONTROL A
            WHERE A.CONTROL_NUM = #{item.CONTROL_NUM}),
            #{item.CONTROL_NUM},
            0,
            (SELECT CODE_CD
            FROM TBL_CODE_LANG
            WHERE HIGH_CD = '1007'
            AND LANG_CD = 'KR'
            AND CODE_NM = #{item.COMP_NM}),
            (SELECT COMP_CD
            FROM TBL_COMPANY
            WHERE COMP_NM = #{item.COMP_NM}),
            (SELECT STAFF_SEQ
            FROM TBL_COMPANY_STAFF
            WHERE STAFF_NM = #{item.ORDER_STAFF_NM}
            AND COMP_CD IN (SELECT COMP_CD
            FROM TBL_COMPANY
            WHERE COMP_NM = #{item.COMP_NM})), -- ORDER_STAFF_SEQ
            #{item.DESIGNER_NM},
            #{item.NOTE},
            #{item.MODULE_NM},
            #{item.MAIN_INSPECTION_YN},
            #{item.EMERGENCY_YN},
            #{item.CONTROL_STATUS},
            CURRENT_TIMESTAMP(),
            CURRENT_TIMESTAMP()
            <!-- ,NULL -->
            )
        </foreach>
    </insert>

    <insert id="insertControlPart" parameterType="java.util.HashMap" >
        INSERT INTO TBL_CONTROL_PART (
            CONTROL_SEQ,
            CONTROL_DETAIL_SEQ,
            PART_NUM,
            DRAWING_NUM,
            DRAWING_VER,
            PREV_DRAWING_NUM,
            ITEM_NM,
            WORK_TYPE,
            OUTSIDE_YN,
            WORK_FACTORY,
            MATERIAL_SUPPLY_YN,
            <!-- SIZE_TYPE, -->
            <!-- SIZE_W, -->
            <!-- SIZE_H, -->
            <!-- SIZE_T, -->
            <!-- SIZE_D, -->
            <!-- SIZE_L, -->
            MATERIAL_TYPE,
            MATERIAL_DETAIL,
            SURFACE_TREAT,
            MATERIAL_FINISH_HEAT,
            PART_UNIT_QTY,
            INNER_DUE_DT,
            ORIGINAL_SIDE_QTY,
            OTHER_SIDE_QTY,
            UNIT_FINAL_EST_AMT,
            UNIT_FINAL_AMT,
            INSERT_DT
        ) VALUES
        <foreach collection="list" item="item" separator=",">
        (
            (SELECT CONTROL_SEQ
            FROM TBL_CONTROL
            WHERE CONTROL_NUM = #{item.CONTROL_NUM}),
            NEXT VALUE FOR SEQ_CONTROL_PART,
            (SELECT IF(#{item.PART_NUM} = '', 0, CAST(#{item.PART_NUM} AS UNSIGNED INTEGER))),
            #{item.DRAWING_NUM},
            0,
            #{item.PREV_DRAWING_NUM},
            #{item.ITEM_NM},
            (SELECT CODE_CD
            FROM TBL_CODE_LANG
            WHERE HIGH_CD = '1013'
            AND LANG_CD = 'KR'
            AND CODE_NM = #{item.WORK_NM}),
            #{item.OUTSIDE_YN},
            #{item.WORK_FACTORY},
            #{item.MATERIAL_SUPPLY_YN},
            <!-- NULL, -->
            <!-- NULL, -->
            <!-- NULL, -->
            <!-- NULL, -->
            <!-- NULL, -->
            <!-- NULL, -->
            #{item.MATERIAL_TYPE},
            #{item.MATERIAL_DETAIL},
            #{item.SURFACE_TREAT},
            #{item.MATERIAL_FINISH_HEAT},
            (SELECT IF(#{item.PART_UNIT_QTY} = '', NULL, CAST(#{item.PART_UNIT_QTY} AS UNSIGNED INTEGER))),
            #{item.INNER_DUE_DT},
            (SELECT IF(#{item.ORIGINAL_SIDE_QTY} = '', NULL, CAST(#{item.ORIGINAL_SIDE_QTY} AS UNSIGNED INTEGER))),
            (SELECT IF(#{item.OTHER_SIDE_QTY} = '', NULL, CAST(#{item.OTHER_SIDE_QTY} AS UNSIGNED INTEGER))),
            (SELECT IF(#{item.UNIT_FINAL_EST_AMT} = '', NULL, CAST(REPLACE(#{item.UNIT_FINAL_EST_AMT}, ',', '') AS UNSIGNED INTEGER))),
            (SELECT IF(#{item.UNIT_FINAL_AMT} = '', NULL, CAST(REPLACE(#{item.UNIT_FINAL_AMT}, ',', '') AS UNSIGNED INTEGER))),
            CURRENT_TIMESTAMP()
            )
        </foreach>
    </insert>

    <insert id="insertControlPartOrder" parameterType="java.util.HashMap" >
        INSERT INTO TBL_CONTROL_PART_ORDER (
            CONTROL_SEQ,
            CONTROL_DETAIL_SEQ,
            ORDER_SEQ,
            ORDER_NUM,
            ORDER_QTY,
            DELIVERY_DT,
            INSERT_DT
            <!-- ,INSERT_ID -->
        ) VALUES
        <foreach collection="list" item="item" separator=",">
        (
            (SELECT CONTROL_SEQ
             FROM TBL_CONTROL A
             WHERE A.CONTROL_NUM = #{item.CONTROL_NUM}),
            (SELECT CP.CONTROL_DETAIL_SEQ
             FROM TBL_CONTROL_PART CP
             INNER JOIN TBL_CONTROL C ON CP.CONTROL_SEQ = C.CONTROL_SEQ
             WHERE C.CONTROL_NUM = #{item.CONTROL_NUM}
                   AND CP.CONTROL_DETAIL_SEQ NOT IN (SELECT CONTROL_DETAIL_SEQ
                                                     FROM TBL_CONTROL_PART_ORDER CPO
                                                     WHERE CPO.CONTROL_SEQ = CP.CONTROL_SEQ)
             ORDER BY CP.CONTROL_DETAIL_SEQ
             LIMIT 1),
            NEXT VALUE FOR SEQ_CONTROL_PART_ORDER,
            #{item.ORDER_NUM},
            (SELECT IF(#{item.ORDER_QTY} = '', NULL, CAST(#{item.ORDER_QTY} AS UNSIGNED INTEGER))),
            #{item.DELIVERY_DT},
            CURRENT_TIMESTAMP()
            <!-- ,NULL -->
        )
        </foreach>
    </insert>

    <insert id="insertControlProgress" parameterType="java.util.HashMap" >
        INSERT IGNORE INTO TBL_CONTROL_PROGRESS (
            CONTROL_SEQ,
            SEQ,
            ORDER_STATUS,
            STATUS_DT,
            INSERT_DT
            <!-- ,INSERT_ID -->
        ) VALUES
        <foreach collection="list" item="item" separator=",">
        (
            (SELECT A.CONTROL_SEQ
             FROM TBL_CONTROL A
             WHERE A.CONTROL_NUM = #{item.CONTROL_NUM}),
            (SELECT IFNULL(max(B.SEQ), NEXT VALUE FOR SEQ_CONTROL_PROGRESS)
            FROM TBL_CONTROL_PROGRESS B
            INNER JOIN TBL_CONTROL C ON B.CONTROL_SEQ = C.CONTROL_SEQ
             WHERE C.CONTROL_NUM = #{item.CONTROL_NUM}),
            'PRO00',
            CURRENT_TIMESTAMP(),
            CURRENT_TIMESTAMP()
            <!-- ,NULL -->
        )
        </foreach>
    </insert>

    <insert id="insertControlPartProgress" parameterType="java.util.HashMap" >
        INSERT IGNORE INTO TBL_CONTROL_PART_PROGRESS (
            CONTROL_SEQ,
            CONTROL_DETAIL_SEQ,
            SEQ,
            PART_STATUS,
            STATUS_DT,
            INSERT_DT
        <!-- ,INSERT_ID, -->
        ) VALUES
        <foreach collection="list" item="item" separator=",">
        (
            (SELECT A.CONTROL_SEQ
            FROM TBL_CONTROL A
            WHERE A.CONTROL_NUM = #{item.CONTROL_NUM}),
            (SELECT B.CONTROL_DETAIL_SEQ
            FROM TBL_CONTROL_PART B
            INNER JOIN TBL_CONTROL C ON B.CONTROL_SEQ = C.CONTROL_SEQ
            WHERE C.CONTROL_NUM = #{item.CONTROL_NUM}
            AND B.CONTROL_DETAIL_SEQ NOT IN (SELECT D.CONTROL_DETAIL_SEQ
            FROM TBL_CONTROL_PART_PROGRESS D
            WHERE D.CONTROL_SEQ = B.CONTROL_SEQ)
            ORDER BY B.CONTROL_DETAIL_SEQ
            LIMIT 1),
            (SELECT IFNULL(max(E.SEQ), NEXT VALUE FOR SEQ_CONTROL_PART_PROGRESS)
            FROM TBL_CONTROL_PART_PROGRESS E
            INNER JOIN TBL_CONTROL F ON E.CONTROL_SEQ = F.CONTROL_SEQ
            WHERE F.CONTROL_NUM = #{item.CONTROL_NUM}),
            'PRO00',
            CURRENT_TIMESTAMP(),
            CURRENT_TIMESTAMP()
        )
        </foreach>
    </insert>

    <insert id="insertControlProgressConfirm" parameterType="java.util.HashMap" >
        INSERT IGNORE INTO TBL_CONTROL_PROGRESS (
            CONTROL_SEQ,
            SEQ,
            ORDER_STATUS,
            STATUS_DT,
            INSERT_DT
            <!-- ,INSERT_ID -->
        ) VALUES
        <foreach collection="list" item="item" separator=",">
        (
            (SELECT A.CONTROL_SEQ
             FROM TBL_CONTROL A
             WHERE A.CONTROL_NUM = #{item.CONTROL_NUM}),
            (SELECT IFNULL(max(B.SEQ), NEXT VALUE FOR SEQ_CONTROL_PROGRESS)
            FROM TBL_CONTROL_PROGRESS B
            INNER JOIN TBL_CONTROL C ON B.CONTROL_SEQ = C.CONTROL_SEQ
             WHERE C.CONTROL_NUM = #{item.CONTROL_NUM}),
            'PRO01',
            CURRENT_TIMESTAMP(),
            CURRENT_TIMESTAMP()
            <!-- ,NULL -->
        )
        </foreach>
    </insert>

    <insert id="insertControlPartProgressConfirm" parameterType="java.util.HashMap" >
        INSERT IGNORE INTO TBL_CONTROL_PART_PROGRESS (
            CONTROL_SEQ,
            CONTROL_DETAIL_SEQ,
            SEQ,
            PART_STATUS,
            STATUS_DT,
            INSERT_DT
        <!-- ,INSERT_ID, -->
        ) VALUES
        <foreach collection="list" item="item" separator=",">
        (
            (SELECT A.CONTROL_SEQ
            FROM TBL_CONTROL A
            WHERE A.CONTROL_NUM = #{item.CONTROL_NUM}),
            (SELECT B.CONTROL_DETAIL_SEQ
            FROM TBL_CONTROL_PART B
            INNER JOIN TBL_CONTROL C ON B.CONTROL_SEQ = C.CONTROL_SEQ
            WHERE C.CONTROL_NUM = #{item.CONTROL_NUM}
            AND B.CONTROL_DETAIL_SEQ NOT IN (SELECT D.CONTROL_DETAIL_SEQ
            FROM TBL_CONTROL_PART_PROGRESS D
            WHERE D.CONTROL_SEQ = B.CONTROL_SEQ)
            ORDER BY B.CONTROL_DETAIL_SEQ
            LIMIT 1),
            (SELECT IFNULL(max(E.SEQ), NEXT VALUE FOR SEQ_CONTROL_PART_PROGRESS)
            FROM TBL_CONTROL_PART_PROGRESS E
            INNER JOIN TBL_CONTROL F ON E.CONTROL_SEQ = F.CONTROL_SEQ
            WHERE F.CONTROL_NUM = #{item.CONTROL_NUM}),
            'PRO01',
            CURRENT_TIMESTAMP(),
            CURRENT_TIMESTAMP()
        )
        </foreach>
    </insert>

    <update id="updateControlMaster" parameterType="java.util.HashMap">
        UPDATE TBL_CONTROL
        SET
            CONTROL_NUM = #{CONTROL_NUM},
            CONTROL_VER = #{CONTROL_VER},
            COMP_CD = #{COMP_CD},
            ORDER_COMP_CD = #{ORDER_COMP_CD},
            ORDER_STAFF_SEQ = #{ORDER_STAFF_SEQ},
            DESIGNER_NM = #{DESIGNER_NM},
            NOTE = #{NOTE},
            MODULE_NM = #{MODUL_NM},
            MAIN_INSPECTION_YN = #{MAIN_INSPECTION_YN},
            EMERGENCY_YN = #{EMERENCY_YN},
            CONTROL_STATUS = #{CONTROL_STATUS},
            STATUS_DT = CURRENT_TIMESTAMP(),
            UPDATE_DT = CURRENT_TIMESTAMP()
            <!-- ,UPDATE_ID = NULL -->
        WHERE
            CONTROL_SEQ = #{CONTROL_SEQ}
    </update>

    <update id="updateControlPart" parameterType="java.util.HashMap">
        UPDATE
            TBL_CONTROL_PART
        SET
            PART_NUM = #{PART_NUM},
            DRAWING_NUM = #{DRAWING_NUM},
            DRAWING_VER = #{DRAWING_VER},
            PREV_DRAWING_NUM = #{PREV_DRAWING_NUM},
            ITEM_NM = #{ITEM_NM},
            WORK_TYPE = #{WORK_TYPE},
            OUTSIDE_YN = #{OUTSIDE_YN},
            WORK_FACTORY = #{WORK_FACTORY},
            MATERIAL_SUPPLY_YN = #{MATERIAL_SUPPLY_YN},
            <!-- MATERIAL_KIND = #{MATERIAL_KIND}, -->
        <!--SIZE_W = #{SIZE_W},-->
        <!--SIZE_H = #{SIZE_H},-->
            <!--SIZE_T = #{SIZE_T},-->
            <!--SIZE_D = #{SIZE_D},-->
            <!--SIZE_L = #{SIZE_L},-->
            MATERIAL_TYPE = #{MATERIAL_TYPE},
            MATERIAL_DETAIL = #{MATERIAL_DETAIL},
            SURFACE_TREAT = #{SURFACE_TREAT},
            HEAT_TREAT_YN = #{HEAT_TREAT_YN},
            <!-- PART_UNIT_QTY = #{PART_UNIT_QTY}, -->
            HOPE_DUE_DT = #{HOPE_DUE_DT},
            INNER_DUE_DT = #{INNER_DUE_DT},
            ORIGINAL_SIDE_QTY = #{ORIGINAL_SIDE_QTY},
            OTHER_SIDE_QTY = #{OTHER_SIDE_QTY},
            PART_STATUS = #{PART_STATUS},
            STATUS_DT = CURRENT_TIMESTAMP(),
            UPDATE_DT = CURRENT_TIMESTAMP()
            <!--              ,UPDATE_ID #{UPDATE_ID} -->
        WHERE
            CONTROL_SEQ = #{CONTROL_SEQ}
                AND CONTROL_DETAIL_SEQ = #{CONTROL_DETAIL_SEQ}
    </update>

    <select id="selectConfirmOrderList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            ROW_NUMBER () OVER () AS ROWNUM,
            C.CONTROL_SEQ,
            C.CONTROL_STATUS,
            CP.CONTROL_DETAIL_SEQ,
            CPPRO.SEQ AS PART_PROGRESS_SEQ,
            CPRO.ORDER_STATUS, -- 주문 상태
            (SELECT CODE_NM
             FROM TBL_CODE_LANG
             WHERE HIGH_CD = '1024'
             AND CODE_CD = CPRO.ORDER_STATUS
             AND LANG_CD = 'KR') AS ORDER_STATUS_NM, -- 주문 상태
            CPRO.STATUS_DT AS ORDER_STATUS_DT, -- 변경 일시
            C.ORDER_COMP_CD, -- 발주업체
            (SELECT COMP_NM
             FROM TBL_COMPANY
             WHERE COMP_CD = C.ORDER_COMP_CD) AS ORDER_COMP_NM, -- 발주업체
            C.CONTROL_SEQ, -- 관리번호
            CP.PART_NUM, -- Part
            CP.WORK_FACTORY, -- 수행 공장
            CP.MATERIAL_SUPPLY_YN, -- 자재 사급
            CPO.ORDER_DUE_DT, -- 납기
            CP.INNER_DUE_DT, -- 가공납기
            C.EMERGENCY_YN, -- 긴급
            C.MAIN_INSPECTION_YN, -- 주요
            CP.WORK_TYPE, -- 형태
            CP.SIZE_TXT,-- 규격
            CP.MATERIAL_DETAIL, -- 소재종류
            CP.SURFACE_TREAT, -- 표면처리
            CP.MATERIAL_FINISH_HEAT, -- 열처리
            C.NOTE -- 비고
        FROM
            TBL_CONTROL C
        LEFT OUTER JOIN TBL_CONTROL_PROGRESS CPRO ON C.CONTROL_SEQ = CPRO.CONTROL_SEQ
        INNER JOIN TBL_CONTROL_PART CP ON C.CONTROL_SEQ = CP.CONTROL_SEQ
        INNER JOIN TBL_CONTROL_PART_ORDER CPO ON CP.CONTROL_SEQ = CPO.CONTROL_SEQ
                                                 AND CP.CONTROL_DETAIL_SEQ = CP.CONTROL_DETAIL_SEQ
        LEFT OUTER JOIN TBL_CONTROL_PART_PROGRESS CPPRO ON CPO.CONTROL_SEQ = CPPRO.CONTROL_SEQ
                                                           AND CPO.CONTROL_DETAIL_SEQ = CPPRO.CONTROL_DETAIL_SEQ
        WHERE 1 = 1
            AND CP.OUTSIDE_YN NOT IN ('Y')
        <if test="ORDER_COMP_CD != null and ORDER_COMP_CD != ''">
            AND C.ORDER_COMP_CD = #{ORDER_COMP_CD}
        </if>
        <if test="MATERIAL_TYPE != null and MATERIAL_TYPE != ''">
        	AND CP.MATERIAL_TYPE = #{MATERIAL_TYPE}
        </if>
        GROUP BY
            CP.CONTROL_DETAIL_SEQ
        ORDER BY
        <if test="EMERGENCY_YN != null and EMERGENCY_YN != ''">
            C.EMERGENCY_YN DESC,
        </if>
            C.CONTROL_SEQ,
            CP.PART_NUM,
            CPO.ORDER_DUE_DT
    </select>

    <update id="updateControlStatus" parameterType="java.util.HashMap">
        UPDATE
            TBL_CONTROL
        SET
            CONTROL_STATUS = #{CONTROL_STATUS},
            STATUS_DT = CURRENT_TIMESTAMP(),
            UPDATE_DT = CURRENT_TIMESTAMP()
        WHERE
            CONTROL_SEQ = #{CONTROL_SEQ}
    </update>

    <update id="updateControlPartStatus" parameterType="java.util.HashMap">
        UPDATE
            TBL_CONTROL_PART
        SET
            PART_STATUS = #{PART_STATUS},
            STATUS_DT = CURRENT_TIMESTAMP(),
            UPDATE_DT = CURRENT_TIMESTAMP()
        WHERE
            CONTROL_SEQ = #{CONTROL_SEQ}
            AND CONTROL_DETAIL_SEQ  = #{CONTROL_DETAIL_SEQ}
    </update>

    <update id="updateControlPartProgressStatus" parameterType="java.util.HashMap">
        UPDATE
            TBL_CONTROL_PART_PROGRESS
        SET
            PART_STATUS = #{PART_STATUS},
            STATUS_DT = CURRENT_TIMESTAMP(),
            UPDATE_DT = CURRENT_TIMESTAMP()
        WHERE
            CONTROL_SEQ = #{CONTROL_SEQ}
            AND CONTROL_DETAIL_SEQ  = #{CONTROL_SEQ}
            AND SEQ = #{PART_PROGRESS_SEQ}
    </update>

    <select id="selectProcessConfirmList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            ROW_NUMBER () OVER () AS ROWNUM,
            C.CONTROL_SEQ,
            C.CONTROL_STATUS,
            CP.CONTROL_DETAIL_SEQ,
            CPPRO.SEQ AS PART_PROGRESS_SEQ,
            C.ORDER_COMP_CD, <!-- 발주업체 -->
            (SELECT COMP_NM
            FROM TBL_COMPANY
            WHERE COMP_CD = C.ORDER_COMP_CD) AS ORDER_COMP_NM, <!-- 발주업체이름 -->
            C.CONTROL_NUM, <!-- 관리번호 -->
            CP.PART_NUM, <!-- Part -->
            CP.WORK_FACTORY, <!-- 수행공장 -->
            CP.MATERIAL_SUPPLY_YN, <!-- 자재사급 -->
            CPO.ORDER_DUE_DT, <!-- 요망납기 -->
            CP.INNER_DUE_DT, <!-- 가공납기 -->
            C.EMERGENCY_YN, <!-- 긴급 -->
            C.MAIN_INSPECTION_YN, <!-- 주요 -->
            CP.WORK_TYPE, <!-- 형태 -->
            (SELECT CODE_NM
            FROM TBL_CODE_LANG
            WHERE HIGH_CD = '1013'
            AND CODE_CD = CP.WORK_TYPE
            AND LANG_CD = 'KR') AS WORK_NM, <!-- 형태이름 -->
            CP.SIZE_TXT, <!-- 규격 -->
            CP.MATERIAL_KIND, <!-- 소재 종류 -->
            CP.SURFACE_TREAT, <!-- 표면처리 -->
            CP.MATERIAL_FINISH_HEAT, <!-- 열 처리 -->
            CPO.ORDER_QTY, <!-- 주문수량 -->
            CP.STATUS_DT, <!-- 발생일시 -->
            CP.PART_STATUS, <!-- 소재주문 -->
            (SELECT CODE_NM
            FROM TBL_CODE_LANG
            WHERE HIGH_CD = '1024'
            AND CODE_CD = CP.PART_STATUS
            AND LANG_CD = 'KR') AS PART_STATUS_NM <!-- 소재주문 -->
        FROM TBL_CONTROL C
        LEFT OUTER JOIN TBL_CONTROL_PART_PROGRESS CPPRO ON C.CONTROL_SEQ = CPPRO.CONTROL_SEQ
        INNER JOIN TBL_CONTROL_PART CP ON C.CONTROL_SEQ = CP.CONTROL_SEQ
        INNER JOIN TBL_CONTROL_PART_ORDER CPO ON CP.CONTROL_SEQ = CPO.CONTROL_SEQ
                                                 AND CP.CONTROL_DETAIL_SEQ = CPO.CONTROL_DETAIL_SEQ
        WHERE 1 = 1
            AND CPPRO.PART_STATUS IN ('PRO02', 'PRO03')
            AND CP.WORK_TYPE NOT IN ('FCT02')
            AND CP.OUTSIDE_YN NOT IN ('Y')
        <if test="ORDER_COMP_CD != null and ORDER_COMP_CD != ''">
            AND C.ORDER_COMP_CD = #{ORDER_COMP_CD}
        </if>
        <if test="MATERIAL_TYPE != null and MATERIAL_KIND != ''">
            AND CP.MATERIAL_TYPE = #{MATERIAL_TYPE}
        </if>
        ORDER BY
        <if test="EMERGENCY_YN != null and EMERGENCY_YN != ''">
            C.EMERGENCY_YN DESC,
        </if>
            C.CONTROL_SEQ,
            CP.PART_NUM
            <!-- CP.HOPE_DUE_DT -->
    </select>

    <select id="selectOutsourcingProcessingList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            ROW_NUMBER () OVER () AS ROWNUM,
            C.CONTROL_SEQ,
            C.CONTROL_STATUS,
            CP.CONTROL_DETAIL_SEQ,
            CPPRO.SEQ AS PART_PROGRESS_SEQ,
            C.ORDER_COMP_CD, <!-- 발주업체 -->
            (SELECT COMP_NM
            FROM TBL_COMPANY
            WHERE COMP_CD = C.ORDER_COMP_CD) AS ORDER_COMP_NM, <!-- 발주업체이름 -->
            C.CONTROL_NUM, <!-- 관리번호 -->
            CP.PART_NUM, <!-- Part -->
            CP.OUTSIDE_COMP_CD, <!-- 외주업체명 -->
            (SELECT COMP_NM
            FROM TBL_COMPANY
            WHERE COMP_CD = CP.OUTSIDE_COMP_CD) AS OUTSIDE_COMP_NM, <!-- 외주업체명 -->
            CP.OUTSIDE_HOPE_DUE_DT, <!-- 외주 요망납기 -->
            CP.MATERIAL_SUPPLY_YN, <!-- 자재사급 -->
            CPO.ORDER_DUE_DT, <!-- 요망납기 -->
            CP.INNER_DUE_DT, <!-- 가공납기 -->
            C.EMERGENCY_YN, <!-- 긴급 -->
            C.MAIN_INSPECTION_YN, <!-- 주요 -->
            CP.WORK_TYPE, <!-- 형태 -->
            (SELECT CODE_NM
            FROM TBL_CODE_LANG
            WHERE HIGH_CD = '1013'
                  AND CODE_CD = CP.WORK_TYPE
                  AND LANG_CD = 'KR') AS WORK_NM, <!-- 형태이름 -->
            CP.SIZE_TXT, <!-- 규격 -->
            CP.MATERIAL_KIND, <!-- 소재 종류 -->
            CP.SURFACE_TREAT, <!-- 표면처리 -->
            CP.MATERIAL_FINISH_HEAT, <!-- 열 처리 -->
            CPO.ORDER_QTY, <!-- 주문수량 -->
            CP.STATUS_DT <!-- 발생일시 -->
        FROM TBL_CONTROL C
        LEFT OUTER JOIN TBL_CONTROL_PART_PROGRESS CPPRO ON C.CONTROL_SEQ = CPPRO.CONTROL_SEQ
        INNER JOIN TBL_CONTROL_PART CP ON C.CONTROL_SEQ = CP.CONTROL_SEQ
        INNER JOIN TBL_CONTROL_PART_ORDER CPO ON CP.CONTROL_SEQ = CPO.CONTROL_SEQ
        AND CP.CONTROL_DETAIL_SEQ = CPO.CONTROL_DETAIL_SEQ
        WHERE 1 = 1
              AND CPPRO.PART_STATUS IN ('PRO01')
              AND CP.WORK_TYPE NOT IN ('FCT02')
              AND CP.OUTSIDE_YN = 'Y'
        <if test="ORDER_COMP_CD != null and ORDER_COMP_CD != ''">
            AND C.ORDER_COMP_CD = #{ORDER_COMP_CD}
        </if>
        <if test="MATERIAL_TYPE != null and MATERIAL_KIND != ''">
            AND CP.MATERIAL_TYPE = #{MATERIAL_TYPE}
        </if>
        ORDER BY
            C.CONTROL_SEQ,
            CP.PART_NUM
            <!-- CP.HOPE_DUE_DT -->
    </select>

    <select id="selectControlCadFiles" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            ROW_NUMBER () OVER () AS ROWNUM,
            C.CONTROL_SEQ,
            C.CONTROL_STATUS,
            B.CONTROL_DETAIL_SEQ,
            C.CONTROL_NUM, <!-- 관리번호 -->
            B.ITEM_NM, <!-- 품명 -->
            B.PART_NUM, <!-- Part -->
            B.DRAWING_NUM,
            #{DWG_GFILE_SEQ} AS DWG_GFILE_SEQ,
            #{DXF_GFILE_SEQ} AS DXF_GFILE_SEQ,
            #{PDF_GFILE_SEQ} AS PDF_GFILE_SEQ,
            #{IMG_GFILE_SEQ} AS IMG_GFILE_SEQ,
            #{DWG_GFILE_SIZE} AS DWG_GFILE_SIZE,
            #{DXF_GFILE_SIZE} AS DXF_GFILE_SIZE,
            #{PDF_GFILE_SIZE} AS PDF_GFILE_SIZE,
            #{IMG_GFILE_SIZE} AS IMG_GFILE_SIZE,
            CASE WHEN C.CONTROL_STATUS = 'PRO01' THEN '확정완료 대상은 업로드 불가'  <!-- 상태완료 이후인 경우는 업로드 불가  -->
                WHEN IMG_GFILE_SEQ IS NOT NULL THEN '이미 등록됨, Save 후 교체됨.'  <!-- 이미 등록된 Save시 교체 진행  -->
                ELSE ''
            END AS UPLOAD_MESSAGE
        FROM TBL_CONTROL C
            INNER JOIN TBL_CONTROL_PART B ON C.CONTROL_SEQ = B.CONTROL_SEQ
        WHERE 1 = 1
            AND IFNULL(C.CONTROL_STATUS, 'PRO00') IN ('PRO01', 'PRO00')
            AND #{ORGINAL_FILE_NM} LIKE CONCAT(B.DRAWING_NUM, '%')
    </select>


</mapper>