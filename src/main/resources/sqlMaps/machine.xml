<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="machine">

    <select id="selectMachineList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT A.EQUIP_ID
            , A.PHOTO_GFILE_SEQ
            , jmes.SF_GET_FILE_ORGINAL_NM(A.PHOTO_GFILE_SEQ, NULL) as PHOTO_GFILE_SEQ_NM
            , A.EQUIP_NM
            , jmes.SF_GET_CODE_NM('1010', A.PROCESS_TYPE, 'KR') AS PROCESS_TYPE_NM
            , jmes.SF_GET_CODE_NM('1012', A.EQUIP_TYPE, 'KR') AS EQUIP_TYPE_NM
            , jmes.SF_GET_CODE_NM('1034', A.EQUIP_SIZE, 'KR') AS EQUIP_SIZE_NM
            , jmes.SF_GET_CODE_NM('1037', A.EQUIP_COMP_CD, 'KR') AS EQUIP_COMP_NM
            , jmes.SF_GET_CODE_NM('1022', A.RESELLER_CD, 'KR') AS RESELLER_NM
            , jmes.SF_GET_CODE_NM('1005', A.FACTORY_AREA, 'KR') AS FACTORY_AREA_NM
            , jmes.SF_GET_CODE_NM('1014', (SELECT REF_CD FROM jmes.TBL_CODE WHERE HIGH_CD = '1005' AND CODE_CD = A.FACTORY_AREA), 'KR') AS FACTORY_NM
            , jmes.SF_GET_DATE_F(A.PURCHASE_DT,'YY','') AS PURCHASE_DT
            , (SELECT USER_NM FROM jmes.TBL_USER WHERE USER_ID = A.MAIN_USER_ID) AS MAIN_USER_NM
            , (SELECT USER_NM FROM jmes.TBL_USER WHERE USER_ID = A.SUB_USER_ID) AS SUB_USER_NM
            , 'AFTER...' AS WORKING_TIME
            , (SELECT jmes.SF_GET_DATE_F(MAX(REPAIR_END_DT),'YY','') FROM jmes.TBL_EQUIP_REPAIR WHERE EQUIP_ID = A.EQUIP_ID) AS LAST_REPAIR_DT
            , 'AFTER...' AS LAST_CONTROL_NUM
            , A.NOTE
        FROM jmes.TBL_EQUIP A
        WHERE A.EQUIP_KIND = #{SEL_EQUIP_KIND}
        AND A.DEL_YN = 'N'
        <if test="SEL_EQUIP_TYPE !='' and SEL_EQUIP_TYPE != null">
            AND A.EQUIP_TYPE = #{SEL_EQUIP_TYPE}
        </if>
        <if test="SEL_EQUIP_SIZE !='' and SEL_EQUIP_SIZE != null">
            AND A.EQUIP_SIZE = #{SEL_EQUIP_SIZE}
        </if>
        <if test="SEL_EQUIP_NM !='' and SEL_EQUIP_NM != null">
            AND A.EQUIP_NM LIKE CONCAT('%', #{SEL_EQUIP_NM}, '%')
        </if>
        <if test="SEL_FACTORY_AREA !='' and SEL_FACTORY_AREA != null">
            AND A.FACTORY_AREA = #{SEL_FACTORY_AREA}
        </if>
        <if test="SEL_MAIN_USER_ID !='' and SEL_MAIN_USER_ID != null">
            AND EXISTS (  SELECT 1
                            FROM jmes.TBL_USER
                            WHERE USER_ID IN (A.MAIN_USER_ID, A.SUB_USER_ID)
                            AND USER_NM LIKE CONCAT('%', #{SEL_MAIN_USER_ID}, '%')
                       )
        </if>
        <if test="SEL_TERM_DT_USE or SEL_TERM_DT_USE ==true">
            <if test='SEL_DAY_TYPE == "1"'>
                AND A.PURCHASE_DT >= REPLACE(#{SEL_ST_DT},'-',space(0))
                AND A.PURCHASE_DT <![CDATA[ <= ]]> REPLACE(#{SEL_END_DT},'-',space(0))
            </if>
        </if>
        ORDER BY A.EQUIP_ID
    </select>

    <select id="selectMachineInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT A.EQUIP_ID
            , jmes.SF_GET_CODE_NM('1051', A.EQUIP_KIND, 'KR') AS EQUIP_KIND_NM
            , A.PHOTO_GFILE_SEQ
            , A.EQUIP_NM
            , A.PROCESS_TYPE
            , A.EQUIP_TYPE
            , A.EQUIP_SIZE
            , A.EQUIP_COMP_CD
            , A.FACTORY_AREA
            , A.MAIN_USER_ID
            , A.SUB_USER_ID
            , jmes.SF_GET_DATE_F(A.PURCHASE_DT,'YYYY','') AS PURCHASE_DT
            , A.RESELLER_CD
            , A.ETC_GFILE_SEQ
            , jmes.SF_GET_FILE_ORGINAL_NM(A.ETC_GFILE_SEQ, NULL) as ETC_GFILE_SEQ_NM
            , A.NOTE
        FROM jmes.TBL_EQUIP A
        WHERE A.EQUIP_ID = #{EQUIP_ID}
    </select>
    <select id="selectMachineSeq" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT CONCAT('NC', LPAD(NEXTVAL(jmes.SEQ_EQUIP),4,'0'))AS SEQ
        FROM dual
    </select>

    <insert id="insertMachineMaster" parameterType="java.util.HashMap">
        INSERT INTO jmes.TBL_EQUIP (EQUIP_ID, EQUIP_KIND, EQUIP_NM
                              , PROCESS_TYPE, EQUIP_TYPE, EQUIP_SIZE
                              , EQUIP_COMP_CD, FACTORY_AREA
                              , MAIN_USER_ID, SUB_USER_ID, PURCHASE_DT, RESELLER_CD, NOTE
                              , PHOTO_GFILE_SEQ, ETC_GFILE_SEQ, INSERT_ID)
        VALUES (  #{EQUIP_ID}, #{EQUIP_KIND}, #{EQUIP_NM}
                , #{PROCESS_TYPE, jdbcType=VARCHAR}, #{EQUIP_TYPE}, #{EQUIP_SIZE}
                , #{EQUIP_COMP_CD}, #{FACTORY_AREA}
                , #{MAIN_USER_ID}, #{SUB_USER_ID}, REPLACE(#{PURCHASE_DT},'-',space(0)), #{RESELLER_CD}, #{NOTE}
                , #{PHOTO_GFILE_SEQ}, #{ETC_GFILE_SEQ}, #{LOGIN_USER_ID} )
    </insert>
    <update id="updateMachineMaster" parameterType="java.util.HashMap">
        UPDATE jmes.TBL_EQUIP
        SET EQUIP_NM = #{EQUIP_NM}
              , PROCESS_TYPE = #{PROCESS_TYPE, jdbcType=VARCHAR}
              , EQUIP_TYPE = #{EQUIP_TYPE}
              , EQUIP_SIZE = #{EQUIP_SIZE}
              , EQUIP_COMP_CD = #{EQUIP_COMP_CD}
              , FACTORY_AREA = #{FACTORY_AREA}
              , MAIN_USER_ID = #{MAIN_USER_ID}
              , SUB_USER_ID = #{SUB_USER_ID}
              , PURCHASE_DT = REPLACE(#{PURCHASE_DT},'-',space(0))
              , RESELLER_CD = #{RESELLER_CD}
              , NOTE = #{NOTE}
            <if test="PHOTO_GFILE_SEQ != null and PHOTO_GFILE_SEQ != ''">
                  , PHOTO_GFILE_SEQ = #{PHOTO_GFILE_SEQ}
            </if>
            <if test="ETC_GFILE_SEQ != null and ETC_GFILE_SEQ != ''">
              , ETC_GFILE_SEQ = #{ETC_GFILE_SEQ}
            </if>
              , UPDATE_DT = NOW()
              , UPDATE_ID = #{LOGIN_USER_ID}
        WHERE EQUIP_ID = #{EQUIP_ID}
    </update>
    <delete id="deleteMachineMaster" parameterType="java.util.HashMap">
        UPDATE jmes.TBL_EQUIP
        SET DEL_YN = 'Y'
          , UPDATE_DT = NOW()
          , UPDATE_ID = #{LOGIN_USER_ID}
        WHERE EQUIP_ID = #{EQUIP_ID}
    </delete>

    <select id="selectMachineLogList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT A.EQUIP_ID
          , A.SEQ
          , A.REPAIR_TYPE
          , A.REPAIR_DESC
          , jmes.SF_GET_DATE_F(A.REPAIR_START_DT,'YY','M') AS REPAIR_START_DT
          , jmes.SF_GET_DATE_F(A.REPAIR_END_DT,'YY','M') AS REPAIR_END_DT
          , CONCAT(DATEDIFF(A.REPAIR_END_DT, A.REPAIR_START_DT) * 24 + HOUR(TIMEDIFF(A.REPAIR_END_DT, A.REPAIR_START_DT)), 'H ', MINUTE(TIMEDIFF(A.REPAIR_END_DT, A.REPAIR_START_DT)),'M') AS REPAIR_TIME
          , A.NOTE
          , A.BEFORE_GFILE_SEQ
          , A.AFTER_GFILE_SEQ
        FROM jmes.TBL_EQUIP_REPAIR A
        WHERE A.EQUIP_ID = #{EQUIP_ID}
    </select>
    <select id="selectMachineHistoryList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT A.EQUIP_ID
          , A.SEQ
          , A.REPAIR_TYPE
          , SF_GET_CODE_NM(1036, REPAIR_TYPE, 'KR') AS REPAIR_TYPE_NM
          , A.REPAIR_DESC
          , jmes.SF_GET_DATE_F(A.REPAIR_START_DT,'YYYY','M') AS REPAIR_START_DT
          , jmes.SF_GET_DATE_F(A.REPAIR_END_DT,'YYYY','M') AS REPAIR_END_DT
          , CONCAT(DATEDIFF(A.REPAIR_END_DT, A.REPAIR_START_DT) * 24 + HOUR(TIMEDIFF(A.REPAIR_END_DT, A.REPAIR_START_DT)), 'H ', MINUTE(TIMEDIFF(A.REPAIR_END_DT, A.REPAIR_START_DT)),'M') AS REPAIR_TIME
          , A.NOTE
          , A.BEFORE_GFILE_SEQ
          , A.AFTER_GFILE_SEQ
        FROM jmes.TBL_EQUIP_REPAIR A
        WHERE A.EQUIP_ID = #{EQUIP_ID}
    </select>
    <insert id="insertMachineMasterHistory" parameterType="java.util.HashMap">
        INSERT INTO jmes.TBL_EQUIP_REPAIR ( EQUIP_ID, SEQ, REPAIR_TYPE
                                            , REPAIR_START_DT, REPAIR_END_DT
                                            , REPAIR_DESC, NOTE, BEFORE_GFILE_SEQ, AFTER_GFILE_SEQ, INSERT_ID)
        VALUES (#{EQUIP_ID},NEXTVAL(jmes.SEQ_DUMMY),#{REPAIR_TYPE}
                , STR_TO_DATE(#{REPAIR_START_DT},'%Y-%m-%d %H:%i'), STR_TO_DATE(#{REPAIR_END_DT},'%Y-%m-%d %H:%i')
                , #{REPAIR_DESC}, #{NOTE}, #{BEFORE_GFILE_SEQ}, #{AFTER_GFILE_SEQ}, #{LOGIN_USER_ID})
    </insert>
    <update id="updateMachineMasterHistory" parameterType="java.util.HashMap">
        UPDATE jmes.TBL_EQUIP_REPAIR
        SET  REPAIR_TYPE = #{REPAIR_TYPE}
            , REPAIR_START_DT = STR_TO_DATE(#{REPAIR_START_DT},'%Y-%m-%d %H:%i')
            , REPAIR_END_DT = STR_TO_DATE(#{REPAIR_END_DT},'%Y-%m-%d %H:%i')
            , REPAIR_DESC = #{REPAIR_DESC}
            , NOTE = #{NOTE}
            , BEFORE_GFILE_SEQ = #{BEFORE_GFILE_SEQ}
            , AFTER_GFILE_SEQ = #{AFTER_GFILE_SEQ}
            , UPDATE_DT = NOW()
            , UPDATE_ID = #{LOGIN_USER_ID}
        WHERE EQUIP_ID = #{EQUIP_ID}
            AND SEQ = #{SEQ}
    </update>
    <delete id="deleteMachineMasterHistory" parameterType="java.util.HashMap">
        DELETE FROM jmes.TBL_EQUIP_REPAIR
        WHERE EQUIP_ID = #{EQUIP_ID}
            AND SEQ = #{SEQ}
    </delete>
</mapper>