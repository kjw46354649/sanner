<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="material">
    <select id="selectItemOrderRegisterNextMaterialOrderNum" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            CONCAT('MPO-', DATE_FORMAT(NOW(), '%Y%m%d'), '-',LPAD(COUNT(*)+1, 3, '0')) AS MATERIAL_ORDER_NUM
        FROM TBL_MATERIAL_ORDER
        WHERE 1=1
            AND DATE_FORMAT(INSERT_DT, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
    </select>

    <select id="selectItemOrderRegisterList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            ROW_NUMBER () OVER () AS ROWNUM,
            A.CONTROL_SEQ, B.CONTROL_DETAIL_SEQ, F.MATERIAL_ORDER_SEQ, F.MATERIAL_ORDER_NUM,
            A.CONTROL_NUM, A.CONTROL_VER,
            A.ORDER_COMP_CD, ( SELECT Z.COMP_NM FROM TBL_COMPANY Z WHERE A.ORDER_COMP_CD = Z.COMP_CD ) AS ORDER_COMP_NM,
            A.COMP_CD, SF_GET_CODE_NM('1007', A.COMP_CD, 'EN') AS COMP_NM,
            A.CONTROL_STATUS, SF_GET_CODE_NM('1024', A.CONTROL_STATUS, 'EN') AS CONTROL_STATUS_NM,
            B.STATUS_DT, SF_GET_CODE_NM('1024', B.PART_STATUS, 'EN') AS PART_STATUS_NM,
            A.ORDER_STAFF_SEQ, B.PART_STATUS, B.DRAWING_NUM, B.DRAWING_VER, B.PART_NUM,
            B.MATERIAL_TYPE, B.MATERIAL_DETAIL, B.MATERIAL_KIND, B.SIZE_TXT, B.SIZE_TYPE, B.SIZE_W, B.SIZE_H, B.SIZE_D, B.SIZE_L,
            B.DWG_GFILE_SEQ, B.PDF_GFILE_SEQ, D.ORDER_DUE_DT, D.ORDER_QTY,
            F.MATERIAL_COMP_CD AS M_COMP_CD, SF_GET_CODE_NM('1007', F.MATERIAL_COMP_CD, 'EN') AS M_COMP_NM,
            F.ORDER_QTY AS M_ORDER_QTY, F.ORDER_NOTE AS M_ORDER_NOTE, F.SIZE_TXT AS M_SIZE_TXT, G.REQUEST_CD
        FROM TBL_CONTROL A
            INNER JOIN TBL_CONTROL_PART B ON A.CONTROL_SEQ = B.CONTROL_SEQ AND B.WORK_TYPE = 'FCT01'
            INNER JOIN TBL_CONTROL_PART_ORDER D ON B.CONTROL_SEQ = D.CONTROL_SEQ AND B.CONTROL_DETAIL_SEQ = D.CONTROL_DETAIL_SEQ
            LEFT OUTER JOIN TBL_MATERIAL_ORDER F ON D.CONTROL_SEQ = F.CONTROL_SEQ AND F.CONTROL_DETAIL_SEQ = D.CONTROL_DETAIL_SEQ
            LEFT OUTER JOIN TBL_MATERIAL_ORDER_REQUEST G ON F.MATERIAL_ORDER_SEQ AND G.MATERIAL_ORDER_SEQ
        WHERE A.CONTROL_STATUS = 'PRO01'
        ORDER BY A.CONTROL_SEQ, B.CONTROL_DETAIL_SEQ, F.MATERIAL_ORDER_SEQ
    </select>

    <select id="selectItemOrderRegisterPopList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            ROW_NUMBER () OVER () AS ROWNUM,
            A.CONTROL_SEQ, B.CONTROL_DETAIL_SEQ, F.MATERIAL_ORDER_SEQ, F.MATERIAL_ORDER_NUM,
            A.CONTROL_NUM, A.CONTROL_VER,
            A.ORDER_COMP_CD, ( SELECT Z.COMP_NM FROM TBL_COMPANY Z WHERE A.ORDER_COMP_CD = Z.COMP_CD ) AS ORDER_COMP_NM,
            A.COMP_CD, SF_GET_CODE_NM('1007', A.COMP_CD, 'EN') AS COMP_NM,
            A.CONTROL_STATUS, SF_GET_CODE_NM('1024', A.CONTROL_STATUS, 'EN') AS CONTROL_STATUS_NM,
            B.STATUS_DT, SF_GET_CODE_NM('1024', B.PART_STATUS, 'EN') AS PART_STATUS_NM,
            A.ORDER_STAFF_SEQ, B.PART_STATUS, B.DRAWING_NUM, B.DRAWING_VER, B.PART_NUM,
            B.MATERIAL_TYPE, B.MATERIAL_DETAIL, B.MATERIAL_KIND, B.SIZE_TXT, B.SIZE_TYPE, B.SIZE_W, B.SIZE_H, B.SIZE_D, B.SIZE_L,
            B.DWG_GFILE_SEQ, B.PDF_GFILE_SEQ, D.ORDER_DUE_DT, D.ORDER_QTY,
            F.MATERIAL_COMP_CD AS M_COMP_CD, SF_GET_CODE_NM('1007', F.MATERIAL_COMP_CD, 'EN') AS M_COMP_NM,
            F.ORDER_QTY AS M_ORDER_QTY, F.ORDER_NOTE AS M_ORDER_NOTE, F.SIZE_TXT AS M_SIZE_TXT, G.REQUEST_CD
        FROM TBL_CONTROL A
            INNER JOIN TBL_CONTROL_PART B ON A.CONTROL_SEQ = B.CONTROL_SEQ AND B.WORK_TYPE = 'FCT01'
            INNER JOIN TBL_CONTROL_PART_ORDER D ON B.CONTROL_SEQ = D.CONTROL_SEQ AND B.CONTROL_DETAIL_SEQ = D.CONTROL_DETAIL_SEQ
            LEFT OUTER JOIN TBL_MATERIAL_ORDER F ON D.CONTROL_SEQ = F.CONTROL_SEQ AND F.CONTROL_DETAIL_SEQ = D.CONTROL_DETAIL_SEQ
            LEFT OUTER JOIN TBL_MATERIAL_ORDER_REQUEST G ON F.MATERIAL_ORDER_SEQ AND G.MATERIAL_ORDER_SEQ
        WHERE A.CONTROL_STATUS = 'PRO01'
            AND CONCAT(A.CONTROL_SEQ, B.CONTROL_DETAIL_SEQ) IN(${CONCAT_SEQ})
        ORDER BY A.CONTROL_SEQ, B.CONTROL_DETAIL_SEQ, F.MATERIAL_ORDER_SEQ
    </select>

    <insert id="updateItemOrderRegister" parameterType="java.util.HashMap">

    </insert>

    <update id="insertUpdateItemOrderRegister" parameterType="java.util.HashMap">
        INSERT INTO TBL_MATERIAL_ORDER
        (
            MATERIAL_ORDER_SEQ, MATERIAL_ORDER_NUM, CONTROL_SEQ, CONTROL_DETAIL_SEQ,
            MATERIAL_COMP_CD, HOPE_DUE_DT, SIZE_TXT,
            SIZE_TYPE, SIZE_W, SIZE_H, SIZE_T, SIZE_D, SIZE_L,
            ORDER_NOTE, ORDER_QTY, ORDER_AMT,
            INSPECT_MATERIAL_YN, INSPECT_SURFACE_YN, INSPECT_SIZE_YN, INSPECT_NOTE,
            ORDER_STATUS, ORDER_DT, IN_DT, CANCEL_DT,
            INSERT_DT, INSERT_ID, CANCEL_USER_ID
        )
        VALUES
        (
            <choose>
                <when  test="MATERIAL_ORDER_SEQ !='' and MATERIAL_ORDER_SEQ != null">
                    #{MATERIAL_ORDER_SEQ},
                </when>
                <otherwise>
                    NEXTVAL(SEQ_MATERIAL_ORDER),
                </otherwise>
            </choose>
             #{MATERIAL_ORDER_NUM}, #{CONTROL_SEQ}, #{CONTROL_DETAIL_SEQ},
            #{M_COMP_CD}, #{HOPE_DUE_DT}, #{M_SIZE_TXT},
            SF_GET_SIZE_TXT('SIZE_TYPE', #{M_SIZE_TXT}), SF_GET_SIZE_TXT('SIZE_W', #{M_SIZE_TXT}),
            SF_GET_SIZE_TXT('SIZE_H', #{M_SIZE_TXT}), SF_GET_SIZE_TXT('SIZE_T', #{M_SIZE_TXT}),
            SF_GET_SIZE_TXT('SIZE_D', #{M_SIZE_TXT}), SF_GET_SIZE_TXT('SIZE_L', #{M_SIZE_TXT}),
            #{M_ORDER_NOTE}, #{M_ORDER_QTY}, #{ORDER_AMT},
            #{INSPECT_MATERIAL_YN}, #{INSPECT_SURFACE_YN}, #{INSPECT_SIZE_YN}, #{INSPECT_NOTE},
            #{ORDER_STATUS}, #{ORDER_DT}, #{IN_DT}, #{CANCEL_DT},
            #{INSERT_DT}, #{INSERT_ID}, #{CANCEL_USER_ID}
        )
        ON DUPLICATE KEY UPDATE
            MATERIAL_COMP_CD = #{M_COMP_CD},
            HOPE_DUE_DT = #{HOPE_DUE_DT},
            SIZE_TXT = #{M_SIZE_TXT},
            SIZE_TYPE = SF_GET_SIZE_TXT('SIZE_TYPE', #{M_SIZE_TXT}),
            SIZE_W = SF_GET_SIZE_TXT('SIZE_W', #{M_SIZE_TXT}),
            SIZE_H = SF_GET_SIZE_TXT('SIZE_H', #{M_SIZE_TXT}),
            SIZE_T = SF_GET_SIZE_TXT('SIZE_T', #{M_SIZE_TXT}),
            SIZE_D = SF_GET_SIZE_TXT('SIZE_D', #{M_SIZE_TXT}),
            SIZE_L = SF_GET_SIZE_TXT('SIZE_L', #{M_SIZE_TXT}),
            ORDER_NOTE = #{M_ORDER_NOTE},
            ORDER_QTY = #{M_ORDER_QTY},
            UPDATE_DT = NOW(),
            UPDATE_ID = NULL
    </update>

</mapper>