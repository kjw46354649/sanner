<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="drawingMapper">

    <select id="selectDrawingEquipmentInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT A.EQUIP_SEQ, A.EQUIP_NM, A.FACTORY_AREA, B.USER_ID, B.USER_NM, B.PHOTO_GFILE_SEQ, IFNULL(A.IF_USE_YN, 'N') AS IF_USE_YN,
               IFNULL(A.EQUIP_OFF_YN, 'N') AS EQUIP_OFF_YN
        FROM TBL_EQUIP A
        	LEFT OUTER JOIN TBL_USER B ON A.LOGIN_USER_ID = B.USER_ID
        WHERE 1 = 1
            AND A.EQUIP_KIND = '1'
          	AND A.PROCESS_TYPE IN ('MPR010', 'MPR020', 'MPR030', 'MPR040')
            AND A.DEL_YN ='N'
            AND A.EQUIP_NM = #{EQUIP_NM}
    </select>

    <select id="selectDrawingAreaList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
        	A.CODE_CD, B.CODE_NM
        FROM TBL_CODE A
        	INNER JOIN TBL_CODE_LANG B ON A.HIGH_CD = B.HIGH_CD AND A.CODE_CD = B.CODE_CD AND B.LANG_CD = CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN 'EN' ELSE 'KR' END
        WHERE 1 = 1
        	AND A.HIGH_CD = '1005'
        	AND A.ETC3 = 'D'
        ORDER BY A.SORT_NUM
    </select>

    <select id="selectDrawingEquipment" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT EQUIP_SEQ, EQUIP_NM, FACTORY_AREA, IFNULL(IF_USE_YN, 'N') AS IF_USE_YN,
               IFNULL(EQUIP_OFF_YN, 'N') AS EQUIP_OFF_YN
        FROM TBL_EQUIP
        WHERE 1 = 1
            AND EQUIP_KIND = '1'
          	AND PROCESS_TYPE IN ('MPR010', 'MPR020', 'MPR030', 'MPR040')
            AND DEL_YN ='N'
            AND FACTORY_AREA = #{FACTORY_AREA}
    </select>

    <select id="selectDrawingWorkerGroupList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.CODE_CD, B.CODE_NM
        FROM TBL_CODE A
            INNER JOIN TBL_CODE_LANG B ON A.HIGH_CD = B.HIGH_CD AND A.CODE_CD = B.CODE_CD AND B.LANG_CD = CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN 'EN' ELSE 'KR' END
        WHERE 1 = 1
            AND A.HIGH_CD = '1061'
        ORDER BY A.SORT_NUM
    </select>

    <select id="selectDrawingErrorReasonList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.CODE_CD, B.CODE_NM
        FROM TBL_CODE A
            INNER JOIN TBL_CODE_LANG B ON A.HIGH_CD = B.HIGH_CD AND A.CODE_CD = B.CODE_CD AND B.LANG_CD = CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN 'EN' ELSE 'KR' END
        WHERE 1 = 1
            AND A.HIGH_CD = '1015'
        ORDER BY A.SORT_NUM
    </select>

    <select id="selectDrawingUser" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT A.USER_ID, A.USER_NM, IFNULL(A.PHOTO_GFILE_SEQ, SPACE(0)) AS PHOTO_GFILE_SEQ
        FROM TBL_USER A
        WHERE 1=1
            AND A.DEL_YN = 'N'
            <if test="DEPARTMENT != null and DEPARTMENT != ''">
                AND A.DEPARTMENT = #{DEPARTMENT}
            </if>
        ORDER BY A.USER_NM
    </select>

    <select id="selectDrawingBoardLastWork" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	    <!-- 최근 작업 내용 -->
        SELECT
            Z.DATA_TYPE, Z.CONTROL_SEQ, Z.CONTROL_DETAIL_SEQ, Z.MCT_WORK_SEQ, Z.CONTROL_NUM,
            Z.WORK_MINUTE, Z.WORK_SECOND, Z.STOP_MINUTE, Z.STOP_SECOND,  Z.INNER_DUE_DT,<!--내부가공납기 -->
            Z.WORK_START_DT, Z.WORK_FINISH_DT, Z.CONTROL_NUM_NM, Z.PART_NUM, X.BARCODE_NUM,
            Z.EMERGENCY_YN,<!--긴급 -->
            Z.MAIN_INSPECTION,<!--주요 검사품 -->
            Z.SAME_SIDE_YN,<!-- 대칭 여부 -->
            Z.MATERIAL_FINISH_HEAT, <!-- 열처리 -->
            Z.ORDER_QTY,<!--수량 -->
            CAST((Z.ORDER_QTY + IFNULL(Z.ADDITIONAL_QTY,0)) AS INT) AS FINISH_QTY,
            CASE WHEN ORIGINAL_SIDE_QTY > 0 AND Z.OTHER_SIDE_QTY > 0 AND Z.ADDITIONAL_QTY > 0
                    THEN CONCAT(Z.ORDER_QTY, SPACE(1), "(", Z.ORIGINAL_SIDE_QTY, ",", Z.OTHER_SIDE_QTY, ")", ' + ', Z.ADDITIONAL_QTY)
                 WHEN ORIGINAL_SIDE_QTY  > 0 AND Z.OTHER_SIDE_QTY > 0
                    THEN CONCAT(Z.ORDER_QTY, SPACE(1), "(", Z.ORIGINAL_SIDE_QTY, ",", Z.OTHER_SIDE_QTY, ")")
                 WHEN ORIGINAL_SIDE_QTY  > 0 AND Z.OTHER_SIDE_QTY = 0 AND Z.ADDITIONAL_QTY > 0
                    THEN CONCAT(Z.ORDER_QTY, SPACE(1), "(", Z.ORIGINAL_SIDE_QTY, ")", ' + ', Z.ADDITIONAL_QTY)
                 WHEN ORIGINAL_SIDE_QTY  > 0 AND Z.OTHER_SIDE_QTY = 0
                    THEN CONCAT(Z.ORDER_QTY, SPACE(1), "(", Z.ORIGINAL_SIDE_QTY, ")")
                 WHEN ORIGINAL_SIDE_QTY  = 0 AND Z.OTHER_SIDE_QTY > 0 AND Z.ADDITIONAL_QTY > 0
                    THEN CONCAT(Z.ORDER_QTY, SPACE(1), "(", Z.OTHER_SIDE_QTY, ")", ' + ', Z.ADDITIONAL_QTY)
                 WHEN ORIGINAL_SIDE_QTY  = 0 AND Z.OTHER_SIDE_QTY > 0
                    THEN CONCAT(Z.ORDER_QTY, SPACE(1), "(", Z.OTHER_SIDE_QTY, ")")
                 WHEN Z.ADDITIONAL_QTY > 0
                    THEN CONCAT(Z.ORDER_QTY, ' + ', Z.ADDITIONAL_QTY)
                 ELSE Z.ORDER_QTY
            END AS ORDER_QTY_INFO,-- 수량에 대칭 추가 -->
            CONCAT(IFNULL(Z.NOTE, SPACE(0)), ' ', IFNULL(Z.MATERIAL_NOTE, SPACE(0))) AS NOTE, Z.MCT_NOTE,
            DATE_FORMAT(Y.INSERT_DT,'%y.%m.%d') AS INSPECT_DT,
            jmes.SF_GET_CODE_NM('1040', Y.INSPECT_GRADE, 'EN') AS INSPECT_GRADE_NM,
            CASE WHEN Y.INSPECT_TYPE = '1' THEN
            		CASE WHEN jmes.SF_GET_CODE_NM('1019', Y.INSPECT_RESULT, 'EN') IS NULL THEN jmes.SF_GET_CODE_NM('1020', Y.INSPECT_RESULT, 'EN')
                         ELSE jmes.SF_GET_CODE_NM('1019', Y.INSPECT_RESULT, 'EN')
                    END
              	 WHEN Y.INSPECT_TYPE = '2' THEN jmes.SF_GET_CODE_NM('1021', Y.INSPECT_RESULT, 'EN')
            END AS INSPECT_RESULT_NM,
            jmes.SF_GET_CODE_NM('1032', Y.ERROR_REASON, 'EN') AS ERROR_REASON_NM, Z.WORK_STATUS,
            (
                SELECT CONCAT(SF_GET_EQUIP_NM(M.EQUIP_SEQ), <![CDATA[ '<br>' ]]>, SF_GET_USER_NM(M.WORK_USER_ID))
                FROM TBL_MCT_WORK M
                WHERE M.DEL_YN = 'N'
                    AND M.CONTROL_SEQ = Z.CONTROL_SEQ
                    AND M.CONTROL_DETAIL_SEQ = Z.CONTROL_DETAIL_SEQ
                    AND M.MCT_WORK_SEQ = (
                        SELECT MAX(N.MCT_WORK_SEQ)
                        FROM TBL_MCT_WORK N
                        WHERE M.CONTROL_SEQ = N.CONTROL_SEQ
                            AND M.CONTROL_DETAIL_SEQ = N.CONTROL_DETAIL_SEQ
                            AND N.WORK_STATUS = 'DBS030'
                            AND N.DEL_YN = 'N'
                    )
            ) AS LATEST_PROCESS,
            (IFNULL(Z.UNIT_QTY,1) * IFNULL(Z.COMPLETE_CYCLE_COUNT,0) + IFNULL(Z.ADJUST_QTY,0)) AS COMPLETE_QTY,
            Z.GOAL_QTY,
            IFNULL(Z.ADJUST_QTY,0) AS ADJUST_QTY,
            Z.PLAN_CYCLE_COUNT,
            Z.COMPLETE_CYCLE_COUNT,
            Z.UNIT_QTY,
            IFNULL(CAST((SELECT SUM(M.ERROR_QTY) FROM TBL_MCT_WORK_INSPECT M WHERE M.MCT_WORK_SEQ = Z.MCT_WORK_SEQ AND M.DEL_YN = 'N') AS INT),SPACE(0)) AS ERROR_QTY,
            Z.WORK_ACTIVE_TIME,
            Z.WORK_STOP_TIME,
            CASE WHEN Z.WORK_ACTIVE_TIME IS NOT NULL AND Z.WORK_ACTIVE_TIME > 0
                    THEN CONCAT(
                        TRUNCATE(IFNULL(Z.WORK_ACTIVE_TIME,0)/3600,0) , 'h ',
                        TRUNCATE((IFNULL(Z.WORK_ACTIVE_TIME,0)%3600)/60,0), 'm ',
                        TRUNCATE(((IFNULL(Z.WORK_ACTIVE_TIME,0)%3600) % 60),0), 's'
                    )
                ELSE '-'
            END AS WORK_ACTIVE_TIME_FORMAT,
            CASE WHEN Z.WORK_STOP_TIME IS NOT NULL AND Z.WORK_STOP_TIME > 0
                    THEN CONCAT(
                        TRUNCATE(IFNULL(Z.WORK_STOP_TIME,0)/3600,0) , 'h ',
                        TRUNCATE((IFNULL(Z.WORK_STOP_TIME,0)%3600)/60,0), 'm ',
                        TRUNCATE(((IFNULL(Z.WORK_STOP_TIME,0)%3600) % 60),0), 's'
                    )
                ELSE '-'
            END AS WORK_STOP_TIME_FORMAT,
            CASE WHEN Z.LATEST_CYCLE_TIME IS NOT NULL AND Z.LATEST_CYCLE_TIME > 0
                    THEN CONCAT(
                        TRUNCATE(IFNULL(Z.LATEST_CYCLE_TIME,0)/3600,0) , 'h ',
                        TRUNCATE((IFNULL(Z.LATEST_CYCLE_TIME,0)%3600)/60,0), 'm ',
                        TRUNCATE(((IFNULL(Z.LATEST_CYCLE_TIME,0)%3600) % 60),0), 's'
                    )
                ELSE '-'
            END AS LATEST_CYCLE_TIME,
            Z.ACTIVE_TYPE,
            Z.EVENT_TIME,
            IFNULL(Z.CURRENT_STATUS_TIME,0) AS CURRENT_STATUS_TIME,
            CASE WHEN Z.ACTIVE_TYPE = 'PGM_ACTIVE'
                    THEN CONCAT(
                        TRUNCATE(IFNULL(Z.CURRENT_STATUS_TIME,0)/3600,0) , 'h ',
                        TRUNCATE((IFNULL(Z.CURRENT_STATUS_TIME,0)%3600)/60,0), 'm ',
                        TRUNCATE(((IFNULL(Z.CURRENT_STATUS_TIME,0)%3600) % 60),0), 's'
                    )
                ELSE '-'
            END AS CURRENT_STATUS_TIME_FORMAT,
            IFNULL(CASE WHEN Z.ACTIVE_TYPE = 'PGM_STOP' THEN CASE WHEN Z.LEFT_TIME <![CDATA[ < ]]> 0 THEN 0 ELSE Z.LEFT_TIME END
                        WHEN Z.ACTIVE_TYPE = 'PGM_ACTIVE' THEN CASE WHEN (Z.LEFT_TIME - Z.CURRENT_STATUS_TIME) <![CDATA[ < ]]> 0 THEN 0 ELSE (Z.LEFT_TIME - Z.CURRENT_STATUS_TIME) END
            END,0) AS LEFT_TIME,
            Z.EQUIP_OFF_YN,
            Z.DISCONNECT_YN
        FROM (
            SELECT
                'LAST' AS DATA_TYPE, A.CONTROL_SEQ, A.CONTROL_DETAIL_SEQ, A.MCT_WORK_SEQ, D.CONTROL_NUM,
                C.DRAWING_NUM, D.CONTROL_VER, C.DRAWING_VER, A.WORK_STATUS,
                SF_GET_DRAWING_WORK_TIME('W_MINUTE', A.MCT_WORK_SEQ) AS WORK_MINUTE,
                SF_GET_DRAWING_WORK_TIME('W_SECOND', A.MCT_WORK_SEQ) AS WORK_SECOND,
                SF_GET_DRAWING_WORK_TIME('S_MINUTE', A.MCT_WORK_SEQ) AS STOP_MINUTE,
                SF_GET_DRAWING_WORK_TIME('S_SECOND', A.MCT_WORK_SEQ) AS STOP_SECOND,
                CASE WHEN D.EMERGENCY_YN = 'Y' THEN D.EMERGENCY_YN ELSE SPACE(0) END AS EMERGENCY_YN,<!--긴급 -->
                IFNULL(SF_GET_CODE_NM('1059', D.MAIN_INSPECTION, #{LOGIN_LOCALE}), SPACE(0)) AS MAIN_INSPECTION,<!--주요 검사품 -->
                IFNULL(C.MATERIAL_FINISH_HEAT, SPACE(0)) AS MATERIAL_FINISH_HEAT, <!-- 열처리 -->
                IFNULL(jmes.SF_GET_DATE_F(A.WORK_START_DT, '', 'M'), SPACE(0)) AS WORK_START_DT,
                IFNULL(jmes.SF_GET_DATE_F(A.WORK_FINISH_DT, '', 'M'), SPACE(0)) AS WORK_FINISH_DT,
                CASE WHEN C.PART_NUM IS NULL THEN D.CONTROL_NUM ELSE CONCAT(D.CONTROL_NUM, ' #', C.PART_NUM) END AS CONTROL_NUM_NM,<!--작업지시번호 -->
                IFNULL(C.PART_NUM, SPACE(0)) AS PART_NUM,<!--PART 번호 -->
                CONCAT(IFNULL(SF_GET_CONTROL_PART_QTY(C.CONTROL_SEQ, C.CONTROL_DETAIL_SEQ), 0), SPACE(0)) AS ORDER_QTY,-- 주문 수량 -->
                IFNULL(C.ADDITIONAL_QTY,0) AS ADDITIONAL_QTY,
                IFNULL(jmes.SF_GET_SIDE_QTY(C.CONTROL_SEQ, 'ORIGINAL_SIDE_QTY') * IFNULL(C.PART_UNIT_QTY, 1), 0)AS ORIGINAL_SIDE_QTY,<!--대칭_원칭 -->
                IFNULL(jmes.SF_GET_SIDE_QTY(C.CONTROL_SEQ, 'OTHER_SIDE_QTY') * IFNULL(C.PART_UNIT_QTY, 1), 0) AS OTHER_SIDE_QTY,<!--대칭_대칭 -->
                D.SAME_SIDE_YN,<!-- 대칭 여부 -->
                jmes.SF_GET_DATE_F(C.INNER_DUE_DT, '', '') AS INNER_DUE_DT,<!--내부가공납기 -->
                D.NOTE AS NOTE, C.MATERIAL_NOTE, C.MCT_NOTE,
                D.ORDER_COMP_CD,
                C.MATERIAL_TYPE,
                C.SIZE_TXT,
                A.ADJUST_QTY,
                A.GOAL_QTY,
                A.COMPLETE_CYCLE_COUNT,
                A.UNIT_QTY,
                A.LATEST_CYCLE_TIME,
                A.WORK_ACTIVE_TIME,
                A.WORK_STOP_TIME,
                A.PLAN_CYCLE_COUNT,
                ((A.LATEST_CYCLE_TIME * CEIL(A.GOAL_QTY / A.UNIT_QTY)) - A.WORK_ACTIVE_TIME) AS LEFT_TIME,
                E.ACTIVE_TYPE,
                E.CYCLE_FINISH_YN,
                E.EVENT_TIME,
                TIMESTAMPDIFF(SECOND, E.EVENT_TIME, NOW()) AS CURRENT_STATUS_TIME,
                F.EQUIP_OFF_YN,
                F.DISCONNECT_YN
            FROM TBL_MCT_WORK A
        	    INNER JOIN TBL_CONTROL_PART C ON A.CONTROL_SEQ = C.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = C.CONTROL_DETAIL_SEQ
        	    INNER JOIN TBL_CONTROL D ON C.CONTROL_SEQ = D.CONTROL_SEQ AND D.DEL_YN = 'N'
                INNER JOIN TBL_EQUIP F ON F.EQUIP_SEQ = A.EQUIP_SEQ AND F.DEL_YN = 'N'
                LEFT OUTER JOIN TBL_MCT_WORKING_LOG E ON E.MCT_WORK_SEQ = A.MCT_WORK_SEQ AND E.MCT_LOG_SEQ = (SELECT MAX(Q.MCT_LOG_SEQ) FROM TBL_MCT_WORKING_LOG Q WHERE Q.MCT_WORK_SEQ = E.MCT_WORK_SEQ)
        	WHERE 1 = 1
                AND A.MCT_WORK_SEQ = (SELECT MAX(H.MCT_WORK_SEQ) FROM TBL_MCT_WORK H
                                        WHERE A.EQUIP_SEQ = H.EQUIP_SEQ AND H.DEL_YN = 'N' AND H.WORK_FINISH_DT IS NOT NULL
                                            AND H.WORK_START_DT IS NOT NULL)
                AND A.DEL_YN = 'N'
                AND A.WORK_START_DT IS NOT NULL
                AND A.WORK_FINISH_DT IS NOT NULL
                AND A.EQUIP_SEQ = #{EQUIP_SEQ}
        ) Z
        INNER JOIN TBL_CONTROL_BARCODE X ON Z.CONTROL_SEQ = X.CONTROL_SEQ AND Z.CONTROL_DETAIL_SEQ = X.CONTROL_DETAIL_SEQ
               	AND Z.CONTROL_VER = X.CONTROL_VER AND IFNULL(Z.DRAWING_VER, SPACE(0)) = IFNULL(X.DRAWING_VER, SPACE(0)) AND X.DEL_YN = 'N'
        LEFT OUTER JOIN TBL_INSPECT Y ON Y.INSPECT_SEQ = (
            SELECT MAX(C.INSPECT_SEQ)
            FROM TBL_CONTROL A
                INNER JOIN TBL_CONTROL_PART B ON B.CONTROL_SEQ = A.CONTROL_SEQ
                INNER JOIN TBL_INSPECT C ON C.CONTROL_SEQ = B.CONTROL_SEQ AND C.CONTROL_DETAIL_SEQ = B.CONTROL_DETAIL_SEQ AND C.INSPECT_NUM = 1
            WHERE A.DEL_YN = 'N'
                AND A.ORDER_COMP_CD = Z.ORDER_COMP_CD
                AND B.SIZE_TXT = Z.SIZE_TXT
                AND B.MATERIAL_TYPE = Z.MATERIAL_TYPE
        )
    </select>

    <select id="selectDrawingBoardCurrentWork" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        <!-- 현재 작업 진행 중 내용 -->
        SELECT
            Z.DATA_TYPE, Z.CONTROL_SEQ, Z.CONTROL_DETAIL_SEQ, Z.MCT_WORK_SEQ, Z.CONTROL_NUM,Z.INNER_DUE_DT,<!--내부가공납기 -->
            Z.WORK_START_DT, Z.WORK_FINISH_DT, Z.CONTROL_NUM_NM, Z.PART_NUM, X.BARCODE_NUM,
            Z.EMERGENCY_YN,<!--긴급 -->
            Z.MAIN_INSPECTION,<!--주요 검사품 -->
            Z.SAME_SIDE_YN,<!-- 대칭 여부 -->
            Z.MATERIAL_FINISH_HEAT, <!-- 열처리 -->
            Z.ORDER_QTY,<!--수량 -->
            CAST((Z.ORDER_QTY + IFNULL(Z.ADDITIONAL_QTY,0)) AS INT) AS FINISH_QTY,
            CASE WHEN ORIGINAL_SIDE_QTY > 0 AND Z.OTHER_SIDE_QTY > 0 AND Z.ADDITIONAL_QTY > 0
                    THEN CONCAT(Z.ORDER_QTY, SPACE(1), "(", Z.ORIGINAL_SIDE_QTY, ",", Z.OTHER_SIDE_QTY, ")",' + ', Z.ADDITIONAL_QTY)
                 WHEN ORIGINAL_SIDE_QTY > 0 AND Z.OTHER_SIDE_QTY > 0
                    THEN CONCAT(Z.ORDER_QTY, SPACE(1), "(", Z.ORIGINAL_SIDE_QTY, ",", Z.OTHER_SIDE_QTY, ")")
                 WHEN ORIGINAL_SIDE_QTY  > 0 AND Z.OTHER_SIDE_QTY = 0 AND Z.ADDITIONAL_QTY > 0
                    THEN CONCAT(Z.ORDER_QTY, SPACE(1), "(", Z.ORIGINAL_SIDE_QTY, ")", ' + ', Z.ADDITIONAL_QTY)
                 WHEN ORIGINAL_SIDE_QTY  > 0 AND Z.OTHER_SIDE_QTY = 0
                    THEN CONCAT(Z.ORDER_QTY, SPACE(1), "(", Z.ORIGINAL_SIDE_QTY, ")")
                 WHEN ORIGINAL_SIDE_QTY  = 0 AND Z.OTHER_SIDE_QTY > 0 AND Z.ADDITIONAL_QTY > 0
                    THEN CONCAT(Z.ORDER_QTY, SPACE(1), "(", Z.OTHER_SIDE_QTY, ")", ' + ', Z.ADDITIONAL_QTY)
                 WHEN ORIGINAL_SIDE_QTY  = 0 AND Z.OTHER_SIDE_QTY > 0
                    THEN CONCAT(Z.ORDER_QTY, SPACE(1), "(", Z.OTHER_SIDE_QTY, ")")
                 WHEN Z.ADDITIONAL_QTY > 0
                    THEN CONCAT(Z.ORDER_QTY, ' + ', Z.ADDITIONAL_QTY)
                 ELSE Z.ORDER_QTY
            END AS ORDER_QTY_INFO,<!--수량에 대칭 추가 -->
            CONCAT(IFNULL(Z.NOTE, SPACE(0)), ' ', IFNULL(Z.MATERIAL_NOTE, SPACE(0))) AS NOTE, Z.MCT_NOTE,
            DATE_FORMAT(Y.INSERT_DT,'%y.%m.%d') AS INSPECT_DT,
            jmes.SF_GET_CODE_NM('1040', Y.INSPECT_GRADE, 'EN') AS INSPECT_GRADE_NM,
            CASE WHEN Y.INSPECT_TYPE = '1' THEN
                    CASE WHEN jmes.SF_GET_CODE_NM('1019', Y.INSPECT_RESULT, 'EN') IS NULL THEN jmes.SF_GET_CODE_NM('1020', Y.INSPECT_RESULT, 'EN')
                         ELSE jmes.SF_GET_CODE_NM('1019', Y.INSPECT_RESULT, 'EN')
                    END
                 WHEN Y.INSPECT_TYPE = '2' THEN jmes.SF_GET_CODE_NM('1021', Y.INSPECT_RESULT, 'EN')
            END AS INSPECT_RESULT_NM,
            jmes.SF_GET_CODE_NM('1032', Y.ERROR_REASON, 'EN') AS ERROR_REASON_NM, Z.WORK_STATUS,
            (
                SELECT CONCAT(SF_GET_EQUIP_NM(M.EQUIP_SEQ), <![CDATA[ '<br>' ]]>, SF_GET_USER_NM(M.WORK_USER_ID))
                FROM TBL_MCT_WORK M
                WHERE M.DEL_YN = 'N'
                    AND M.CONTROL_SEQ = Z.CONTROL_SEQ
                    AND M.CONTROL_DETAIL_SEQ = Z.CONTROL_DETAIL_SEQ
                    AND M.MCT_WORK_SEQ = (
                        SELECT MAX(N.MCT_WORK_SEQ)
                        FROM TBL_MCT_WORK N
                        WHERE M.CONTROL_SEQ = N.CONTROL_SEQ
                            AND M.CONTROL_DETAIL_SEQ = N.CONTROL_DETAIL_SEQ
                            AND N.WORK_STATUS = 'DBS030'
                            AND N.DEL_YN = 'N'
                    )
            ) AS LATEST_PROCESS,
            (IFNULL(Z.UNIT_QTY,1) * IFNULL(Z.COMPLETE_CYCLE_COUNT,0) + IFNULL(Z.ADJUST_QTY,0)) AS COMPLETE_QTY,
            Z.GOAL_QTY,
            IFNULL(Z.ADJUST_QTY,0) AS ADJUST_QTY,
            Z.PLAN_CYCLE_COUNT,
            Z.COMPLETE_CYCLE_COUNT,
            Z.UNIT_QTY,
            IFNULL(CAST((SELECT SUM(M.ERROR_QTY) FROM TBL_MCT_WORK_INSPECT M WHERE M.MCT_WORK_SEQ = Z.MCT_WORK_SEQ AND M.DEL_YN = 'N') AS INT),SPACE(0)) AS ERROR_QTY,
            Z.WORK_ACTIVE_TIME,
            Z.WORK_STOP_TIME,
            CASE WHEN Z.WORK_ACTIVE_TIME IS NOT NULL AND Z.WORK_ACTIVE_TIME > 0
                    THEN CONCAT(
                        TRUNCATE(IFNULL(Z.WORK_ACTIVE_TIME,0)/3600,0) , 'h ',
                        TRUNCATE((IFNULL(Z.WORK_ACTIVE_TIME,0)%3600)/60,0), 'm ',
                        TRUNCATE(((IFNULL(Z.WORK_ACTIVE_TIME,0)%3600) % 60),0), 's'
                    )
                ELSE '-'
            END AS WORK_ACTIVE_TIME_FORMAT,
            CASE WHEN Z.WORK_STOP_TIME IS NOT NULL AND Z.WORK_STOP_TIME > 0
                    THEN CONCAT(
                        TRUNCATE(IFNULL(Z.WORK_STOP_TIME,0)/3600,0) , 'h ',
                        TRUNCATE((IFNULL(Z.WORK_STOP_TIME,0)%3600)/60,0), 'm ',
                        TRUNCATE(((IFNULL(Z.WORK_STOP_TIME,0)%3600) % 60),0), 's'
                    )
                ELSE '-'
            END AS WORK_STOP_TIME_FORMAT,
            CASE WHEN Z.LATEST_CYCLE_TIME IS NOT NULL AND Z.LATEST_CYCLE_TIME > 0
                    THEN CONCAT(
                        TRUNCATE(IFNULL(Z.LATEST_CYCLE_TIME,0)/3600,0) , 'h ',
                        TRUNCATE((IFNULL(Z.LATEST_CYCLE_TIME,0)%3600)/60,0), 'm ',
                        TRUNCATE(((IFNULL(Z.LATEST_CYCLE_TIME,0)%3600) % 60),0), 's'
                    )
                 ELSE '-'
            END AS LATEST_CYCLE_TIME,
            Z.ACTIVE_TYPE,
            Z.EVENT_TIME,
            IFNULL(Z.CURRENT_STATUS_TIME,0) AS CURRENT_STATUS_TIME,
            CASE WHEN Z.ACTIVE_TYPE = 'PGM_ACTIVE'
                    THEN CONCAT(
                        TRUNCATE(IFNULL(Z.CURRENT_STATUS_TIME,0)/3600,0) , 'h ',
                        TRUNCATE((IFNULL(Z.CURRENT_STATUS_TIME,0)%3600)/60,0), 'm ',
                        TRUNCATE(((IFNULL(Z.CURRENT_STATUS_TIME,0)%3600) % 60),0), 's'
                    )
                ELSE '-'
            END AS CURRENT_STATUS_TIME_FORMAT,
            IFNULL(CASE WHEN Z.ACTIVE_TYPE = 'PGM_STOP' THEN CASE WHEN Z.LEFT_TIME <![CDATA[ < ]]> 0 THEN 0 ELSE Z.LEFT_TIME END
                        WHEN Z.ACTIVE_TYPE = 'PGM_ACTIVE' THEN CASE WHEN (Z.LEFT_TIME - Z.CURRENT_STATUS_TIME) <![CDATA[ < ]]> 0 THEN 0 ELSE (Z.LEFT_TIME - Z.CURRENT_STATUS_TIME) END
            END,0) AS LEFT_TIME,
            Z.EQUIP_OFF_YN,
            Z.DISCONNECT_YN
        FROM (
            SELECT
                'CUR' AS DATA_TYPE, A.CONTROL_SEQ, A.CONTROL_DETAIL_SEQ, A.MCT_WORK_SEQ, D.CONTROL_NUM,
                C.DRAWING_NUM, D.CONTROL_VER, C.DRAWING_VER, A.WORK_STATUS,
                CASE WHEN D.EMERGENCY_YN = 'Y' THEN D.EMERGENCY_YN ELSE SPACE(0) END AS EMERGENCY_YN,<!--긴급 -->
                IFNULL(SF_GET_CODE_NM('1059', D.MAIN_INSPECTION, #{LOGIN_LOCALE}), SPACE(0)) AS MAIN_INSPECTION,<!--주요 검사품 -->
                IFNULL(SF_GET_CODE_NM('1058', C.MATERIAL_FINISH_HEAT, #{LOGIN_LOCALE}), SPACE(0)) AS MATERIAL_FINISH_HEAT, <!-- 열처리 -->
                IFNULL(jmes.SF_GET_DATE_F(A.WORK_START_DT, '', 'M'), SPACE(0)) AS WORK_START_DT,
                IFNULL(jmes.SF_GET_DATE_F(A.WORK_FINISH_DT, '', 'M'), SPACE(0)) AS WORK_FINISH_DT,
                CASE WHEN C.PART_NUM IS NULL THEN D.CONTROL_NUM ELSE CONCAT(D.CONTROL_NUM, ' #', C.PART_NUM) END AS CONTROL_NUM_NM,<!--작업지시번호 -->
                IFNULL(C.PART_NUM, SPACE(0)) AS PART_NUM,<!--PART 번호 -->
                CONCAT(IFNULL(SF_GET_CONTROL_PART_QTY(C.CONTROL_SEQ, C.CONTROL_DETAIL_SEQ), 0), SPACE(0)) AS ORDER_QTY,<!--주문 수량 -->
                IFNULL(C.ADDITIONAL_QTY,0) AS ADDITIONAL_QTY,
                IFNULL(jmes.SF_GET_SIDE_QTY(C.CONTROL_SEQ, 'ORIGINAL_SIDE_QTY') * IFNULL(C.PART_UNIT_QTY, 1), 0)AS ORIGINAL_SIDE_QTY,<!--대칭_원칭 -->
                IFNULL(jmes.SF_GET_SIDE_QTY(C.CONTROL_SEQ, 'OTHER_SIDE_QTY') * IFNULL(C.PART_UNIT_QTY, 1), 0) AS OTHER_SIDE_QTY,<!--대칭_대칭 -->
                D.SAME_SIDE_YN,<!-- 대칭 여부 -->
                jmes.SF_GET_DATE_F(C.INNER_DUE_DT, '', '') AS INNER_DUE_DT,<!--내부가공납기 -->
                D.NOTE AS NOTE, C.MATERIAL_NOTE, C.MCT_NOTE,
                D.ORDER_COMP_CD,
                C.MATERIAL_TYPE,
                C.SIZE_TXT,
                A.ADJUST_QTY,
                A.GOAL_QTY,
                A.COMPLETE_CYCLE_COUNT,
                A.UNIT_QTY,
                A.LATEST_CYCLE_TIME,
                A.WORK_ACTIVE_TIME,
                A.WORK_STOP_TIME,
                A.PLAN_CYCLE_COUNT,
                ((A.LATEST_CYCLE_TIME * CEIL(A.GOAL_QTY / A.UNIT_QTY)) - A.WORK_ACTIVE_TIME) AS LEFT_TIME,
                E.ACTIVE_TYPE,
                CASE WHEN E.EVENT_TIME IS NULL THEN A.WORK_START_DT
                       ELSE E.EVENT_TIME
                END AS EVENT_TIME,
                CASE WHEN E.EVENT_TIME IS NULL THEN TIMESTAMPDIFF(SECOND, A.WORK_START_DT, NOW())
                       ELSE TIMESTAMPDIFF(SECOND, E.EVENT_TIME, NOW())
                END AS CURRENT_STATUS_TIME,
                F.EQUIP_OFF_YN,
                F.DISCONNECT_YN
            FROM TBL_MCT_WORK A
                INNER JOIN TBL_CONTROL_PART C ON A.CONTROL_SEQ = C.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = C.CONTROL_DETAIL_SEQ
                INNER JOIN TBL_CONTROL D ON C.CONTROL_SEQ = D.CONTROL_SEQ AND D.DEL_YN = 'N'
                INNER JOIN TBL_EQUIP F ON F.EQUIP_SEQ = A.EQUIP_SEQ AND F.DEL_YN = 'N'
                LEFT OUTER JOIN TBL_MCT_WORKING_LOG E ON E.MCT_WORK_SEQ = A.MCT_WORK_SEQ AND E.MCT_LOG_SEQ = (SELECT MAX(Q.MCT_LOG_SEQ) FROM TBL_MCT_WORKING_LOG Q WHERE Q.MCT_WORK_SEQ = E.MCT_WORK_SEQ)
            WHERE 1 = 1
                AND A.MCT_WORK_SEQ = (SELECT MAX(H.MCT_WORK_SEQ) FROM TBL_MCT_WORK H
                                        WHERE A.EQUIP_SEQ = H.EQUIP_SEQ AND H.DEL_YN = 'N' AND H.WORK_FINISH_DT IS NULL
                                            AND H.WORK_START_DT IS NOT NULL)
                AND A.DEL_YN = 'N'
                AND A.WORK_START_DT IS NOT NULL
                AND A.WORK_FINISH_DT IS NULL
                AND A.EQUIP_SEQ = #{EQUIP_SEQ}
        ) Z
        INNER JOIN TBL_CONTROL_BARCODE X ON Z.CONTROL_SEQ = X.CONTROL_SEQ AND Z.CONTROL_DETAIL_SEQ = X.CONTROL_DETAIL_SEQ
                AND Z.CONTROL_VER = X.CONTROL_VER AND IFNULL(Z.DRAWING_VER, SPACE(0)) = IFNULL(X.DRAWING_VER, SPACE(0)) AND X.DEL_YN = 'N'
        LEFT OUTER JOIN TBL_INSPECT Y ON 1 = 1
            AND Y.INSPECT_SEQ = (
                SELECT MAX(C.INSPECT_SEQ)
                FROM TBL_CONTROL A
                    INNER JOIN TBL_CONTROL_PART B ON B.CONTROL_SEQ = A.CONTROL_SEQ
                    INNER JOIN TBL_INSPECT C ON C.CONTROL_SEQ = B.CONTROL_SEQ AND C.CONTROL_DETAIL_SEQ = B.CONTROL_DETAIL_SEQ AND C.INSPECT_NUM = 1
                WHERE A.DEL_YN = 'N'
                    AND A.ORDER_COMP_CD = Z.ORDER_COMP_CD
                    AND B.SIZE_TXT = Z.SIZE_TXT
                    AND B.MATERIAL_TYPE = Z.MATERIAL_TYPE
            )
    </select>

    <select id="selectDrawingBoardWorkPlanList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
        	A.CONTROL_SEQ, A.CONTROL_DETAIL_SEQ,
        	C.CONTROL_NUM, <!--관리 번호 -->
            C.SAME_SIDE_YN, -- 대칭 여부 -->
        	IFNULL(D.PART_NUM, SPACE(0)) AS PART_NUM, <!--PART 번호 -->
            jmes.SF_GET_CONTROL_PART_QTY(A.CONTROL_SEQ, A.CONTROL_DETAIL_SEQ) AS ORDER_QTY, <!--수량 -->
            IFNULL(jmes.SF_GET_DATE_F(D.INNER_DUE_DT, '', ''), SPACE(0)) AS INNER_DUE_DT, <!--내부가공납기 -->
            (SELECT M.BARCODE_NUM FROM TBL_CONTROL_BARCODE M WHERE M.CONTROL_SEQ = D.CONTROL_SEQ AND M.CONTROL_DETAIL_SEQ = D.CONTROL_DETAIL_SEQ AND M.DEL_YN = 'N') AS BARCODE_NUM
        FROM jmes.TBL_MCT_PLAN A
        	INNER JOIN jmes.TBL_EQUIP B ON A.EQUIP_SEQ = B.EQUIP_SEQ AND B.EQUIP_KIND = '1'
                  	AND B.PROCESS_TYPE IN ('MPR010', 'MPR020', 'MPR030', 'MPR040')
                    AND B.DEL_YN ='N'
           	INNER JOIN jmes.TBL_CONTROL C ON A.CONTROL_SEQ = C.CONTROL_SEQ AND C.DEL_YN = 'N' AND C.OUT_FINISH_DT IS NULL
            INNER JOIN jmes.TBL_CONTROL_PART D ON A.CONTROL_SEQ = D.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = D.CONTROL_DETAIL_SEQ
                AND D.PART_STATUS NOT IN ('PRO001', 'PRO003', 'PRO004', 'PRO012', 'PRO014')
        WHERE A.EQUIP_SEQ = #{EQUIP_SEQ}
        	AND A.DEL_YN = 'N'
        ORDER BY A.CONTROL_SEQ, A.CONTROL_DETAIL_SEQ
    </select>

    <select id="selectDrawingBoardPopList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.CONTROL_SEQ, A.CONTROL_DETAIL_SEQ,
            B.CONTROL_NUM,<!--관리 번호 -->
            B.SAME_SIDE_YN, -- 대칭 여부 -->
            IFNULL(A.PART_NUM, SPACE(0)) AS PART_NUM,<!--PART 번호 -->
            jmes.SF_GET_CONTROL_PART_QTY(A.CONTROL_SEQ, A.CONTROL_DETAIL_SEQ) AS ORDER_QTY,<!--수량 -->
            IFNULL(jmes.SF_GET_DATE_F(A.INNER_DUE_DT, '', ''), SPACE(0)) AS INNER_DUE_DT, <!--내부가공납기 -->
            (SELECT M.BARCODE_NUM FROM TBL_CONTROL_BARCODE M WHERE M.CONTROL_SEQ = A.CONTROL_SEQ AND M.CONTROL_DETAIL_SEQ = A.CONTROL_DETAIL_SEQ AND M.DEL_YN = 'N') AS BARCODE_NUM
        FROM TBL_CONTROL_PART A
            INNER JOIN TBL_CONTROL B ON A.CONTROL_SEQ = B.CONTROL_SEQ
            INNER JOIN TBL_POP C ON A.CONTROL_SEQ = C.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = C.CONTROL_DETAIL_SEQ
                AND C.POP_SEQ = (SELECT MAX(E.POP_SEQ) FROM TBL_POP E WHERE C.CONTROL_SEQ = E.CONTROL_SEQ AND C.CONTROL_DETAIL_SEQ = E.CONTROL_DETAIL_SEQ)<!--현재 POP -->
            INNER JOIN jmes.TBL_CODE D ON D.HIGH_CD = '1009' AND C.POP_POSITION = D.CODE_CD AND D.DEL_YN = 'N'
            	AND D.REF_CD = #{FACTORY_AREA}
        WHERE 1=1
          AND A.PART_STATUS NOT IN ('PRO001', 'PRO003', 'PRO004', 'PRO012', 'PRO014')
        ORDER BY A.CONTROL_SEQ, A.CONTROL_DETAIL_SEQ
    </select>

    <insert id="insertMctWorkStart"  parameterType="java.util.HashMap" >
        INSERT INTO jmes.TBL_MCT_WORK
        (MCT_WORK_SEQ, EQUIP_SEQ, CONTROL_SEQ, CONTROL_DETAIL_SEQ, WORK_USER_ID,
         WORK_STATUS, WORK_START_DT, DEL_YN, INSERT_ID,
         GOAL_QTY, PLAN_CYCLE_COUNT, UNIT_QTY, IF_WORK_START_DT
        <if test="PLAN_WORKING_TIME != null and PLAN_WORKING_TIME !=''">
            , PLAN_WORKING_TIME
        </if>
        )
        SELECT
            NEXTVAL(SEQ_MCT_WORK), #{machineInfo.EQUIP_SEQ}, B.CONTROL_SEQ, B.CONTROL_DETAIL_SEQ, #{userInfo.USER_ID},
            'DBS020', NOW(), 'N', #{userInfo.USER_ID},
            (SF_GET_CONTROL_PART_QTY(B.CONTROL_SEQ, B.CONTROL_DETAIL_SEQ) + IFNULL(B.ADDITIONAL_QTY,0)),
           <choose>
               <when test='machineInfo.IF_USE_YN != null and machineInfo.IF_USE_YN != "Y"'>
                   1, (SF_GET_CONTROL_PART_QTY(B.CONTROL_SEQ, B.CONTROL_DETAIL_SEQ) + IFNULL(B.ADDITIONAL_QTY,0)), NOW()
               </when>
               <otherwise>
                   (SF_GET_CONTROL_PART_QTY(B.CONTROL_SEQ, B.CONTROL_DETAIL_SEQ) + IFNULL(B.ADDITIONAL_QTY,0)), 1, NULL
               </otherwise>
           </choose>
            <if test="PLAN_WORKING_TIME != null and PLAN_WORKING_TIME !=''">
                , #{PLAN_WORKING_TIME}
            </if>
        FROM TBL_CONTROL A
            INNER JOIN TBL_CONTROL_PART B ON A.CONTROL_SEQ = B.CONTROL_SEQ
        WHERE A.DEL_YN = 'N'
            AND B.CONTROL_SEQ = #{CONTROL_SEQ}
            AND B.CONTROL_DETAIL_SEQ = #{CONTROL_DETAIL_SEQ}
    </insert>

    <select id="selectWorkingTime" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT WORKING_TIME AS PLAN_WORKING_TIME
        FROM jmes.TBL_MCT_PLAN
        WHERE CONTROL_SEQ = #{CONTROL_SEQ}
          AND CONTROL_DETAIL_SEQ = #{CONTROL_DETAIL_SEQ}
          AND DEL_YN = 'N'
    </select>

    <update id="updateEquipmentWorker"  parameterType="java.util.HashMap" >
        UPDATE jmes.TBL_EQUIP
        SET
            LOGIN_USER_ID = #{USER_ID}
          , UPDATE_DT = NOW()
          , UPDATE_ID = #{USER_ID}
        WHERE EQUIP_SEQ = #{EQUIP_SEQ}
    </update>

    <update id="updateRemoveEquipmentWorker"  parameterType="java.util.HashMap" >
        UPDATE jmes.TBL_EQUIP
        SET
            LOGIN_USER_ID = null
          , UPDATE_DT = NOW()
          , UPDATE_ID = #{USER_ID}
        WHERE EQUIP_SEQ = #{EQUIP_SEQ}
    </update>

    <update id="updateMctWork"  parameterType="java.util.HashMap" >
        UPDATE jmes.TBL_MCT_WORK
        SET
            WORK_STATUS = 'DBS040',
            <if test="DEL_YN != null and DEL_YN != ''">
                DEL_YN = #{DEL_YN},
            </if>
            UPDATE_DT = NOW(),
            UPDATE_ID = #{userInfo.USER_ID}
        WHERE 1 = 1
            AND DEL_YN = 'N'
            AND MCT_WORK_SEQ = #{MCT_WORK_SEQ}
    </update>

    <update id="updateMctCancelWork"  parameterType="java.util.HashMap" >
        UPDATE jmes.TBL_MCT_WORK
        SET
            WORK_STATUS = 'DBS040',
            DEL_YN = 'Y',
            UPDATE_DT = NOW(),
            UPDATE_ID = #{userInfo.USER_ID}
        WHERE 1 = 1
            AND DEL_YN = 'N'
            AND MCT_WORK_SEQ = #{MCT_WORK_SEQ}
    </update>

    <update id="updateMctCancelWorkingLog"  parameterType="java.util.HashMap" >
        UPDATE jmes.TBL_MCT_WORKING_LOG
        SET
            MCT_WORK_SEQ = NULL,
            UPDATE_DT = NOW(),
            UPDATE_ID = #{userInfo.USER_ID}
        WHERE 1 = 1
          AND MCT_WORK_SEQ = #{MCT_WORK_SEQ}
    </update>

    <update id="updateMctWorkStatusNonIf"  parameterType="java.util.HashMap" >
        UPDATE jmes.TBL_MCT_WORK A
            INNER JOIN (
                SELECT SUM(CASE WHEN X.BEFORE_TYPE = 'PGM_ACTIVE' THEN TIMESTAMPDIFF(SECOND,X.BEFORE_TIME,X.EVENT_TIME) ELSE 0 END) AS ACTIVE_TOTAL
                    , SUM(CASE WHEN X.BEFORE_TYPE = 'PGM_STOP' THEN TIMESTAMPDIFF(SECOND,X.BEFORE_TIME,X.EVENT_TIME) ELSE 0 END) AS STOP_TOTAL
                    , X.MCT_WORK_SEQ
                FROM (
                    SELECT M.EVENT_TIME,
                        LAG(M.EVENT_TIME) OVER (ORDER BY M.MCT_LOG_SEQ) AS BEFORE_TIME,
                        LAG(M.ACTIVE_TYPE) OVER (ORDER BY M.MCT_LOG_SEQ) AS BEFORE_TYPE,
                        N.MCT_WORK_SEQ
                    FROM TBL_MCT_WORKING_LOG M
                        INNER JOIN TBL_MCT_WORK N ON M.MCT_WORK_SEQ = N.MCT_WORK_SEQ AND M.EQUIP_SEQ = N.EQUIP_SEQ AND N.DEL_YN = 'N'
                    WHERE 1=1
                        AND M.MCT_WORK_SEQ = #{MCT_WORK_SEQ}
                    ORDER BY M.MCT_LOG_SEQ
                ) X
                GROUP BY X.MCT_WORK_SEQ
            ) B ON B.MCT_WORK_SEQ = A.MCT_WORK_SEQ
        SET
            A.WORK_STATUS = #{WORK_STATUS},
            A.WORK_ACTIVE_TIME = B.ACTIVE_TOTAL,
            A.WORK_STOP_TIME = B.STOP_TOTAL,
            A.UPDATE_DT = NOW(),
            A.UPDATE_ID = #{userInfo.USER_ID}
        WHERE A.MCT_WORK_SEQ = B.MCT_WORK_SEQ
            AND A.DEL_YN = 'N'
    </update>

    <delete id="updateCancelMctControlPartWork" parameterType="java.util.HashMap" >
        DELETE A
        FROM jmes.TBL_CONTROL_PART_PROGRESS A
        WHERE 1 = 1
            AND A.CONTROL_SEQ = #{CONTROL_SEQ}
            AND A.CONTROL_DETAIL_SEQ = #{CONTROL_DETAIL_SEQ}
            AND A.PART_STATUS = 'PRO007'
            AND A.SEQ = (SELECT X.SEQ FROM (SELECT MAX(B.SEQ) AS SEQ FROM TBL_CONTROL_PART_PROGRESS B
                WHERE B.CONTROL_SEQ = #{CONTROL_SEQ} AND B.CONTROL_DETAIL_SEQ = #{CONTROL_DETAIL_SEQ}) X
            )
    </delete>

    <update id="updateCompleteMctWorkNonIf"  parameterType="java.util.HashMap" >
        UPDATE TBL_MCT_WORK A
            INNER JOIN (
                SELECT SUM(CASE WHEN X.BEFORE_TYPE = 'PGM_ACTIVE' THEN TIMESTAMPDIFF(SECOND,X.BEFORE_TIME,X.EVENT_TIME) ELSE 0 END) AS ACTIVE_TOTAL
                    , SUM(CASE WHEN X.BEFORE_TYPE = 'PGM_STOP' THEN TIMESTAMPDIFF(SECOND,X.BEFORE_TIME,X.EVENT_TIME) ELSE 0 END) AS STOP_TOTAL
                    , MAX(CASE WHEN X.ACTIVE_TYPE = 'PGM_STOP' AND X.CYCLE_FINISH_YN = 'Y' THEN X.EVENT_TIME END ) AS IF_WORK_FINISH_DT
                    , X.MCT_WORK_SEQ
                FROM (
                    SELECT M.EVENT_TIME, M.ACTIVE_TYPE, M.PART_CNT, M.CYCLE_FINISH_YN,
                        LAG(M.EVENT_TIME) OVER (ORDER BY M.MCT_LOG_SEQ) AS BEFORE_TIME,
                        LAG(M.ACTIVE_TYPE) OVER (ORDER BY M.MCT_LOG_SEQ) AS BEFORE_TYPE,
                        N.MCT_WORK_SEQ
                    FROM TBL_MCT_WORKING_LOG M
                        INNER JOIN TBL_MCT_WORK N ON M.MCT_WORK_SEQ = N.MCT_WORK_SEQ AND M.EQUIP_SEQ = N.EQUIP_SEQ AND N.DEL_YN = 'N'
                    WHERE 1=1
                        AND M.MCT_WORK_SEQ = #{MCT_WORK_SEQ}
                    ORDER BY M.MCT_LOG_SEQ
                ) X
                GROUP BY X.MCT_WORK_SEQ
            ) B ON B.MCT_WORK_SEQ = A.MCT_WORK_SEQ
        SET
            A.WORK_FINISH_DT = NOW(),
            A.IF_WORK_FINISH_DT = B.IF_WORK_FINISH_DT,
            A.WORK_STATUS = 'DBS030',
            A.WORK_ACTIVE_TIME = B.ACTIVE_TOTAL,
            A.WORK_STOP_TIME = B.STOP_TOTAL,
            A.COMPLETE_CYCLE_COUNT = 1,
            A.LATEST_CYCLE_TIME = B.ACTIVE_TOTAL,
            FINISH_QTY = #{FINISH_QTY},
            A.UPDATE_DT = NOW(),
            A.UPDATE_ID = #{userInfo.USER_ID},
            A.WORK_USER_ID = #{userInfo.USER_ID}
        WHERE A.MCT_WORK_SEQ = B.MCT_WORK_SEQ
            AND A.DEL_YN = 'N'
    </update>
    <update id="updateCompleteMctWork"  parameterType="java.util.HashMap" >
        UPDATE jmes.TBL_MCT_WORK
        SET
            WORK_FINISH_DT = NOW(),
            IF_WORK_FINISH_DT = (SELECT MAX(EVENT_TIME) FROM TBL_MCT_WORKING_LOG A WHERE A. MCT_WORK_SEQ = #{MCT_WORK_SEQ} AND ACTIVE_TYPE = 'PGM_STOP' AND CYCLE_FINISH_YN = 'Y'),
            WORK_STATUS = 'DBS030',
            FINISH_QTY = #{FINISH_QTY},
            UPDATE_DT = NOW(),
            UPDATE_ID = #{userInfo.USER_ID},
            WORK_USER_ID = #{userInfo.USER_ID}
        WHERE 1 = 1
            AND DEL_YN = 'N'
            AND MCT_WORK_SEQ = #{MCT_WORK_SEQ}
    </update>

    <insert id="insertWorkingLogNonIf"  parameterType="java.util.HashMap" >
        INSERT INTO jmes.TBL_MCT_WORKING_LOG (
            MCT_LOG_SEQ,
            IF_SEQ, EQUIP_SEQ, MCT_WORK_SEQ,
            EVENT_TIME,
            EXECUTION, ACTIVE_TYPE,
            PART_CNT, CYCLE_FINISH_YN,
            INSERT_ID, IF_YN
        )
        SELECT
            NEXTVAL(jmes.SEQ_MCT_LOG),
            1, A.EQUIP_SEQ, A.MCT_WORK_SEQ,
            NOW(),
            #{EXECUTION}, #{ACTIVE_TYPE},
            1, 'N',
            #{userInfo.USER_ID}, #{CYCLE_FINISH_YN}
        FROM jmes.TBL_MCT_WORK A
        WHERE 1 = 1
          AND A.DEL_YN = 'N'
          AND A.MCT_WORK_SEQ = #{MCT_WORK_SEQ}
    </insert>

    <update id="deleteFristMctPlan"  parameterType="java.util.HashMap" >
        UPDATE jmes.TBL_MCT_PLAN A
            SET
                A.DEL_YN = 'Y',
                A.UPDATE_DT = NOW(),
                A.UPDATE_ID = #{userInfo.USER_ID}
        WHERE 1 = 1
            AND IFNULL(A.DEL_YN, 'N') = 'N'
            <!-- AND A.EQUIP_SEQ = #{machineInfo.EQUIP_SEQ} -->
            AND A.CONTROL_SEQ = #{CONTROL_SEQ}
            AND A.CONTROL_DETAIL_SEQ = #{CONTROL_DETAIL_SEQ}
            AND A.MCT_PLAN_SEQ = (SELECT MIN(B.MCT_PLAN_SEQ) FROM jmes.TBL_MCT_PLAN B WHERE A.CONTROL_SEQ = B.CONTROL_SEQ
                        AND A.CONTROL_DETAIL_SEQ = B.CONTROL_DETAIL_SEQ AND IFNULL(B.DEL_YN, 'N') = 'N')
    </update>

    <insert id="createDrawingBoardControlPartProgress" parameterType="java.util.HashMap" >
        INSERT INTO TBL_CONTROL_PART_PROGRESS (
            CONTROL_SEQ,
            CONTROL_DETAIL_SEQ,
            SEQ,
            PART_STATUS,
            STATUS_DT,
            INSERT_ID
        ) VALUES (
            #{CONTROL_SEQ},
            #{CONTROL_DETAIL_SEQ},
            NEXTVAL(SEQ_CONTROL_PART_PROGRESS),
            #{PART_STATUS},
            NOW(),
            #{userInfo.USER_ID}
        )
    </insert>

    <update id="updateDrawingBoardControlPartStatusMapping" parameterType="java.util.HashMap" >
        UPDATE TBL_CONTROL_PART A
            INNER JOIN  TBL_CONTROL_PART_PROGRESS B ON A.CONTROL_SEQ = B.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = B.CONTROL_DETAIL_SEQ
                AND B.SEQ = (SELECT MAX(C.SEQ) FROM TBL_CONTROL_PART_PROGRESS C WHERE C.CONTROL_SEQ = B.CONTROL_SEQ AND C.CONTROL_DETAIL_SEQ = C.CONTROL_DETAIL_SEQ)
        SET
            A.PART_STATUS = B.PART_STATUS,
            A.STATUS_DT = B.STATUS_DT,
            A.UPDATE_DT = NOW(),
            A.UPDATE_ID = #{userInfo.USER_ID}
        WHERE 1 = 1
            AND A.CONTROL_SEQ = #{CONTROL_SEQ}
            AND A.CONTROL_DETAIL_SEQ  = #{CONTROL_DETAIL_SEQ}
    </update>

    <!-- Barcode 스캔 이후 정보를 이용하여 작업 시작, 및 작업 종료 처리 한다. -->
    <select id="selectDrawingBarcodeScanInfo_Backup" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.CONTROL_SEQ, A.CONTROL_DETAIL_SEQ, B.CONTROL_NUM,<!--관리 번호 -->
            IFNULL(A.PART_NUM, SPACE(0)) AS PART_NUM,<!--PART 번호 -->
            jmes.SF_GET_CONTROL_PART_QTY(A.CONTROL_SEQ, A.CONTROL_DETAIL_SEQ) AS ORDER_QTY,<!--수량 -->
            jmes.SF_GET_DATE_F(A.INNER_DUE_DT, '', '') AS INNER_DUE_DT<!--내부가공납기 -->
        FROM TBL_CONTROL_PART A
            INNER JOIN TBL_CONTROL B ON A.CONTROL_SEQ = B.CONTROL_SEQ AND B.CONTROL_STATUS = 'ORD001' <!-- 주문확정 -->
                AND B.OUT_FINISH_DT IS NULL
            INNER JOIN TBL_CONTROL_BARCODE C ON C.CONTROL_SEQ = A.CONTROL_SEQ AND C.CONTROL_DETAIL_SEQ = A.CONTROL_DETAIL_SEQ AND C.CONTROL_VER = B.CONTROL_VER AND C.DEL_YN = 'N'
            	AND IFNULL(C.DRAWING_VER, SPACE(0)) = IFNULL(A.DRAWING_VER, SPACE(0)) AND C.BARCODE_NUM = #{BARCODE_NUM}
        WHERE 1 = 1
            AND A.PART_STATUS NOT IN ('PRO001', 'PRO003', 'PRO004', 'PRO012', 'PRO014')
   </select>

    <select id="selectDrawingBarcodeScanInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            CONCAT(IFNULL(Z.CONTROL_NUM, SPACE(0)), CASE WHEN Z.PART_NUM IS NOT NULL THEN CONCAT(' #', Z.PART_NUM) ELSE SPACE(0) END) AS CONTROL_INFO,
            Z.EMERGENCY_YN, Z.MAIN_INSPECTION, Z.MATERIAL_FINISH_HEAT, Z.ORDER_QTY, Z.ORIGINAL_SIDE_QTY, Z.OTHER_SIDE_QTY,
            Z.CONTROL_SEQ, Z.CONTROL_DETAIL_SEQ, Z.CONTROL_NUM, Z.PART_NUM, Z.SAME_SIDE_YN, Z.SCAN_BARCODE_NUM AS BARCODE_NUM,
            CAST((Z.ORDER_QTY + IFNULL(Z.ADDITIONAL_QTY,0)) AS INT) AS FINISH_QTY,
            CASE WHEN Z.SAME_SIDE_YN = 'Y' THEN CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN 'sym.' ELSE '대칭가공' END ELSE SPACE(0) END AS SAME_SIDE_YN_NM,
            CASE WHEN Z.MAIN_INSPECTION IS NOT NULL THEN Z.MAIN_INSPECTION ELSE SPACE(0) END AS MAIN_INSPECTION_NM,
            CASE WHEN Z.MATERIAL_FINISH_HEAT IS NOT NULL AND LENGTH(Z.MATERIAL_FINISH_HEAT) > 0  THEN CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN 'Heat treatment' ELSE '열처리' END ELSE SPACE(0) END AS MATERIAL_FINISH_HEAT_NM,
            CASE WHEN ORIGINAL_SIDE_QTY > 0 AND Z.OTHER_SIDE_QTY > 0 AND Z.ADDITIONAL_QTY > 0
                    THEN CONCAT(CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN 'Qty.' ELSE '수량' END, SPACE(1), Z.ORDER_QTY, ' EA', SPACE(1), '(', CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN 'ori. ' ELSE '원 ' END, Z.ORIGINAL_SIDE_QTY, ',', CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN ' sym. ' ELSE ' 대 ' END, Z.OTHER_SIDE_QTY, ')', ' + ', ADDITIONAL_QTY)
                WHEN ORIGINAL_SIDE_QTY > 0 AND Z.OTHER_SIDE_QTY > 0
                    THEN CONCAT(CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN 'Qty.' ELSE '수량' END, SPACE(1), Z.ORDER_QTY, ' EA', SPACE(1), '(', CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN 'ori. ' ELSE '원 ' END, Z.ORIGINAL_SIDE_QTY, ',', CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN ' sym. ' ELSE ' 대 ' END, Z.OTHER_SIDE_QTY, ')')
                WHEN ORIGINAL_SIDE_QTY  > 0 AND Z.OTHER_SIDE_QTY = 0 AND Z.ADDITIONAL_QTY > 0
                    THEN CONCAT(CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN 'Qty.' ELSE '수량' END, SPACE(1), Z.ORDER_QTY, ' EA', SPACE(1), '(', CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN 'ori. ' ELSE '원 ' END, Z.ORIGINAL_SIDE_QTY, ')', ' + ', Z.ADDITIONAL_QTY)
                WHEN ORIGINAL_SIDE_QTY  > 0 AND Z.OTHER_SIDE_QTY = 0
                    THEN CONCAT(CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN 'Qty.' ELSE '수량' END, SPACE(1), Z.ORDER_QTY, ' EA', SPACE(1), '(', CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN 'ori. ' ELSE '원 ' END, Z.ORIGINAL_SIDE_QTY, ')')
                WHEN ORIGINAL_SIDE_QTY  = 0 AND Z.OTHER_SIDE_QTY > 0 AND Z.ADDITIONAL_QTY > 0
                    THEN CONCAT(CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN 'Qty.' ELSE '수량' END, SPACE(1), Z.ORDER_QTY, ' EA', SPACE(1), '(', CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN 'sym. ' ELSE '대 ' END, Z.OTHER_SIDE_QTY, ')', ' + ', Z.ADDITIONAL_QTY)
                WHEN ORIGINAL_SIDE_QTY  = 0 AND Z.OTHER_SIDE_QTY > 0
                    THEN CONCAT(CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN 'Qty.' ELSE '수량' END, SPACE(1), Z.ORDER_QTY, ' EA', SPACE(1), '(', CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN 'sym. ' ELSE '대 ' END, Z.OTHER_SIDE_QTY, ')')
                WHEN Z.ADDITIONAL_QTY > 0
                    THEN CONCAT(CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN 'Qty.' ELSE '수량' END, SPACE(1), Z.ORDER_QTY, ' EA', SPACE(1), ' + ', Z.ADDITIONAL_QTY)
                ELSE CONCAT(CASE WHEN UPPER(#{LOGIN_LOCALE}) = 'EN' THEN 'Qty.' ELSE '수량' END, SPACE(1), Z.ORDER_QTY, ' EA', SPACE(1))
            END AS ORDER_QTY_INFO, <!-- 수량에 대칭 추가 -->
            jmes.SF_GET_DATE_F(Z.INNER_DUE_DT, '', '') AS INNER_DUE_DT, <!-- 내부가공납기 -->
            CASE WHEN Z.POP_COUNT = 0 THEN 'X' ELSE '' END CHE_POP, <!-- pop 선작업이 필요한 경우 -->
            CASE WHEN Z.OUTSIDE_CONFIRM_DT IS NULL AND PRO002 IS NULL THEN 'X' ELSE '' END AS CHE_PRO002, <!-- NULL 이 아닌경우 가공 확정 이후 DRAWING 작업 가능 -->
            CASE WHEN Z.SCAN_BARCODE_NUM != Z.CURR_BARCODE_NUM THEN 'X' ELSE '' END AS CHE_VER, <!-- 최선 바코드 정보와 스캔 바코드의 DRAWING_NUM 가 다른경우 -->
            CASE WHEN Z.DEL_YN = 'Y' THEN 'X' ELSE '' END AS CHE_DEL_YN, <!-- 주문 정보가 삭제된 경우  -->
            CASE WHEN Z.CONTROL_STATUS = 'ORD002' THEN 'X' ELSE '' END AS CHE_CANCEL_YN, <!-- 주문 취소가 된 경우  -->
            CASE WHEN Z.CONTROL_STATUS = 'ORD005' THEN 'X' ELSE '' END AS CHE_HOLD_YN <!-- 주문 보류 된 경우  -->
        FROM (
            SELECT
                A.CONTROL_SEQ, A.CONTROL_DETAIL_SEQ, H.CONTROL_NUM, A.PART_NUM, A.INNER_DUE_DT, H.SAME_SIDE_YN, <!-- 대칭 여부 -->
                CASE WHEN H.EMERGENCY_YN = 'Y' THEN H.EMERGENCY_YN ELSE SPACE(0) END AS EMERGENCY_YN, <!-- 긴급 -->
                IFNULL(SF_GET_CODE_NM('1059', H.MAIN_INSPECTION, #{LOGIN_LOCALE}), SPACE(0)) AS MAIN_INSPECTION, <!-- 주요 검사품 -->
                IFNULL(SF_GET_CODE_NM('1058', A.MATERIAL_FINISH_HEAT, #{LOGIN_LOCALE}), SPACE(0)) AS MATERIAL_FINISH_HEAT, <!-- 열처리 -->
                IFNULL(H.CONTROL_STATUS, SPACE(0)) AS CONTROL_STATUS, <!-- CONTROL 상태 -->
                IFNULL(A.PART_STATUS, SPACE(0)) AS PART_STATUS, <!-- CONTROL PART 현재 상태  -->
                A.INNER_WORK_FINISH_DT, <!-- 가공 완료 일시  -->
                IFNULL(A.OUTSIDE_YN, 'N') AS OUTSIDE_YN, <!-- 외주 가공 여부  -->
                A.OUTSIDE_CONFIRM_DT,  <!-- 외주 가공 확정일  -->
                B.BARCODE_NUM AS SCAN_BARCODE_NUM, B.CONTROL_VER AS SCAN_CONTROL_VER,  B.DRAWING_VER AS SCAN_DRAWING_VER, <!-- 바코드 스캔 정보 -->
                D.BARCODE_NUM AS CURR_BARCODE_NUM, D.CONTROL_VER AS CURR_CONTROL_VER,  D.DRAWING_VER AS CURR_DRAWING_VER, <!-- 바코드 최선 정보 -->
                MAX(P.PART_STATUS) AS PRO002, H.DEL_YN, <!-- 주문정보 삭제 유무 -->
                jmes.SF_GET_CONTROL_PART_QTY(A.CONTROL_SEQ, A.CONTROL_DETAIL_SEQ) AS ORDER_QTY, <!-- 수량 -->
                IFNULL(A.ADDITIONAL_QTY,0) AS ADDITIONAL_QTY,
                IFNULL(jmes.SF_GET_SIDE_QTY(A.CONTROL_SEQ, 'ORIGINAL_SIDE_QTY') * IFNULL(A.PART_UNIT_QTY, 1), 0) AS ORIGINAL_SIDE_QTY, <!-- 대칭_원칭 -->
                IFNULL(jmes.SF_GET_SIDE_QTY(A.CONTROL_SEQ, 'OTHER_SIDE_QTY') * IFNULL(A.PART_UNIT_QTY, 1), 0) AS OTHER_SIDE_QTY, <!-- 대칭_대칭 -->
                (SELECT COUNT(*) FROM TBL_POP K WHERE K.CONTROL_SEQ = A.CONTROL_SEQ AND K.CONTROL_DETAIL_SEQ = A.CONTROL_DETAIL_SEQ) AS POP_COUNT
            FROM TBL_CONTROL_PART A
                INNER JOIN TBL_CONTROL H ON A.CONTROL_SEQ = H.CONTROL_SEQ  <!-- 확정 상태 -->
                INNER JOIN TBL_CONTROL_BARCODE B ON A.CONTROL_SEQ = B.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = B.CONTROL_DETAIL_SEQ
                    AND B.BARCODE_NUM = #{BARCODE_NUM} <!-- 현재 찍힌 바코드 -->
                LEFT OUTER JOIN TBL_CONTROL_BARCODE D ON A.CONTROL_SEQ = D.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = D.CONTROL_DETAIL_SEQ AND D.DEL_YN = 'N'
                LEFT OUTER JOIN TBL_CONTROL_PART_PROGRESS P ON A.CONTROL_SEQ = P.CONTROL_SEQ AND A.CONTROL_DETAIL_SEQ = P.CONTROL_DETAIL_SEQ AND P.PART_STATUS = 'PRO002' <!-- 가공 확정 존재 유무 주문 -->
                    AND P.SEQ > IFNULL((SELECT MAX(E.SEQ) FROM TBL_CONTROL_PART_PROGRESS E WHERE P.CONTROL_SEQ = E.CONTROL_SEQ AND P.CONTROL_DETAIL_SEQ = E.CONTROL_DETAIL_SEQ AND IFNULL(E.PART_STATUS, 'PRO003') = 'PRO003'), 0)
            WHERE 1=1
        ) Z
    </select>
    <select id="selectNfcData" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT A.USER_ID, B.USER_NM, B.PHOTO_GFILE_SEQ
        FROM TBL_NFC_LOGIN A
             INNER JOIN TBL_USER B ON A.USER_ID = B.USER_ID AND B.DEL_YN = 'N'
        WHERE A.DEL_YN = 'N'
          AND REPLACE(A.NFC_ID,'-',SPACE(0)) = #{NFC_ID}
    </select>

    <select id="selectDrawingLatestProcessList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT X.RNUM
             , X.PROCESS_TYPE
             , X.PROCESS_TYPE_NM
             , X.EQUIP_NM
             , X.WORK_STATUS
             , X.WORK_START_DT
             , X.WORK_FINISH_DT
             , X.WORK_USER
             , X.FINISH_QTY
             , X.ERROR_QTY
        FROM (
                 SELECT ROW_NUMBER() OVER(ORDER BY A.MCT_WORK_SEQ) AS RNUM
                , B.PROCESS_TYPE, SF_GET_CODE_NM('1010', B.PROCESS_TYPE, #{LOGIN_LOCALE}) AS PROCESS_TYPE_NM
                      , B.EQUIP_NM
                      , SF_GET_CODE_NM('1079', A.WORK_STATUS, #{LOGIN_LOCALE}) AS WORK_STATUS
                      , SF_GET_DATE_F(A.WORK_START_DT,'YY','M') AS WORK_START_DT
                      , SF_GET_DATE_F(A.WORK_FINISH_DT,'YY','M') AS WORK_FINISH_DT
                      , (SELECT M.USER_NM FROM TBL_USER M WHERE M.USER_ID = A.WORK_USER_ID) AS WORK_USER
                      , A.FINISH_QTY
                      , A.ERROR_QTY
                 FROM TBL_MCT_WORK A, TBL_EQUIP B
                 WHERE A.EQUIP_SEQ = B.EQUIP_SEQ
                   AND A.DEL_YN = 'N'
                   AND A.CONTROL_SEQ = #{CONTROL_SEQ}
                   AND A.CONTROL_DETAIL_SEQ = #{CONTROL_DETAIL_SEQ}
                 ORDER BY WORK_START_DT DESC
             ) X
    </select>

    <select id="selectDrawingNoteList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT ROW_NUMBER() OVER(ORDER BY X.NOTE_TYPE) AS RNUM,
                SF_GET_CODE_NM('1078', X.NOTE_TYPE, 'KO') AS NOTE_TYPE_NM
             , X.NOTE
        FROM (  SELECT '1' AS NOTE_TYPE, A.NOTE FROM TBL_CONTROL A WHERE A.CONTROL_SEQ = #{CONTROL_SEQ} AND A.NOTE IS NOT NULL
                UNION ALL
                SELECT '2' AS NOTE_TYPE, A.MCT_NOTE AS NOTE FROM TBL_CONTROL_PART A WHERE A.CONTROL_SEQ = #{CONTROL_SEQ} AND A.CONTROL_DETAIL_SEQ = #{CONTROL_DETAIL_SEQ} AND A.MCT_NOTE IS NOT NULL
                UNION ALL
                SELECT '4' AS NOTE_TYPE, A.MATERIAL_NOTE AS NOTE FROM TBL_CONTROL_PART A WHERE A.CONTROL_SEQ = #{CONTROL_SEQ} AND A.CONTROL_DETAIL_SEQ = #{CONTROL_DETAIL_SEQ} AND A.MATERIAL_NOTE IS NOT NULL
             ) X
    </select>

    <select id="selectDrawingQualityHistoryList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            ROW_NUMBER () OVER(ORDER BY C.INSERT_DT DESC) AS RNUM,
            SF_GET_CONTROL_PART_INFO(B.CONTROL_SEQ, B.CONTROL_DETAIL_SEQ) AS CONTROL_NUM,
            B.IMG_GFILE_SEQ,
            SF_GET_DATE_F(C.INSERT_DT,'YY','') AS INSPECT_DT,
            C.INSPECT_GRADE,
            SF_GET_CODE_NM('1040', C.INSPECT_GRADE, #{LOGIN_LOCALE}) AS INSPECT_GRADE_NM,
            C.ERROR_PROCESS,
            C.ERROR_ACTION,
            C.ERROR_REASON,
            IFNULL((SELECT NOTE FROM TBL_CODE WHERE HIGH_CD = '1040' AND CODE_CD = C.INSPECT_GRADE),SPACE(0)) AS INSPECT_GRADE_NOTE,
            CASE WHEN C.INSPECT_TYPE = '1' THEN
                     CASE WHEN jmes.SF_GET_CODE_NM('1019', C.INSPECT_RESULT, #{LOGIN_LOCALE}) IS NULL THEN jmes.SF_GET_CODE_NM('1020', C.INSPECT_RESULT, #{LOGIN_LOCALE})
                          ELSE jmes.SF_GET_CODE_NM('1019', C.INSPECT_RESULT, #{LOGIN_LOCALE})
                     END
                 WHEN C.INSPECT_TYPE = '2' THEN jmes.SF_GET_CODE_NM('1021', C.INSPECT_RESULT, #{LOGIN_LOCALE})
            END AS INSPECT_RESULT_NM,
            IFNULL(SF_GET_CODE_NM('1010', C.ERROR_PROCESS, #{LOGIN_LOCALE}),SPACE(0)) AS ERROR_PROCESS_NM,
            IFNULL(SF_GET_CODE_NM('1032', C.ERROR_REASON, #{LOGIN_LOCALE}),SPACE(0)) AS ERROR_REASON_NM,
            IFNULL(SF_GET_CODE_NM('1025', C.ERROR_ACTION, #{LOGIN_LOCALE}),SPACE(0)) AS ERROR_ACTION_NM,
            IFNULL(C.ERROR_NOTE,SPACE(0)) AS ERROR_NOTE
        FROM TBL_CONTROL A
            INNER JOIN TBL_CONTROL_PART B ON A.CONTROL_SEQ = B.CONTROL_SEQ
            INNER JOIN TBL_INSPECT C ON B.CONTROL_SEQ = C.CONTROL_SEQ AND B.CONTROL_DETAIL_SEQ = C.CONTROL_DETAIL_SEQ
                AND C.INSPECT_SEQ = (
                    SELECT MAX(Q.INSPECT_SEQ)
                    FROM TBL_INSPECT Q
                    WHERE Q.CONTROL_SEQ = C.CONTROL_SEQ
                      AND Q.CONTROL_DETAIL_SEQ = C.CONTROL_DETAIL_SEQ
                      AND Q.INSPECT_NUM = 1
                )
        WHERE A.DEL_YN = 'N'
          AND (A.ORDER_COMP_CD , B.MATERIAL_TYPE, B.SIZE_TXT) IN (
            SELECT X.ORDER_COMP_CD, Y.MATERIAL_TYPE, Y.SIZE_TXT
            FROM TBL_CONTROL X
                INNER JOIN TBL_CONTROL_PART Y ON X.CONTROL_SEQ = Y.CONTROL_SEQ
            WHERE X.DEL_YN = 'N'
                AND X.CONTROL_SEQ = #{CONTROL_SEQ}
                AND Y.CONTROL_DETAIL_SEQ = #{CONTROL_DETAIL_SEQ}
        )
        ORDER BY C.INSERT_DT DESC
    </select>

    <select id="selectDrawingErrorList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
               A.MCT_INSPECT_SEQ,
               SF_GET_DATE_F(A.INSERT_DT,'','') AS INSERT_DT,
               SF_GET_USER_NM(A.INSERT_ID) AS INSERT_ID,
               A.ERROR_QTY,
               A.ERROR_REASON,
               A.INSPECT_RESULT,
               CASE WHEN jmes.SF_GET_CODE_NM('1019', A.INSPECT_RESULT, #{LOGIN_LOCALE}) IS NULL THEN jmes.SF_GET_CODE_NM('1020', A.INSPECT_RESULT, #{LOGIN_LOCALE})
                    ELSE jmes.SF_GET_CODE_NM('1019', A.INSPECT_RESULT, #{LOGIN_LOCALE})
               END AS INSPECT_RESULT_NM,
               SUBSTRING(IFNULL(SF_GET_CODE_NM('1032', A.ERROR_REASON, #{LOGIN_LOCALE}),SPACE(0)),1,2) AS ERROR_REASON_NM
        FROM TBL_MCT_WORK_INSPECT A
        WHERE A.DEL_YN = 'N'
          AND A.MCT_WORK_SEQ = #{MCT_WORK_SEQ};
    </select>

    <update id="updateMctWorkQty" parameterType="java.util.HashMap" >
        UPDATE TBL_MCT_WORK
        SET
            UPDATE_DT = NOW(),
            GOAL_QTY = #{GOAL_QTY},
            <if test="UNIT_QTY != null and UNIT_QTY != ''">
                UNIT_QTY = #{UNIT_QTY},
            </if>
            <if test="ADJUST_QTY != null and ADJUST_QTY != ''">
                ADJUST_QTY = #{ADJUST_QTY},
            </if>
            UPDATE_ID = #{LOGIN_USER_ID}
        WHERE DEL_YN = 'N'
            AND MCT_WORK_SEQ = #{MCT_WORK_SEQ}
    </update>

    <insert id="insertErrorQty" parameterType="java.util.HashMap">
        INSERT INTO jmes.TBL_MCT_WORK_INSPECT (
            MCT_INSPECT_SEQ, MCT_WORK_SEQ, ERROR_QTY,
            INSPECT_RESULT, ERROR_REASON, INSERT_ID
        )VALUES (
            NEXTVAL(SEQ_MCT_WORK_INSPECT), #{MCT_WORK_SEQ}, #{ERROR_QTY},
            #{INSPECT_RESULT}, #{ERROR_REASON}, #{userInfo.USER_ID}
        )
    </insert>

    <update id="deleteErrorQty" parameterType="java.util.HashMap">
        UPDATE jmes.TBL_MCT_WORK_INSPECT
        SET DEL_YN = 'Y',
            UPDATE_ID = #{LOGIN_USER_ID},
            UPDATE_DT = NOW()
        WHERE MCT_INSPECT_SEQ = #{MCT_INSPECT_SEQ}
    </update>

    <update id="deleteAllErrorQty" parameterType="java.util.HashMap">
        UPDATE jmes.TBL_MCT_WORK_INSPECT
        SET DEL_YN = 'Y',
            UPDATE_ID = #{LOGIN_USER_ID},
            UPDATE_DT = NOW()
        WHERE MCT_WORK_SEQ = #{MCT_WORK_SEQ}
    </update>
</mapper>