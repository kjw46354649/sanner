<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="excel">

    <select id="selectEstimateMasterInfoExcel" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.EST_TITLE, A.EST_NUM,
            IFNULL(B.COMP_NUM, SPACE(0)) ORDER_COMP_NUM,
            IFNULL(B.COMP_NM, SPACE(0)) ORDER_COMP_NM,
            IFNULL(B.CEO_NM, SPACE(0)) ORDER_CEO_NM,
            IFNULL(B.COMP_ADDRESS, SPACE(0)) ORDER_COMP_ADDRESS,
            IFNULL(B.COMP_TYPE, SPACE(0)) ORDER_COMP_TYPE,
            IFNULL(C.COMP_NM, SPACE(0)) COMP_NM,
            IFNULL(C.CEO_NM, SPACE(0)) CEO_NM,
            SUM(D.FINAL_EST_UNIT_PRICE) AS FINAL_EST_UNIT_PRICE
        FROM TBL_ESTIMATE A
            INNER JOIN TBL_COMPANY B ON A.COMP_CD = B.COMP_CD
            INNER JOIN TBL_COMPANY C ON A.ORDER_COMP_CD = C.COMP_CD
            INNER JOIN TBL_ESTIMATE_DETAIL D ON A.EST_SEQ = D.EST_SEQ
         WHERE 1=1
			AND A.EST_SEQ = #{EST_SEQ}
    </select>

    <select id="selectEstimateDetailListExcel" parameterType="java.util.HashMap" resultType="java.util.HashMap">
       SELECT
			EST_SEQ, SEQ, PROJECT_NM, MODULE_NM, ITEM_NM, DRAWING_NUM, PART_NUM, MATERIAL_SUPPLY_YN,
            ITEM_QTY, SIZE_TXT, SIZE_TYPE,
            SIZE_W, SIZE_H, SIZE_T, SIZE_D, SIZE_L,
            SIZE_W_M, SIZE_H_M, SIZE_T_M, SIZE_D_M, SIZE_L_M,
            WORK_TYPE, SF_GET_CODE_NM(1033, WORK_TYPE, 'EN') AS WORK_TYPE_NM,
            MATERIAL_TYPE, SF_GET_CODE_NM(1035, WORK_TYPE, 'EN') AS MATERIAL_TYPE_NM,
            MATERIAL_DETAIL, SF_GET_CODE_NM(1027, WORK_TYPE, 'EN') AS MATERIAL_DETAIL_NM,
            MATERIAL_KIND, SF_GET_CODE_NM(1029, WORK_TYPE, 'EN') AS MATERIAL_KIND_NM,
            SURFACE_TREAT, SF_GET_CODE_NM(1039, WORK_TYPE, 'EN') AS SURFACE_TREAT_NM,
            MATERIAL_NOTE,
            DETAIL_LATHE, DETAIL_SURFACE, DETAIL_CLAMPING, DETAIL_POCKET, DETAIL_DRILL, DETAIL_DIFFICULTY,
            MATERIAL_FINISH_TM, MATERIAL_FINISH_GRIND, MATERIAL_FINISH_HEAT,
            UNIT_MATERIAL_AMT, UNIT_TM_AMT, UNIT_GRIND_AMT, UNIT_HEAT_AMT, UNIT_SURFACE_AMT, UNIT_PROCESS_AMT, UNIT_ETC_AMT,
            UNIT_AMT_NOTE, UNIT_FINAL_EST_AMT,
        FROM TBL_ESTIMATE_DETAIL
        WHERE 1=1
			AND EST_SEQ = #{EST_SEQ}
    </select>

    <select id="selectOutsourcingOrderInfoExcel" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            SF_GET_COMP_NM(#{#{COMP_CD}) AS COMP_NM,
            SF_GET_STAFF_NM(#{ORDER_STAFF_SEQ}) AS ORDER_STAFF_NM
    </select>

    <select id="selectOutsourcingOrderExcel" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            ROW_NUMBER () OVER (ORDER BY A.CONTROL_SEQ, B.PART_NUM) AS ROWNUM,
            A.ORDER_COMP_CD, -- 발주업체
            SF_GET_COMP_NM(A.ORDER_COMP_CD) AS ORDER_COMP_NM,-- 발주업체
            B.OUTSIDE_ORDER_NUM, -- 발주번호
            A.CONTROL_NUM, -- 관리번호
            B.OUTSIDE_HOPE_DUE_DT, -- 요망납기
            B.DRAWING_NUM, -- 도면번호
            B.ITEM_NM, -- 품명
            B.SIZE_TXT, -- 규격
            B.MATERIAL_DETAIL, -- 소재
            B.OUTSIDE_ORDER_NUM, -- 발주량
            B.OUTSIDE_UNIT_AMT -- 단가
        -- 	SUM(B.OUTSIDE_ORDER_NUM * B.OUTSIDE_UNIT_AMT)
        FROM TBL_CONTROL A
            INNER JOIN TBL_CONTROL_PART B ON A.CONTROL_SEQ = B.CONTROL_SEQ
            INNER JOIN TBL_CONTROL_PART_ORDER C ON B.CONTROL_SEQ = C.CONTROL_SEQ
                                                   AND B.CONTROL_DETAIL_SEQ = C.CONTROL_DETAIL_SEQ
            LEFT OUTER JOIN TBL_OUTSIDE_REQUEST_DETAIL D ON B.CONTROL_SEQ = D.CONTROL_SEQ
                                                       AND B.CONTROL_DETAIL_SEQ = D.CONTROL_DETAIL_SEQ
            LEFT OUTER JOIN TBL_OUTSIDE_REQUEST E ON D.OUTSIDE_REQUEST_SEQ = E.OUTSIDE_REQUEST_SEQ
            LEFT OUTER JOIN TBL_OUTSIDE_CLOSE F ON B.CONTROL_SEQ = F.CONTROL_SEQ
                                             AND B.CONTROL_DETAIL_SEQ = F.CONTROL_DETAIL_SEQ
            LEFT OUTER JOIN TBL_OUTSIDE_CLOSE_HISTORY G ON F.CONTROL_SEQ = G.CONTROL_SEQ
                                                           AND F.CONTROL_DETAIL_SEQ = G.CONTROL_DETAIL_SEQ
                                                           AND F.CLOSE_MONTH = G.CLOSE_MONTH
                                                           AND F.CLOSE_VER = G.CLOSE_VER
        WHERE
            (A.CONTROL_STATUS IS NULL OR A.CONTROL_STATUS IN ('ORD001', 'ORD002'))
            AND B.WORK_TYPE != 'WTP010'
            AND B.OUTSIDE_ORDER_NUM = #{OUTSIDE_ORDER_NUM}
        ORDER BY
            A.CONTROL_SEQ,
            B.PART_NUM
    </select>

</mapper>