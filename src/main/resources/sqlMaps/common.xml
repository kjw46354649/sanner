<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="common">

    <insert id="insertFileGroup" parameterType="java.util.HashMap">
        <selectKey keyProperty="GFILE_SEQ" resultType="int" order="BEFORE">
            SELECT NEXTVAL(SEQ_GFILE) FROM DUAL
        </selectKey>
        INSERT INTO jmes.TBL_FILE_GROUP (GFILE_SEQ,
            <if test="GFILE_TYPE != null and GFILE_TYPE != ''">
                GFILE_TYPE,
            </if>
            INSERT_ID)
        VALUES(#{GFILE_SEQ},
            <if test="GFILE_TYPE != null and GFILE_TYPE != ''">
                #{GFILE_TYPE},
            </if>
            'admin')
    </insert>

    <delete id="deleteFileGroup" parameterType="java.util.HashMap">
        DELETE FROM jmes.TBL_FILE_GROUP
        WHERE GFILE_SEQ = #{GFILE_SEQ}
    </delete>

    <update id="updateFileGroup" parameterType="java.util.HashMap">
        UPDATE jmes.TBL_FILE_GROUP
        SET
            <if test="GFILE_TYPE != null and GFILE_TYPE != ''">
                GFILE_TYPE = #{GFILE_TYPE},
            </if>
            UPDATE_DT = NOW(),
            UPDATE_ID = 'admin'
        WHERE GFILE_SEQ = #{GFILE_SEQ}
    </update>

    <insert id="insertFile" parameterType="java.util.HashMap">
        INSERT INTO jmes.TBL_FILE
        (FILE_SEQ, FILE_NM, FILE_PATH, TIME_PATH, ORGINAL_FILE_NM, FILE_TYPE, FILE_EXT, FILE_SIZE,
            GFILE_SEQ, INSERT_ID)
        VALUES
        (NEXTVAL(SEQ_FILE), #{FILE_NM}, #{FILE_PATH}, #{TIME_PATH}, #{ORGINAL_FILE_NM}, #{FILE_TYPE}, #{FILE_EXT}, #{FILE_SIZE},
            #{GFILE_SEQ}, 'admin')
    </insert>

    <update id="updateFile" parameterType="java.util.HashMap">
        UPDATE jmes.TBL_FILE
        SET
            FILE_NM = #{FILE_NM},
            FILE_PATH = #{FILE_PATH},
            TIME_PATH = #{TIME_PATH},
            ORGINAL_FILE_NM = #{ORGINAL_FILE_NM},
            FILE_TYPE = #{FILE_TYPE},
            FILE_EXT = #{FILE_EXT},
            FILE_SIZE = #{FILE_SIZE},
            UPDATE_DT = NOW(),
            UPDATE_ID = 'admin'
        WHERE FILE_SEQ = #{FILE_SEQ}
    </update>

    <delete id="deleteGFileKey" parameterType="java.util.HashMap">
        DELETE FROM jmes.TBL_FILE
        WHERE GFILE_SEQ = #{GFILE_SEQ}
    </delete>

    <delete id="deleteFileKey" parameterType="java.util.HashMap">
        DELETE FROM jmes.TBL_FILE
        WHERE FILE_SEQ = #{FILE_SEQ}
    </delete>

    <select id="selectGfileFileImageInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.GFILE_SEQ, B.FILE_SEQ, B.ORGINAL_FILE_NM, B.FILE_PATH, TIME_PATH
        FROM jmes.TBL_FILE_GROUP A
            INNER JOIN jmes.TBL_FILE B ON A.GFILE_SEQ = B.GFILE_SEQ
        WHERE A.GFILE_SEQ  = #{GFILE_SEQ}
    </select>

    <select id="selectGfileFileSingleInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.GFILE_SEQ, B.FILE_SEQ, B.ORGINAL_FILE_NM, B.FILE_PATH, TIME_PATH
        FROM jmes.TBL_FILE_GROUP A
            INNER JOIN jmes.TBL_FILE B ON A.GFILE_SEQ = B.GFILE_SEQ
        WHERE A.GFILE_SEQ  = #{GFILE_SEQ}
    </select>

    <select id="selectGfileFileList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.GFILE_SEQ AS DXF_GFILE_SEQ, B.FILE_SEQ, B.TIME_PATH, B.FILE_PATH, REPLACE(B.ORGINAL_FILE_NM, CONCAT('.',B.FILE_EXT), SPACE(0)) AS ORGINAL_FILE_NM,
            REPLACE(B.FILE_NM, CONCAT('.',B.FILE_EXT), SPACE(0)) AS FILE_NM
        FROM jmes.TBL_FILE_GROUP A
            INNER JOIN jmes.TBL_FILE B ON A.GFILE_SEQ = B.GFILE_SEQ
        WHERE A.GFILE_SEQ  IN
            <foreach collection="dxfGfileSeqList" item="bean" index="index"  open="(" close=")" separator=",">
                #{bean}
            </foreach>
    </select>

    <select id="selectFileSingleInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.GFILE_SEQ, B.FILE_SEQ, B.ORGINAL_FILE_NM, B.FILE_PATH, TIME_PATH
        FROM jmes.TBL_FILE_GROUP A
            INNER JOIN jmes.TBL_FILE B ON A.GFILE_SEQ = B.GFILE_SEQ AND B.FILE_SEQ = #{FILE_SEQ}
        WHERE 1 = 1
    </select>

    <select id="selectGfileFileListInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
            A.GFILE_SEQ, B.FILE_SEQ, B.ORGINAL_FILE_NM, B.FILE_PATH, TIME_PATH
        FROM jmes.TBL_FILE_GROUP A
                 INNER JOIN jmes.TBL_FILE B ON A.GFILE_SEQ = B.GFILE_SEQ
        WHERE A.GFILE_SEQ  = #{GFILE_SEQ}
    </select>

    <select id="selectControlBarcodeInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
             BARCODE_NUM
            ,CONTROL_SEQ
            ,CONTROL_DETAIL_SEQ
            ,CONTROL_VER
            ,DRAWING_VER
            ,DEL_YN
            ,INSERT_DT
            ,INSERT_ID
            ,UPDATE_DT
            ,UPDATE_ID
        FROM jmes.TBL_CONTROL_BARCODE
        WHERE BARCODE_NUM = #{BARCODE_NUM}
    </select>
    <select id="selectOutBarcodeInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
             BARCODE_NUM
            ,CONTROL_SEQ
            ,CONTROL_DETAIL_SEQ
            ,ORDER_SEQ
            ,PACKING_NUM
            ,DEL_YN
            ,INSERT_DT
            ,INSERT_ID
            ,UPDATE_DT
            ,UPDATE_ID
        FROM jmes.TBL_OUT_BARCODE
         WHERE BARCODE_NUM = #{BARCODE_NUM}
    </select>

    <select id="selectBarcodePrintInfoControl" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        -- 도면라벨
        SELECT CASE WHEN C.PART_NUM IS NULL THEN B.CONTROL_NUM ELSE CONCAT(B.CONTROL_NUM, ' #', C.PART_NUM) END AS CONTROL_NUM_INFO
        , B.CONTROL_VER
        , C.DRAWING_NUM
        , C.DRAWING_VER
        , CONCAT(jmes.SF_GET_CONTROL_ORDER_QTY(A.CONTROL_SEQ,0),'EA') AS ORDER_QTY
        , C.ORIGINAL_SIDE_QTY
        , C.OTHER_SIDE_QTY
        , jmes.SF_GET_DATE_F(C.INNER_DUE_DT,'YYYY','') AS INNER_DUE_DT
        , C.SIZE_TXT
        , jmes.SF_GET_CODE_NM('1039', C.MATERIAL_TYPE, 'KR') AS MATERIAL_TYPE_NM
        , jmes.SF_GET_CODE_NM('1033', C.WORK_TYPE, 'KR') AS WORK_TYPE_NM
        , jmes.SF_GET_CODE_NM('1039', C.SURFACE_TREAT, 'KR') AS SURFACE_TREAT_NM
        , (SELECT M.COMP_NM FROM jmes.TBL_COMPANY M WHERE M.COMP_CD = B.ORDER_COMP_CD) AS ORDER_COMP_NM
        , CASE WHEN B.EMERGENCY_YN = 'Y' THEN '긴급' END AS EMERGENCY_NM
        , jmes.SF_GET_CODE_NM('1058', C.MATERIAL_FINISH_HEAT, 'KR') AS AS MATERIAL_FINISH_HEAT_NM
        , jmes.SF_GET_CODE_NM('1059', B.MAIN_INSPECTION, 'KR') AS  MAIN_INSPECTION_NM
        , (SELECT M.COMP_NM FROM jmes.TBL_COMPANY M WHERE M.COMP_CD = B.COMP_CD) AS COMP_NM
        , A.BARCODE_NUM
        FROM jmes.TBL_CONTROL_BARCODE A
        , jmes.TBL_CONTROL B
        , jmes.TBL_CONTROL_PART C
        WHERE A.CONTROL_SEQ = B.CONTROL_SEQ
        AND A.CONTROL_SEQ = C.CONTROL_SEQ
        AND A.CONTROL_DETAIL_SEQ = C.CONTROL_DETAIL_SEQ
        AND A.DEL_YN = 'N'
        AND A.BARCODE_NUM = #{BARCODE_NUM}
    </select>
    <select id="selectBarcodePrintInfoOut" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        -- 출고라벨
        SELECT A.BARCODE_NUM
        , A.PACKING_NUM
        , D.PACKING_CNT
        , (SELECT M.COMP_NM FROM jmes.TBL_COMPANY M WHERE M.COMP_CD = B.COMP_CD) AS COMP_NM
        , C.ITEM_NM
        , (SELECT M.COMP_NM FROM jmes.TBL_COMPANY M WHERE M.COMP_CD = B.ORDER_COMP_CD) AS ORDER_COMP_NM
        , C.DRAWING_NUM
        , D.ORDER_NUM
        , B.MODULE_NM
        , jmes.SF_GET_DATE_F(D.ORDER_DUE_DT,'YYYY','') AS ORDER_DUE_DT
        , B.CONTROL_NUM
        , B.DELIVERY_COMP_NM
        , B.PROJECT_NM
        , CONCAT(C.SIZE_TXT, ' / ', D.ORDER_QTY,'EA') AS SIZE_QTY_INFO
        , B.LABEL_NOTE
        FROM jmes.TBL_OUT_BARCODE A
        , jmes.TBL_CONTROL B
        , jmes.TBL_CONTROL_PART C
        , jmes.TBL_CONTROL_PART_ORDER D
        WHERE A.CONTROL_SEQ = B.CONTROL_SEQ
        AND A.CONTROL_SEQ = C.CONTROL_SEQ
        AND A.CONTROL_DETAIL_SEQ = C.CONTROL_DETAIL_SEQ
        AND A.CONTROL_SEQ = D.CONTROL_SEQ
        AND A.CONTROL_DETAIL_SEQ = D.CONTROL_DETAIL_SEQ
        AND A.ORDER_SEQ = D.ORDER_SEQ
        AND A.DEL_YN = 'N'
        AND A.BARCODE_NUM = #{BARCODE_NUM}
    </select>

</mapper>